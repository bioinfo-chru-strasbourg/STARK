#########
# STARK #
#########
# Usage: docker-compose up

version: '3'

# SERVICES
##########

services:


    # STARK IMAGES
    ##############


    # STARK SOURCES
    stark-sources:
        image: ${DOCKER_STARK_SOURCES_IMAGE}
        build:
            context: ${DOCKER_STARK_CONTEXT}
            dockerfile: Dockerfile
            args:
                - THREADS=${DOCKER_STARK_BUILD_THREADS}
                - REPO_SOURCES=${DOCKER_STARK_BUILD_SOURCES_URL}
                - REMOVE_SOURCES=0
        container_name: STARK-sources
        command: --help
        env_file:
            - .env
        networks:
            - stark


    # STARK IMAGE
    stark:
        image: ${DOCKER_STARK_IMAGE}
        build:
            context: ${DOCKER_STARK_CONTEXT}
            dockerfile: Dockerfile
            args:
                - THREADS=${DOCKER_STARK_BUILD_THREADS}
                - REPO_SOURCES=${DOCKER_STARK_BUILD_SOURCES_URL}
                - REMOVE_SOURCES=1
        container_name: STARK
        command: --help
        env_file:
            - .env
        depends_on:
            - stark-sources
        networks:
            - stark


    # STARK CREATE FOLDERS
    stark-folders:
        image: ${DOCKER_STARK_IMAGE}
        container_name: STARK-folders
        entrypoint: /bin/bash
        command: -c "/tool/bin/STARK.setup --docker-env-file=/tool/.env --setup-type=INNER --setup-main-folder-pattern=/STARK_folder_setup --verbose"
        volumes:
            - main:/STARK_folder_setup/STARK:rw
        env_file:
            - .env
        depends_on:
            - stark
        networks:
            - stark


    # STARK DATABASES POPULATION
    stark-databases:
        image: ${DOCKER_STARK_IMAGE}
        container_name: STARK-databases
        entrypoint: /bin/bash
        command: -c "/tool/bin/get_databases.sh --build --threads=${DOCKER_STARK_GET_DATABASES_THREADS} --additional_annotations=${DOCKER_STARK_GET_DATABASES_ADDITIONAL_ANNOTATIONS} --verbose 1>/STARK/databases/build.log 2>/STARK/databases/build.err"
        volumes:
            - databases:${DOCKER_STARK_INNER_FOLDER_DATABASES}:ro
        env_file:
            - .env
        depends_on:
            - stark
            - stark-folders
        networks:
            - stark


    # SERVICES
    ##########


    # STARK IMAGE
    stark-container:
        image: ${DOCKER_STARK_IMAGE}
        build:
            context: ${DOCKER_STARK_CONTEXT}
            dockerfile: Dockerfile
            args:
                - THREADS=${DOCKER_STARK_BUILD_THREADS}
                - REPO_SOURCES=${DOCKER_STARK_BUILD_SOURCES_URL}
                - REMOVE_SOURCES=1
        container_name: STARK-container
        entrypoint: /bin/bash
        command: -c "while true; do sleep 60; done"
        volumes:
            - data:${DOCKER_STARK_INNER_FOLDER_DATA}:rw
            - databases:${DOCKER_STARK_INNER_FOLDER_DATABASES}:ro
        restart: always
        env_file:
            - .env
        depends_on:
            - stark
            - stark-folders
            - stark-databases
        networks:
            - stark
        deploy:
            replicas: 1


    # STARK SERVICE DATA
    stark-service-data:
        image: ${DOCKER_STARK_SERVICE_DATA_IMAGE}
        build:
            context: ${DOCKER_STARK_SERVICE_DATA_CONTEXT}
            dockerfile: Dockerfile
        container_name: ${DOCKER_STARK_SERVICE_DATA_CONTAINER_NAME}
        restart: always
        env_file:
            - .env
        ports:
            - ${DOCKER_STARK_SERVICE_PORT_PATTERN}${DOCKER_STARK_SERVICE_DATA_PORT}:${DOCKER_STARK_SERVICE_DATA_PORT_INNER}
        volumes:
            # Data folders available (need to be coherent with other services)
            - input:${DOCKER_STARK_SERVICE_DATA_INNER_FOLDER_DATA}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_INPUTS}/Input:ro
            - repository:${DOCKER_STARK_SERVICE_DATA_INNER_FOLDER_DATA}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_REPOSITORIES}/Repository:ro
            - archive:${DOCKER_STARK_SERVICE_DATA_INNER_FOLDER_DATA}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_REPOSITORIES}/Archive:ro
            - sources:${DOCKER_STARK_SERVICE_DATA_INNER_FOLDER_DATA}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_SOURCES}:ro
            - analyses-STARK-service-launcher:${DOCKER_STARK_SERVICE_DATA_INNER_FOLDER_DATA}/${DOCKER_STARK_SERVICE_FOLDER_LAUNCHER}:ro
            - analyses-STARK-service-listener:${DOCKER_STARK_SERVICE_DATA_INNER_FOLDER_DATA}/${DOCKER_STARK_SERVICE_FOLDER_LISTENER}:ro
            - analyses-STARK-service-igv:${DOCKER_STARK_SERVICE_DATA_INNER_FOLDER_DATA}/${DOCKER_STARK_SERVICE_FOLDER_IGV}:ro
        restart: always
        networks:
            - stark
        deploy:
            replicas: 1


    # STARK SERVICE DASHBOARD
    stark-service-dashboard:
        image: ${DOCKER_STARK_SERVICE_DASHBOARD_IMAGE}
        build:
            context: ${DOCKER_STARK_SERVICE_DASHBOARD_CONTEXT}
            dockerfile: Dockerfile
        container_name: ${DOCKER_STARK_SERVICE_DASHBOARD_CONTAINER_NAME}
        restart: always
        env_file:
            - .env
        ports:
            - ${DOCKER_STARK_SERVICE_PORT_PATTERN}${DOCKER_STARK_SERVICE_DASHBOARD_PORT}:${DOCKER_STARK_SERVICE_DASHBOARD_PORT_INNER}
        volumes:
            # Data folders available (need to be coherent with STARK-service-data)
            - input:${DOCKER_STARK_SERVICE_DASHBOARD_INNER_FOLDER}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_INPUTS}/Input:ro
            - repository:${DOCKER_STARK_SERVICE_DASHBOARD_INNER_FOLDER}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_REPOSITORIES}/Repository:ro
            - archive:${DOCKER_STARK_SERVICE_DASHBOARD_INNER_FOLDER}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_REPOSITORIES}/Archive:ro
            # Service
            - analyses-STARK-service-launcher:${DOCKER_STARK_SERVICE_DASHBOARD_INNER_FOLDER}/${DOCKER_STARK_SERVICE_FOLDER_LAUNCHER}:ro
            - analyses-STARK-service-listener:${DOCKER_STARK_SERVICE_DASHBOARD_INNER_FOLDER}/${DOCKER_STARK_SERVICE_FOLDER_LISTENER}:ro
            - analyses-STARK-service-igv:${DOCKER_STARK_SERVICE_DASHBOARD_INNER_FOLDER}/${DOCKER_STARK_SERVICE_FOLDER_IGV}:rw
        restart: always
        links:
            - stark-service-data
            - stark-service-igv
            - stark-service-launcher
            - stark-service-cloud
        depends_on:
            - stark-service-data
            - stark-service-igv
            - stark-service-launcher
            - stark-service-cloud
        networks:
            - stark
        deploy:
            replicas: 2


    # STARK SERVICE CLOUD
    stark-service-cloud:
        image: ${DOCKER_STARK_SERVICE_CLOUD_IMAGE}
        container_name: ${DOCKER_STARK_SERVICE_CLOUD_CONTAINER_NAME}
        command: -r ${DOCKER_STARK_SERVICE_CLOUD_INNER_FOLDER_DATA}
        restart: always
        env_file:
            - .env
        ports:
            - ${DOCKER_STARK_SERVICE_PORT_PATTERN}${DOCKER_STARK_SERVICE_CLOUD_PORT}:${DOCKER_STARK_SERVICE_CLOUD_PORT_INNER}
        volumes:
            # Volumes for configuration
            - analyses-STARK-service-cloud:${DOCKER_STARK_SERVICE_CLOUD_INNER_FOLDER}:rw
            # Data available on the cloud (no link with service data)
            - input:${DOCKER_STARK_SERVICE_CLOUD_INNER_FOLDER_DATA}/Input:ro
            - repository:${DOCKER_STARK_SERVICE_CLOUD_INNER_FOLDER_DATA}/Repository:ro
            - archive:${DOCKER_STARK_SERVICE_CLOUD_INNER_FOLDER_DATA}/Archive:ro
        restart: always
        networks:
            - stark
        deploy:
            replicas: 2


    # STARK SERVICE IGV
    stark-service-igv:
        image: ${DOCKER_STARK_SERVICE_IGV_IMAGE}
        build:
            context: ${DOCKER_STARK_SERVICE_IGV_CONTEXT}
            dockerfile: Dockerfile
        container_name: ${DOCKER_STARK_SERVICE_IGV_CONTAINER_NAME}
        restart: always
        env_file:
            - .env
        ports:
            - ${DOCKER_STARK_SERVICE_PORT_PATTERN}${DOCKER_STARK_SERVICE_IGV_PORT}:${DOCKER_STARK_SERVICE_IGV_PORT_INNER}
        restart: always
        links:
            - stark-service-data
        networks:
            - stark
        deploy:
            replicas: 2


    # STARK SERVICE JARVIS
    stark-service-jarvis:
        image: ${DOCKER_STARK_SERVICE_JARVIS_IMAGE}
        build:
            context: ${DOCKER_STARK_SERVICE_JARVIS_CONTEXT}
            dockerfile: Dockerfile
        container_name: ${DOCKER_STARK_SERVICE_JARVIS_CONTAINER_NAME}
        restart: always
        env_file:
            - .env
        ports:
            - ${DOCKER_STARK_SERVICE_PORT_PATTERN}${DOCKER_STARK_SERVICE_JARVIS_PORT}:${DOCKER_STARK_SERVICE_JARVIS_PORT_INNER}
        volumes:
            # Volumes for configuration
            - ${DOCKER_STARK_MAIN_FOLDER}/${DOCKER_STARK_FOLDER_CONFIG_HOWARD}:${DOCKER_STARK_SERVICE_JARVIS_INNER_FOLDER_CONFIGURATION}:ro
        restart: always
        links:
            - stark-service-data
        networks:
            - stark
        deploy:
            replicas: 2


    # STARK SERVICE LAUNCHER
    stark-service-launcher:
        image: ${DOCKER_STARK_SERVICE_LAUNCHER_IMAGE}
        build:
            context: ${DOCKER_STARK_SERVICE_LAUNCHER_CONTEXT}
            dockerfile: Dockerfile
        container_name: ${DOCKER_STARK_SERVICE_LAUNCHER_CONTAINER_NAME}
        env_file:
            - .env
        environment:
            - TS=ts
            - TS_SAVELIST=${TASK_SPOOLER_TS_SAVELIST}
        ports:
            - ${DOCKER_STARK_SERVICE_PORT_PATTERN}${DOCKER_STARK_SERVICE_LAUNCHER_PORT}:${DOCKER_STARK_SERVICE_LAUNCHER_PORT_INNER}
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - input:${DOCKER_STARK_INNER_FOLDER_INPUT}:ro
            - analyses-STARK-service-launcher:${TASK_SPOOLER_TS_SAVELIST}:rw
            - analyses-STARK-service-launcher:${DOCKER_STARK_INNER_FOLDER_ANALYSES}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_SERVICES_LAUNCHER}:rw
        restart: always
        links:
            - stark
            - stark-databases
        depends_on:
            - stark
            - stark-databases
        networks:
            - stark
        deploy:
            replicas: 1


    # STARK SERVICE LISTENER
    stark-service-listener:
        image: ${DOCKER_STARK_IMAGE}
        entrypoint: /tool/bin/STARK.listener
        command: --no_header --command="LAUNCHER" --launcher="http://stark-service-launcher:${DOCKER_STARK_SERVICE_LAUNCHER_PORT_INNER}/analysis" --days=${DOCKER_STARK_SERVICE_LISTENER_DAYS} --condition="${DOCKER_STARK_SERVICE_LISTENER_CONDITION}" --exec --daemon --daemon-periodicity=${DOCKER_STARK_SERVICE_LISTENER_DAEMON_PERIODICITY} --log=${DOCKER_STARK_INNER_FOLDER_ANALYSES}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_SERVICES_LISTENER}
        container_name: ${DOCKER_STARK_SERVICE_LISTENER_CONTAINER_NAME}
        env_file:
            - .env
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - databases:${DOCKER_STARK_INNER_FOLDER_DATABASES}:ro
            - input:${DOCKER_STARK_INNER_FOLDER_INPUT}:ro
            - repository:${DOCKER_STARK_INNER_FOLDER_OUTPUT_REPOSITORY}:rw
            - archive:${DOCKER_STARK_INNER_FOLDER_OUTPUT_ARCHIVE}:rw
            - analyses-STARK-service-listener:${DOCKER_STARK_INNER_FOLDER_ANALYSES}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_SERVICES_LISTENER}:rw
            - analyses-STARK-service-launcher:${DOCKER_STARK_INNER_FOLDER_ANALYSES}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_SERVICES_LAUNCHER}:rw
        restart: always
        links:
            - stark-service-listener-clear
            - stark-service-launcher
            - stark
            - stark-databases
        depends_on:
            - stark-service-listener-clear
            - stark-service-launcher
            - stark
            - stark-databases
        networks:
            - stark
        deploy:
            replicas: 1


    # STARK SERVICE LISTENER CLEAR
    stark-service-listener-clear:
        image: ${DOCKER_STARK_IMAGE}
        entrypoint: /tool/bin/STARK.listener.clear
        command: --clear --listener="${DOCKER_STARK_INNER_FOLDER_ANALYSES}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_SERVICES_LISTENER}" --launcher="${DOCKER_STARK_INNER_FOLDER_ANALYSES}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_SERVICES_LAUNCHER}"
        container_name: ${DOCKER_STARK_SERVICE_LISTENER_CONTAINER_NAME}-clear
        env_file:
            - .env
        volumes:
            - analyses-STARK-service-listener:${DOCKER_STARK_INNER_FOLDER_ANALYSES}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_SERVICES_LISTENER}:rw
            - analyses-STARK-service-launcher:${DOCKER_STARK_INNER_FOLDER_ANALYSES}/${DOCKER_STARK_SERVICE_DATA_SUBFOLDER_SERVICES_LAUNCHER}:ro
        links:
            - stark-service-launcher
            - stark
            - stark-databases
        depends_on:
            - stark-service-launcher
            - stark
            - stark-databases
        networks:
            - stark



# VOLUMES
#########

volumes:

    # MAIN STARK FOLDER
    main:
        driver: local
        driver_opts:
            type: none
            device: ${DOCKER_STARK_MAIN_FOLDER}
            o: bind

    # INPUT
    input:
        driver: local
        driver_opts:
            type: none
            device: ${DOCKER_STARK_MAIN_FOLDER}/${DOCKER_STARK_FOLDER_INPUT}
            o: bind

    # DEMULTIPLEXING (if configured in .env)
    # demultiplexing:
    #     driver: local
    #     driver_opts:
    #         type: none
    #         device: ${DOCKER_STARK_FOLDER_OUTPUT_DEMULTIPLEXING}
    #         o: bind

    # RESULTS (if configured in .env)
    # results:
    #     driver: local
    #     driver_opts:
    #         type: none
    #         device: ${DOCKER_STARK_FOLDER_OUTPUT_RESULTS}
    #         o: bind

    # REPOSITORY
    repository:
        driver: local
        driver_opts:
            type: none
            device: ${DOCKER_STARK_MAIN_FOLDER}/${DOCKER_STARK_FOLDER_OUTPUT_REPOSITORY}
            o: bind

    # ARCHIVE
    archive:
        driver: local
        driver_opts:
            type: none
            device: ${DOCKER_STARK_MAIN_FOLDER}/${DOCKER_STARK_FOLDER_OUTPUT_ARCHIVE}
            o: bind

    # SOURCES
    sources:
        driver: local
        driver_opts:
            type: none
            device: ${DOCKER_STARK_MAIN_FOLDER}/${DOCKER_STARK_FOLDER_SOURCES}
            o: bind

    # DATA
    data:
        driver: local
        driver_opts:
            type: none
            device: ${DOCKER_STARK_MAIN_FOLDER}/${DOCKER_STARK_FOLDER_DATA}
            o: bind

    # ANALYSES
    analyses:
        driver: local
        driver_opts:
            type: none
            device: ${DOCKER_STARK_MAIN_FOLDER}/${DOCKER_STARK_FOLDER_ANALYSES}
            o: bind

    # LOG
    log:
        driver: local
        driver_opts:
            type: none
            device: ${DOCKER_STARK_MAIN_FOLDER}/${DOCKER_STARK_FOLDER_OUTPUT_LOG}
            o: bind

    # DATABASES
    databases:
        driver: local
        driver_opts:
            type: none
            device: ${DOCKER_STARK_MAIN_FOLDER}/${DOCKER_STARK_FOLDER_DATABASES}
            o: bind

    # ANALYSES - Launcher
    analyses-STARK-service-launcher:
        driver: local
        driver_opts:
            type: none
            device: ${DOCKER_STARK_MAIN_FOLDER}/${DOCKER_STARK_SERVICE_FOLDER_LAUNCHER}
            o: bind

    # ANALYSES - Listener
    analyses-STARK-service-listener:
        driver: local
        driver_opts:
            type: none
            device: ${DOCKER_STARK_MAIN_FOLDER}/${DOCKER_STARK_SERVICE_FOLDER_LISTENER}
            o: bind

    # ANALYSES - IGV
    analyses-STARK-service-igv:
        driver: local
        driver_opts:
            type: none
            device: ${DOCKER_STARK_MAIN_FOLDER}/${DOCKER_STARK_SERVICE_FOLDER_IGV}
            o: bind

    # ANALYSES - CLOUD
    analyses-STARK-service-cloud:
        driver: local
        driver_opts:
            type: none
            device: ${DOCKER_STARK_MAIN_FOLDER}/${DOCKER_STARK_SERVICE_FOLDER_CLOUD}
            o: bind


# NETWORK
###########

networks:
    stark:
        driver: "bridge"
