#!/bin/bash
#################################
##
## NGS environment
##
#################################

SCRIPT_NAME="STARKReport"
SCRIPT_DESCRIPTION="STARK Report"
SCRIPT_RELEASE="0.9.1b"
SCRIPT_DATE="01/04/2021"
SCRIPT_AUTHOR="Antony Le Bechec"
SCRIPT_COPYRIGHT="HUS"
SCRIPT_LICENCE="GNU-AGPL"

# Realse note
RELEASE_NOTES=$RELEASE_NOTES"# 0.9b-19/06/2019: Script creation\n";
RELEASE_NOTES=$RELEASE_NOTES"# 0.9.1b-01/04/2021: Create links to downloaded files\n";

# Script folder
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Configuration
ENV_CONFIG=$(find -L $SCRIPT_DIR/.. -name config.app)
source $ENV_CONFIG 1>/dev/null 2>/dev/null


# Header
function header () {
	echo "#######################################";
	echo "# $SCRIPT_NAME [$SCRIPT_RELEASE-$SCRIPT_DATE]";
	echo "# $SCRIPT_DESCRIPTION ";
	echo "# $SCRIPT_AUTHOR @ $SCRIPT_COPYRIGHT Â© $SCRIPT_LICENCE";
	echo "#######################################";
}

# Release
function release () {
	echo "# RELEASE NOTES:";
	echo -e $RELEASE_NOTES
}

# Usage
function usage {
	echo "# USAGE: $(basename $0) -f analysis -p project -g group -u user -s sample -e env -d date [-h] [options...]";
	echo "#";
	echo "### This script generates a readable report with quality and metrics for a sample.";
	echo "#";
	echo "# -f|--analysis=<STRING>                         Analysis name (required).";
	echo "# -p|--project=<STRING>                          Project name (not required)";
	echo "# -g|--group=<STRING>                            Group name (not required)";
	echo "# -u|--user=<STRING>                             User name (not required)";
	echo "# -s|--sample=<STRING>                           Sample name (required)";
	echo "# -e|--application=<STRING>                      Application (required)";
	echo "# -r|--results=<FOLDER>                          Result folder (not required)";
	echo "# -i|--pipelines=<STRING>                        Pipelines if different from Pipelines option in the application (not required)";
	echo "# -k|--date=<STRING>                             Release/ID/Date of the current analysis (not required)";
	echo "# -o|--output=<STRING>                           Output file pattern (not required)";
	echo "# -t|--output_type=<STRING>                      Output type file, either html (default html)";
	echo "# -c|--sections=<STRING>                         List of sections (default ALL)";
	echo "#                                                Report Sections: results_summary sequencing_mapping depth coverage variant_calling variant_stats";
	echo "#                                                Report Annex Sections: annex_coverage annex_depth annex_genes_coverage annex_variants annex_annotations";
	echo "# -v|--verbose                                   Verbose mode";
	echo "# -d|--debug                                     Debug mode";
	echo "# -n|--release                                   Script Release";
	echo "# -h|--help                                      Help message";
	echo "#";

}


####################################################################################################################################
# Getting parameters from the input
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ":" tells that the option has a required argument, "::" tells that the option has an optional argument, no ":" tells no argument
ARGS=$(getopt -o "f:p:g:u:s:e:r:i:k:o:t:c:vdnh" --long "analysis:,project:,group:,user:,sample:,env:,app:,application:,results:,pipelines:,date:,output:,output_type:,sections:,verbose,debug,release,help" -- "$@" 2> /dev/null)
if [ $? -ne 0 ]; then
	:
	echo "#[ERROR] Error in the argument list:";
	echo "#[ERROR] $@"
	echo ""
	usage;
	exit;
fi;


PARAM=$@
DEBUG=0
VERBOSE=0

eval set -- "$ARGS"
while true
do
	#echo "$1=$2"
	#echo "Eval opts";
	case "$1" in
		-r|--results)
			RESULTS_FOLDER_INPUT="$2"
			shift 2
			;;
		-f|--analysis)
			ANALYSIS="$2"
			shift 2
			;;
		-p|--project)
			PROJECT_INPUT="$2"
			shift 2
			;;
		-g|--group)
			GROUP_INPUT="$2"
			shift 2
			;;
		-u|--user)
			USER_INPUT="$2"
			shift 2
			;;
		-s|--sample)
			SAMPLE="$2"
			shift 2
			;;
		-e|--env|--app|--application)
			APP="$2"
			shift 2
			;;
		-i|--pipelines)
			PIPELINES_INPUT="$2"
			PIPELINES_INPUT=$(echo $PIPELINES_INPUT | tr "," " ")
			shift 2
			;;
		-k|--date)
			DATE="$2"
			shift 2
			;;
		-o|--output)
			OUTPUT_INPUT="$2"
			shift 2
			;;
		-t|--output_type)
			OUTPUT_TYPE_INPUT="$2"
			shift 2
			;;
		-c|--sections)
			SECTIONS_INPUT="$2"
			SECTIONS_INPUT=$(echo $SECTIONS_INPUT | tr "," " ")
			shift 2
			;;
		-h|--help)
			usage
			exit 0
			;;
		-v|--verbose)
			VERBOSE=1
			shift 1
			;;
		-d|--debug)
			DEBUG=1
			shift 1
			;;
		--) shift
			break
			;;
		*) 	echo "Option $1 is not recognized. " "Use -h or --help to display the help." && \
			exit 1
			;;
	esac
done

# header
(($NO_HEADER)) || header;


# Example:
# STARK.report -f "RUN_TEST_TAG7" -s "P1408" -e "/STARK/tools/stark/current/config/apps/SOLIDTUMOR.app" -i "bwamem.gatkUG_SOLIDTUMOR.howard,bwamem.gatkHC_SOLIDTUMOR.howard,bwamem.VarScan_SOLIDTUMOR.howard" -k test -r /STARK/output/results

####################################################################################################################################
# Checking the input parameter
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
if [ -z "$ANALYSIS" ] && [ -z "$SAMPLE" ] && [ -z "$APP" ] && ((!$DEBUG)); then
	echo "#[ERROR] Required parameter: --analysis, --sample, and --application. Use --help to display the help." && echo "" && usage && exit 1;
fi
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


# FUNCTIONS
#############

# function in_array
# input: $element $array
in_array () 
{ 
    param=$1;
    shift;
    for elem in "$@";
    do
        [[ "$param" = "$elem" ]] && return 0;
    done;
    return 1
}


# #SECTIONS="results_summary sequencing_mapping depth coverage variant_calling variant_stats annex_coverage annex_depth annex_genes_coverage annex_variants annex_annotations" 
# SECTIONS="ALL" 

# SECTION_ID="results_summary"
# #SECTION_ID="truc"

# if in_array $SECTION_ID $SECTIONS || in_array ALL $SECTIONS ; then
# 	echo "in array";
# else
# 	echo "NOT in array"
# fi;
# exit 0



# APPLICATION
###############

# Default APP
[ -z "$APP" ] && APP="default";


#echo "APP=$APP"; exit;
(($VERBOSE)) && [ ! -z "$APP" ] && echo "#[INFO] Search Application '$APP'"

ENV=$(find_app "$APP" "$STARK_FOLDER_APPS")
source_app "$APP" "$STARK_FOLDER_APPS" 1
APP_NAME=$(name_app "$APP" "$STARK_FOLDER_APPS");
APP_DESCRIPTION=$(description_app "$APP" "$STARK_FOLDER_APPS");


(($VERBOSE)) && [ ! -z "$APP" ] && [ ! -z "$ENV" ] && echo "#[INFO] Application '$APP' found ('$ENV')"
(($VERBOSE)) && [ ! -z "$APP" ] && [ -z "$ENV" ] && echo "#[INFO] Application '$APP' NOT found"



# Parameters
#############

# PIPELINES
if [ "$PIPELINES_INPUT" != "" ]; then
	PIPELINES=$PIPELINES_INPUT
fi;

if [ -z "$LATEX" ]; then
	LATEX="latex";
fi;

if [ ! -z $GROUP_INPUT ]; then
	GROUP=$GROUP_INPUT
fi;
if [ ! -z $APP_GROUP ]; then
	GROUP=$APP_GROUP
fi;
if [ -z $GROUP ]; then
	GROUP="UNKNOWN"
fi;

if [ ! -z $PROJECT_INPUT ]; then
	PROJECT=$PROJECT_INPUT
fi;
if [ ! -z $APP_PROJECT ]; then
	PROJECT=$APP_PROJECT
fi;
if [ -z $PROJECT ]; then
	PROJECT="UNKNOWN"
fi;

if [ ! -z $USER_INPUT ]; then
	USER=$USER_INPUT
fi;
if [ -z $USER ]; then
	USER="UNKNOWN"
fi;

if [ -z $DATE ]; then
	DATE=$(date '+%Y%m%d-%H%M%S')
fi;

if [ ! -z $TMP_FOLDER_TMP ]; then
	TMP_REPORT=$TMP_FOLDER_TMP;
else
	TMP_REPORT=/tmp;
fi;


if [ ! -z $NB_VARIANT_LIMIT ]; then
	NB_VARIANT_LIMIT=$NB_VARIANT_LIMIT;
else
	NB_VARIANT_LIMIT=20;
fi;

if [ ! -z $RESULTS_FOLDER_INPUT ] && [ -d $RESULTS_FOLDER_INPUT ]; then
	RESULTS_FOLDER=$RESULTS_FOLDER_INPUT;
fi;

if [ ! -z $OUTPUT_INPUT ]; then
	OUTPUT=$OUTPUT_INPUT
else
	OUTPUT=$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.$DATE.stark.report
fi;

if [ -z $OUTPUT_TYPE_INPUT ]; then
	OUTPUT_TYPE="html";
fi;

if [ ! -z "$REPORT_SECTIONS" ]; then
	SECTIONS="$REPORT_SECTIONS"
fi;
if [ ! -z "$SECTIONS_INPUT" ]; then
	SECTIONS="$SECTIONS_INPUT"
fi;
if [ -z "$SECTIONS" ]; then
	SECTIONS="ALL"
fi;


# echo "SECTIONS=$SECTIONS"
# exit 0

# Other param


# LOGO
########
# STARK_LOGO_small_1.png

STARK_LOGO="$STARK_FOLDER_DOCS/logo/STARK_LOGO_medium_1.png"

[ ! -e "$LOGO" ] && LOGO="$STARK_FOLDER_DOCS/logo/STARK_LOGO_medium_1.png"
if [ ! -e $LOGO ]; then LOGO=""; fi;

# FAVICON
FAVICON="$STARK_FOLDER_DOCS/logo/favicon.png"


# REPORT TMP DIR
##################
# creation and verification of the directory containing the sample report

REPORTDIR="$TMP_REPORT/STARK_REPORT_$RANDOM"
mkdir -p $REPORTDIR;
[ ! -e $REPORTDIR ] && echo "$REPORTDIR can't be created ! Exit.";


# LOG FILE
###########
# creation and verification of the log file

LOGFILE="$REPORTDIR/latex_report.$DATE.log"
if [ ! -e "$LOGFILE" ] ; then
    touch "$LOGFILE" || (echo "$LOGFILE can't be created ! Exit." && exit 1);
fi

# OUTPUT FILES
################
# creation and verification of the tex file report

HTMLFOLDER_EXT=".folder"
HTMLFOLDER_FILES_FOLDER="files"
ANNEX_PATTERN="annex"

# OUTPUT files
OUTPUT_HTMLFILE="$OUTPUT.html"
OUTPUT_TEXFILE="$OUTPUT.tex"
OUTPUT_PDFFILE="$OUTPUT.pdf"

# OUTPUT annexe files
OUTPUT_ANNEX_HTMLFILE="$OUTPUT.$ANNEX_PATTERN.html"
OUTPUT_ANNEX_TEXFILE="$OUTPUT.$ANNEX_PATTERN.tex"
OUTPUT_ANNEX_PDFFILE="$OUTPUT.$ANNEX_PATTERN.pdf"

# OUTPUT FOLDER
OUTPUT_HTMLFOLDER="$(basename $OUTPUT_HTMLFILE)$HTMLFOLDER_EXT"
#OUTPUT_HTMLDIR=$OUTPUT.html$HTMLFOLDER_EXT
OUTPUT_HTMLDIR="$(dirname $OUTPUT_HTMLFILE)/$OUTPUT_HTMLFOLDER"

# FILES
OUTPUT_FILES_HTMLFOLDER=$OUTPUT_HTMLFOLDER/$HTMLFOLDER_FILES_FOLDER
OUTPUT_FILES_HTMLDIR=$OUTPUT_HTMLDIR/$HTMLFOLDER_FILES_FOLDER

# BASENAME
OUTPUT_BASENAME=$(basename $OUTPUT)

# TMP files
HTMLFILE="$REPORTDIR/$OUTPUT_BASENAME.html"
TEXFILE="$REPORTDIR/$OUTPUT_BASENAME.tex"
PDFFILE="$REPORTDIR/$OUTPUT_BASENAME.pdf"

HTMLFILE_ANNEX="$REPORTDIR/$OUTPUT_BASENAME.$ANNEX_PATTERN.html"
TEXFILE_ANNEX="$REPORTDIR/$OUTPUT_BASENAME.$ANNEX_PATTERN.tex"
PDFFILE_ANNEX="$REPORTDIR/$OUTPUT_BASENAME.$ANNEX_PATTERN.pdf"

HTMLFOLDER=$(basename $HTMLFILE)$HTMLFOLDER_EXT
HTMLDIR="$REPORTDIR/$HTMLFOLDER"

mkdir -p $HTMLDIR $OUTPUT_HTMLDIR $OUTPUT_FILES_HTMLDIR

# PIPELINES
##############

ALIGNERS=$(echo $PIPELINES | tr " " "\n"  | cut -d. -f1 | sort -u | tr "\n" " " | sed "s/^ //" | sed "s/ $//")
ALIGNERS_NUMBER=$(echo $PIPELINES | tr " " "\n"  | cut -d. -f1 | sort -u  | wc -l)
CALLERS=$(echo $PIPELINES | tr " " "\n"  | cut -d. -f2 | sort -u | tr "\n" " " | sed "s/^ //" | sed "s/ $//")
CALLERS_NUMBER=$(echo $PIPELINES | tr " " "\n"  | cut -d. -f2 | sort -u  | wc -l)
ALIGNERS_CALLERS=$(echo $PIPELINES | tr " " "\n"  | cut -d. -f1-2 | sort -u | tr "\n" " " | sed "s/^ //" | sed "s/ $//")
ALIGNERS_CALLERS_NUMBER=$(echo $PIPELINES | tr " " "\n"  | cut -d. -f1-2 | sort -u | wc -l)
ANNOTATORS=$(echo $PIPELINES | tr " " "\n"  | cut -d. -f3 | sort -u | tr "\n" " " | sed "s/^ //" | sed "s/ $//")
ANNOTATORS_NUMBER=$(echo $PIPELINES | tr " " "\n"  | cut -d. -f3 | sort -u | wc -l)
ALIGNERS_CALLERS_ANNOTATORS=$(echo $PIPELINES | tr " " "\n"  | cut -d. -f1-3 | sort -u | tr "\n" " " | sed "s/^ //" | sed "s/ $//")
PIPELINES_NUMBER=$(echo $PIPELINES | tr " " "\n" | sort -u | wc -l)

# SAMPLEID
###########

SAMPLEID=$SAMPLE


# GROUP/PROJECT/USER
######################

SAMPLE_GROUP=$GROUP; if [ "$SAMPLE_GROUP" == "" ]; then SAMPLE_GROUP="UNKNOWN"; fi;
SAMPLE_PROJECT=$PROJECT; if [ "$SAMPLE_PROJECT" == "" ]; then SAMPLE_PROJECT="UNKNOWN"; fi;
SAMPLE_USER=$USER; if [ "$SAMPLE_USER" == "" ]; then SAMPLE_USER="UNKNOWN"; fi;
if [ -z "$APP" ]; then APP="DEFAULT"; fi;



# DESIGN
#########

MANIFEST_NAME_FILE=$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.manifest_name
BED_NAME_FILE=$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.bed_name
GENES_LIST_FILE=$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.list.genes
MANIFEST_NAME=""
MANIFEST_SOURCE=""
BED_NAME=""
BED_SOURCE=""
if [ -s "$MANIFEST_NAME_FILE" ]; then
	MANIFEST_NAME=$(basename $(awk -F"\t" '{print $1}' $MANIFEST_NAME_FILE)) # awk -F\t '{print $2}'
	MANIFEST_SOURCE=$(awk -F"\t" '{print $2}' $MANIFEST_NAME_FILE)
fi;
if [ -s "$BED_NAME_FILE" ]; then
	BED_NAME=$(basename $(awk -F"\t" '{print $1}' $BED_NAME_FILE))
	BED_SOURCE=$(awk -F"\t" '{print $2}' $BED_NAME_FILE)
fi;
if [ -s "$GENES_LIST_FILE" ]; then
	GENES_LIST=$(cat $GENES_LIST_FILE | tr "\n" " ")
	#BED_SOURCE=$(awk -F"\t" '{print $2}' $BED_NAME_FILE)
fi;

if [ -z "$MANIFEST_NAME" ]; then
	MANIFEST_NAME="unknown";
fi;
if [ -z "$BED_NAME" ]; then
	BED_NAME="unknown";
fi;
if [ ! -z "$MANIFEST_SOURCE" ]; then
	MANIFEST_SOURCE=" ($MANIFEST_SOURCE)";
fi;
if [ ! -z "$BED_SOURCE" ]; then
	BED_SOURCE=" ($BED_SOURCE)";
fi;


# VARIABLES

PAGE_BREAK_AFTER=' style="page-break-after: always;"'
PAGE_BREAK_BEFORE=' style="page-break-before: always;"'


# TABLE_LIMIT
#TABLE_LIMIT=2000
TABLE_LIMIT=2000
TABLE_LIMIT_CUT=10000000
TABLE_LIMIT_MSG="Too many rows to display in the table (>$TABLE_LIMIT)"
TABLE_LIMIT_MSG_HTML="<center>$TABLE_LIMIT_MSG</center>"


# Supplementary files
DOWNLOAD_FILE_MSG="Download"



# BAM Validation texts
#uniq reads, with quality higher than 10, aligned on Target Design, and clipped overlapped bases
BAM_VALIDATION_TEXT_HTML='Minimum <strong>Mapping</strong> Quality >= <strong>'$METRICS_MINIMUM_MAPPING_QUALITY'</strong><br>'
BAM_VALIDATION_TEXT_HTML=$BAM_VALIDATION_TEXT_HTML' Minimum <strong>Base</strong> Quality >= <strong>'$METRICS_MINIMUM_BASE_QUALITY'</strong><br>'
(($CLIP_OVERLAPPING_READS)) && BAM_VALIDATION_TEXT_HTML=$BAM_VALIDATION_TEXT_HTML' <strong>Clipping overlapping reads</strong><br>'
[ "$METRICS_FLAGS" != "" ] && BAM_VALIDATION_TEXT_HTML=$BAM_VALIDATION_TEXT_HTML' <strong>exclude</strong> Reads with flags <strong>'$METRICS_FLAGS'</strong>' || BAM_VALIDATION_TEXT_HTML=$BAM_VALIDATION_TEXT_HTML' no Reads excluded'


# LIST_GENES_PANEL
LIST_GENES_PANEL="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.list.genes"
LIST_GENES_PANEL_BASENAME=$REPORTDIR/list.genes
> $LIST_GENES_PANEL_BASENAME
for GENES_PANEL in $(cat $LIST_GENES_PANEL); do
	echo $(basename $GENES_PANEL) >> $LIST_GENES_PANEL_BASENAME
done;



#cat $LIST_GENES_PANEL_BASENAME

#exit 0

### DEBUG ###

if (($DEBUG)); then
	echo "

	### DEBUG ###

	ANALYSIS:             $ANALYSIS
	SAMPLE:               $SAMPLE/$SAMPLEID
	APPLICATION:          $APP
	PIPELINES:            $PIPELINES
	   ALIGNERS:          $ALIGNERS
	   CALLERS:           $CALLERS
	   ALIGNERS_CALLERS   $ALIGNERS_CALLERS
	   ANNOTATORS:        $ANNOTATORS
	   ALIGNERS_CALLERS_A $ALIGNERS_CALLERS_ANNOTATORS
	GROUP:                $GROUP
	PROJECT:              $PROJECT
	USER:                 $USER
	RESULTS_FOLDER:       $RESULTS_FOLDER
	DATE:                 $DATE
	OUTPUT:               $OUTPUT
	   OUTPUT_BASENAME:   $OUTPUT_BASENAME
	   OUTPUT_HTMLFILE:   $OUTPUT_HTMLFILE
	   OUTPUT_HTMLDIR:    $OUTPUT_HTMLDIR
	   OUTPUT_TEXFILE:    $OUTPUT_TEXFILE
	   OUTPUT_PDFFILE:    $OUTPUT_PDFFILE
	OUTPUT_TYPE:          $OUTPUT_TYPE
   	SAMPLE_GROUP:         $SAMPLE_GROUP
	SAMPLE_PROJECT:       $SAMPLE_PROJECT
	SAMPLE_USER:          $SAMPLE_USER

	DESIGN
	MANIFEST_NAME:        $MANIFEST_NAME
	MANIFEST_SOURCE:      $MANIFEST_SOURCE
	BED_NAME:             $BED_NAME
	BED_SOURCE:           $BED_SOURCE
	GENES_LIST:           $GENES_LIST

	TMP_REPORT:           $TMP_REPORT
	   HTMLFILE:          $HTMLFILE
	   HTMLDIR:           $HTMLDIR
	   TEXFILE:           $TEXFILE
	   PDFFILE:           $PDFFILE
	NB_VARIANT_LIMIT:     $NB_VARIANT_LIMIT

	REPORTDIR:            $REPORTDIR
	LOGFILE:              $LOGFILE

	"
fi;


# HEADER
##########


HTMLFILE_HEADER=$HTMLFILE".header"



cp -R $STARK_FOLDER_BIN/html/assets/* $HTMLDIR/
cp $FAVICON $HTMLDIR/favicon.ico



echo '
	<!-- Site made with Mobirise Website Builder v4.10.3, https://mobirise.com -->
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="generator" content="Mobirise v4.10.3, mobirise.com">
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
	<link rel="shortcut icon" href="'$HTMLFOLDER/favicon.ico'" type="image/x-icon">
	<meta name="description" content="STARK Report">

	<title>STARK Report - '$SAMPLEID'</title>
	<link rel="stylesheet" href="'$HTMLFOLDER'/web/assets/mobirise-icons/mobirise-icons.css">
	<link rel="stylesheet" href="'$HTMLFOLDER'/tether/tether.min.css">
	<link rel="stylesheet" href="'$HTMLFOLDER'/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="'$HTMLFOLDER'/bootstrap/css/bootstrap-grid.min.css">
	<link rel="stylesheet" href="'$HTMLFOLDER'/bootstrap/css/bootstrap-reboot.min.css">
	<link rel="stylesheet" href="'$HTMLFOLDER'/dropdown/css/style.css">
	<link rel="stylesheet" href="'$HTMLFOLDER'/as-pie-progress/css/progress.min.css">
	<link rel="stylesheet" href="'$HTMLFOLDER'/datatables/data-tables.bootstrap4.min.css">
	<link rel="stylesheet" href="'$HTMLFOLDER'/theme/css/style.css">
	<link rel="stylesheet" href="'$HTMLFOLDER'/gallery/style.css">
	<link rel="stylesheet" href="'$HTMLFOLDER'/mobirise/css/mbr-additional.css" type="text/css">

	<style>
		.table-wrapper {
			overflow: auto;
			max-height:800px;
			}
	</style>

' > $HTMLFILE_HEADER


# SCRIPTS
###########

HTMLFILE_SCRIPTS=$HTMLFILE".scripts"

echo '
	<script src="'$HTMLFOLDER'/web/assets/jquery/jquery.min.js"></script>
	<script src="'$HTMLFOLDER'/popper/popper.min.js"></script>
	<script src="'$HTMLFOLDER'/tether/tether.min.js"></script>
	<script src="'$HTMLFOLDER'/bootstrap/js/bootstrap.min.js"></script>
	<script src="'$HTMLFOLDER'/smoothscroll/smooth-scroll.js"></script>
	<script src="'$HTMLFOLDER'/dropdown/js/script.min.js"></script>
	<script src="'$HTMLFOLDER'/touchswipe/jquery.touch-swipe.min.js"></script>
	<script src="'$HTMLFOLDER'/viewportchecker/jquery.viewportchecker.js"></script>
	<script src="'$HTMLFOLDER'/as-pie-progress/jquery-as-pie-progress.min.js"></script>
	<script src="'$HTMLFOLDER'/vimeoplayer/jquery.mb.vimeo_player.js"></script>
	<script src="'$HTMLFOLDER'/datatables/jquery.data-tables.min.js"></script>
	<script src="'$HTMLFOLDER'/datatables/data-tables.bootstrap4.min.js"></script>
	<script src="'$HTMLFOLDER'/masonry/masonry.pkgd.min.js"></script>
	<script src="'$HTMLFOLDER'/imagesloaded/imagesloaded.pkgd.min.js"></script>
	<script src="'$HTMLFOLDER'/bootstrapcarouselswipe/bootstrap-carousel-swipe.js"></script>
	<script src="'$HTMLFOLDER'/mbr-switch-arrow/mbr-switch-arrow.js"></script>
	<script src="'$HTMLFOLDER'/theme/js/script.js"></script>
	<script src="'$HTMLFOLDER'/gallery/player.min.js"></script>
	<script src="'$HTMLFOLDER'/gallery/script.js"></script>
	<script src="'$HTMLFOLDER'/slidervideo/script.js"></script>
	<script src="'$HTMLFOLDER'/mbr-tabs/mbr-tabs.js"></script>
' > $HTMLFILE_SCRIPTS


# PLAN
##########

#(($VERBOSE)) && echo "[INFO] PLAN section"

HTMLFILE_PLAN_LINKS=$HTMLFILE".plan.links"
> $HTMLFILE_PLAN_LINKS


HTMLFILE_ANNEX_PLAN_LINKS=$HTMLFILE_ANNEX".plan.links"
> $HTMLFILE_ANNEX_PLAN_LINKS


# SECTIONS
############


# MENU
#######

(($VERBOSE)) && echo "#[INFO] MENU section"

HTMLFILE_MENU=$HTMLFILE".menu"

cp $LOGO $HTMLDIR/$(basename $LOGO)
HTML_LOGO="$HTMLFOLDER/$(basename $LOGO)"

cp $STARK_LOGO $HTMLDIR/$(basename $STARK_LOGO)
HTML_STARK_LOGO="$HTMLFOLDER/$(basename $STARK_LOGO)"


echo '
<section class="menu cid-qTkzRZLJNu" once="menu" id="menu1-3">
  <nav class="navbar navbar-expand beta-menu navbar-dropdown align-items-center navbar-fixed-top collapsed bg-color transparent">
	  <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
		  <div class="hamburger">
			  <span></span>
			  <span></span>
			  <span></span>
			  <span></span>
		  </div>
	  </button>
	  <div class="menu-logo">
		  <div class="navbar-brand">
			  <span class="navbar-logo">
				  <a href="">
					   <img src="'$HTML_LOGO'" alt="Mobirise" title="" style="height: 6rem;">
				  </a>
			  </span>
			  <span class="navbar-caption-wrap"><a class="navbar-caption text-secondary display-2" href="">'$SAMPLEID'</a></span>
		 </div>
	  </div>
	  <div class="collapse navbar-collapse align-center" id="navbarSupportedContent">
		  <p class="mbr-text pb-3 mbr-fonts-style display-5">
			  <img src="'$HTML_STARK_LOGO'" alt="STARK" title="" style="height: 24rem;">
		  </p>
		  <h1 class="mbr-section-title mbr-bold pb-3 mbr-fonts-style display-2">
			  '$ENV_NAME'
		  </h1>
		  <p class="mbr-text pb-3 mbr-fonts-style display-5">
			  '$ENV_RELEASE' - '$ENV_DATE'
			  <BR>
			  '$ENV_DESCRIPTION'
			  <BR>
			  Â© Copyright '$ENV_COPYRIGHT' - All Rights Reserved
			  <BR>
			  '$ENV_LICENCE' Licence
			  <BR>
			  <BR>
			  <BR>
		  </p>
		  <div class="navbar-buttons mbr-section-btn">
			  <!--
			  <a class="btn btn-sm btn-primary display-4" href="https://mobirise.com">
				  <span class="mbri-save mbr-iconfont mbr-iconfont-btn "></span>
				  Try It Now!
			  </a>
			  -->
		  </div>
	  </div>
  </nav>
</section>
' > $HTMLFILE_MENU




# TITLE
####################

(($VERBOSE)) && echo "#[INFO] TITLE section"

HTMLFILE_TITLE=$HTMLFILE".title"

# SAMPLE TAG
SAMPLE_TAG=$(extract_tag $(cat $RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.tag) "" "TYPE#TAG")
SAMPLE_TAG_HTML=""
for TYPETAG in $SAMPLE_TAG; do
	TYPE=$(echo "$TYPETAG" | awk -F"#" '{print $1}' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
	TAG=$(echo "$TYPETAG" | cut -d"#" -f2- | tr "#" " " | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
	SAMPLE_TAG_HTML="$SAMPLE_TAG_HTML&nbsp;&nbsp;&nbsp; <small>$TYPE</small><strong>#$TAG</strong>"
done

# ANALYSIS TAG
ANALYSIS_TAG=$(extract_tag $(cat $RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.analysis.tag) "" "TYPE#TAG")
ANALYSIS_TAG_HTML=""
for TYPETAG in $ANALYSIS_TAG; do
	TYPE=$(echo "$TYPETAG" | awk -F"#" '{print $1}' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
	TAG=$(echo "$TYPETAG" | cut -d"#" -f2- | tr "#" " " | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
	ANALYSIS_TAG_HTML="$ANALYSIS_TAG_HTML<small>$TYPE</small><strong>#$TAG</strong>&nbsp;&nbsp;&nbsp; "
done


echo '

<section class="header1 cid-ru7OEConn1" id="header16-1k">

		<div class="container">

		   	 <div class="row justify-content-center  align-center">

		   		 <div class="card p-6 col-12 col-md-12">
		   			 <div class="card-box">
		   				 <h1 class="mbr-section-title mbr-bold pb-3 mbr-fonts-style display-2">
			   					<img src="'$HTML_LOGO'" width="128">
		   				 </h1>
		   			 </div>
		   		 </div>

			 </div>

		 </div>

	    <div class="container">

	        <div class="row justify-content-center  align-left">

	            <div class="card p-6 col-12 col-md-6" style="border-style: none solid none none ; border-color: rgb(20, 157, 204); border-radius: 0px;">
					<div class="card-box">
						<h1 class="mbr-section-title mbr-bold pb-3 mbr-fonts-style display-2 align-right">
							'$SAMPLEID'
						</h1>
	                    <p class="mbr-text pb-3 mbr-fonts-style display-7 align-right">
							'$SAMPLE_TAG_HTML'
						</p>
	                </div>
	            </div>

	            <div class="card p-6 col-12 col-md-6">

	                <div class="card-box">
						<h1 class="mbr-section-title pb-3 mbr-fonts-style display-2 align-left">
								<small><small><small><small>'$ANALYSIS'</small></small></small></small>
						</h1>
						<p class="mbr-section-subtitle mbr-fonts-style display-7 align-left">
							'$ANALYSIS_TAG_HTML'
						</p>
	                </div>

	            </div>

	        </div>

	    </div>

</section>



' > $HTMLFILE_TITLE





# MAIN INFORMATION
####################

(($VERBOSE)) && echo "#[INFO] MAIN section"


HTMLFILE_MAIN=$HTMLFILE".main"



# TARGET DESIGN
DESIGN_NAME=$(echo $MANIFEST_NAME"$(if [ "$MANIFEST_NAME" != "$BED_NAME" ]; then echo " / $BED_NAME"; fi)")
BED="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.bed"
MANIFEST="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.manifest"
# Number of regions
DESIGN_NUMBER_REGIONS=$(grep -vc "^#" $BED)

# COPY
DESIGN_FILES_DOWNLOAD_FILENAME=$RANDOM$RANDOM.design.tar.gz
(cd $RESULTS_FOLDER/$ANALYSIS/$SAMPLE/ && tar -czf $OUTPUT_FILES_HTMLDIR/$DESIGN_FILES_DOWNLOAD_FILENAME $SAMPLE.bed $SAMPLE.manifest)
DESIGN_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$DESIGN_FILES_DOWNLOAD_FILENAME

# HTML
if (($DESIGN_NUMBER_REGIONS)); then
	DESIGN_NUMBER_BASES=$($BEDTOOLS sort -i $BED | $BEDTOOLS merge -i - > $REPORTDIR/merge_all_genes.bed; $BEDTOOLS coverage -a $REPORTDIR/merge_all_genes.bed  -b $REPORTDIR/merge_all_genes.bed | awk -F '\t' 'BEGIN{sum = 0} {sum += $6} END {print sum}'; rm $REPORTDIR/merge_all_genes.bed; )
	GENES_BASES_HTML=$(echo $GENES_BASES_NUMBER | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
	TARGET_DESIGN_HTML="
		<a href='$DESIGN_DOWNLOAD_FILE' download>Target Design</a> includes <strong>$DESIGN_NUMBER_REGIONS Target"$([ $DESIGN_NUMBER_REGIONS -gt 1 ] && echo "s")"</strong> ($DESIGN_NUMBER_BASES bases)
		<br><strong>$DESIGN_NAME</strong>
	"

else
	TARGET_DESIGN_HTML="No Target Design defined"
fi;

# GENE PANEL
LIST_GENE_PANEL="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.list.genes"
GENE_PANEL_FILES_NAME=$(grep -v "^#" $LIST_GENE_PANEL | sed "s/^$SAMPLE\.//gi")
GENE_PANEL_FILES_NAME_HTML=$(echo $GENE_PANEL_FILES_NAME | sed "s/ /<br>/gi")


# Gene number
if [ "$(cat $LIST_GENE_PANEL)" != "" ]; then
	GENES_NUMBER=$(cd $RESULTS_FOLDER/$ANALYSIS/$SAMPLE/; cat $(cat $LIST_GENE_PANEL) | $STARK_BED_NORMALIZATION | cut -f4 | sort -u | wc -l)
else
	GENES_NUMBER=0
fi;

GENE_PANEL_NUMBER=$(grep -vc "^#" $LIST_GENE_PANEL)

# COPY
GENE_PANEL_FILES_DOWNLOAD_FILENAME=$RANDOM$RANDOM.panel.tar.gz
(cd $RESULTS_FOLDER/$ANALYSIS/$SAMPLE/ && tar -czf $OUTPUT_FILES_HTMLDIR/$GENE_PANEL_FILES_DOWNLOAD_FILENAME $(cat $LIST_GENE_PANEL))
GENE_PANEL_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENE_PANEL_FILES_DOWNLOAD_FILENAME
# HTML
if (($GENE_PANEL_NUMBER)); then
	GENE_PANEL_HTML="
		<br><a href='$GENE_PANEL_DOWNLOAD_FILE' download>Gene Panel"$([ $GENE_PANEL_NUMBER -gt 1 ] && echo "s")"</a> includes <strong>$GENES_NUMBER gene"$([ $GENES_NUMBER -gt 1 ] && echo "s")"</strong>
		<br><strong>$GENE_PANEL_FILES_NAME_HTML</strong>
	"
else
	GENE_PANEL_HTML="<br>Gene Panel defined using Design and RefSeq"
fi;


# TRANSCRIPTS
TRANSCRIPTS_LIST="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.list.transcripts"
TRANSCRIPTS="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.transcripts"
if [ -s $TRANSCRIPTS ]; then
	TRANSCRIPTS_NUMBER=$(grep -v "^#" $TRANSCRIPTS | cut -f1 | sort -u | wc -l )
	TRANSCRIPTS_GENES_NUMBER=$(grep -v "^#" $TRANSCRIPTS | cut -f2 | sort -u | wc -l )
	#TRANSCRIPTS_FILES_NAME=$(basename $TRANSCRIPTS)
	#TRANSCRIPTS_FILES_NUMBER=1
	if [ -s $TRANSCRIPTS_LIST ]; then
		TRANSCRIPTS_FILES_NAME=$(grep -v "^#" $TRANSCRIPTS_LIST | sed "s/^$SAMPLE\.//gi")
		TRANSCRIPTS_FILES_NUMBER=$(grep -vc "^#" $TRANSCRIPTS_LIST)
	fi;
	TRANSCRIPTS_FILES_NAME_HTML=$(echo $TRANSCRIPTS_FILES_NAME | sed "s/ /<br>/gi" )
	# COPY FILES
	TRANSCRIPTS_DOWNLOAD_FILENAME=$RANDOM$RANDOM.transcripts.txt.gz
	$GZ $TRANSCRIPTS -c > $OUTPUT_FILES_HTMLDIR/$TRANSCRIPTS_DOWNLOAD_FILENAME
	TRANSCRIPTS_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$TRANSCRIPTS_DOWNLOAD_FILENAME
	# HTML
	if (($TRANSCRIPTS_NUMBER)); then
		TRANSCRIPTS_NUMBER_HTML="
			<br><a href='$TRANSCRIPTS_DOWNLOAD_FILE' download>Transcript list</a> includes <strong>$TRANSCRIPTS_NUMBER transcript"$([ $TRANSCRIPTS_NUMBER -gt 1 ] && echo "s")"</strong> ($TRANSCRIPTS_GENES_NUMBER gene"$([ $TRANSCRIPTS_GENES_NUMBER -gt 1 ] && echo "s")")
			<br><strong>$TRANSCRIPTS_FILES_NAME_HTML</strong>
			"
	else
		TRANSCRIPTS_NUMBER_HTML="<br>No transcript defined"
	fi;
else
	TRANSCRIPTS_NUMBER_HTML="<br>No transcript defined"
fi;


# CONFIG
CONFIG_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.$DATE.config"

# COPY FILES
CONFIG_FILE_DOWNLOAD_FILENAME=$RANDOM$RANDOM.config.txt.gz
$GZ $CONFIG_FILE -c > $OUTPUT_FILES_HTMLDIR/$CONFIG_FILE_DOWNLOAD_FILENAME
CONFIG_FILE_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$CONFIG_FILE_DOWNLOAD_FILENAME
CONFIG_FILE_DOWNLOAD_FILE_HTML="<a href='$CONFIG_FILE_DOWNLOAD_FILE' download>Configuration</a>"


# DATABASES RELEASE
DATABASES_RELEASE_HTML=""
if [ "$DATABASES_RELEASE" != "" ] && [ "$DATABASES_RELEASE" != "UNKNOWN" ]; then
	DATABASES_RELEASE_HTML=" with databases release <strong>'$DATABASES_RELEASE'</strong>"
fi
# Swhitch off DATABASES RELEASE HTML
DATABASES_RELEASE_HTML=""


echo '

<section class="features10 cid-ru7OEDbxhA" id="features10-1l">

    <div class="container">
        <div class="row justify-content-center">
            <div class="card p-3 col-12 col-md-6">
                <div class="media mb-3">
                    <div class="card-img align-self-center">
                        <span class="mbr-iconfont mbri-setting3" style="color: rgb(20, 157, 204); fill: rgb(20, 157, 204);"></span>
                    </div>
                    <h4 class="card-title media-body py-3 mbr-fonts-style display-7">'$(echo $APP_NAME | sed "s/ /<br>/gi")'</h4>
                </div>
                <div class="card-box">
                    <p class="mbr-text mbr-fonts-style display-7">
						'$APP_DESCRIPTION'<br>
						Application designed for <strong>'$GROUP'</strong> group and <strong>'$PROJECT'</strong> project, with <strong>'$ASSEMBLY'</strong> assembly.
						Analysis performed by <strong>'$ENV_NAME':'$ENV_RELEASE'</strong>'$DATABASES_RELEASE_HTML'.<br>
						'$CONFIG_FILE_DOWNLOAD_FILE_HTML'
					</p>
                </div>
            </div>

            <div class="card p-3 col-12 col-md-6">
                <div class="media mb-3">
                    <div class="card-img align-self-center">
                        <span class="mbr-iconfont mbri-target" style="color: rgb(20, 157, 204); fill: rgb(20, 157, 204);"></span>
                    </div>
                    <h4 class="card-title media-body py-3 mbr-fonts-style display-7">Target Design <br> Gene Panel <br> Transcripts list</h4>
                </div>
                <div class="card-box">
                    <p class="mbr-text mbr-fonts-style display-7">
						'$TARGET_DESIGN_HTML'
						'$GENE_PANEL_HTML'
						'$TRANSCRIPTS_NUMBER_HTML'
					</p>
                </div>
            </div>

        </div>
    </div>

</section>

' > $HTMLFILE_MAIN

# SUMMARY
##############

(($VERBOSE)) && echo "#[INFO] SUMMARY section"

HTMLFILE_SUMMARY=$HTMLFILE".summary"

SECTION_NAME="Results Summary"
SECTION_ID="results_summary"

# FILES
SEQUENCING_INFOS="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.sequencing/metrics.infos.txt"
SEQUENCING_FASTP_JSON="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.sequencing/$SAMPLE.fastp.json"
SEQUENCING_FASTP_HTML="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.sequencing/$SAMPLE.fastp.html"

# Prepare FASTP HTML file
cp $SEQUENCING_FASTP_HTML $HTMLDIR/$(basename $SEQUENCING_FASTP_HTML)
cat $SEQUENCING_FASTP_HTML | sed "s/https:\/\/cdn.plot.ly\/plotly-latest.min.js/plotly-latest.min.js/" > $HTMLDIR/$(basename $SEQUENCING_FASTP_HTML)

SEQUENCING_FASTP_HTML_HTML=$HTMLFOLDER/$(basename $SEQUENCING_FASTP_HTML)


# filtering step
SEQUENCING_FILTERING_STEP="before_filtering"

# Reads Length
BEFORE_SEQUENCE_LENGTH=$(cat $SEQUENCING_FASTP_JSON | $PYTHON2 -c "import sys, json; print json.load(sys.stdin)['summary']['before_filtering']['read1_mean_length']")
AFTER_SEQUENCE_LENGTH=$(cat $SEQUENCING_FASTP_JSON | $PYTHON2 -c "import sys, json; print json.load(sys.stdin)['summary']['after_filtering']['read1_mean_length']")

# READS and BASES count
BEFORE_TOTAL_SEQUENCES=$(cat $SEQUENCING_FASTP_JSON | $PYTHON2 -c "import sys, json; print json.load(sys.stdin)['summary']['before_filtering']['total_reads']")
BEFORE_TOTAL_SEQUENCES_HTML=$(echo $BEFORE_TOTAL_SEQUENCES | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
BEFORE_TOTAL_BASES=$(cat $SEQUENCING_FASTP_JSON | $PYTHON2 -c "import sys, json; print json.load(sys.stdin)['summary']['before_filtering']['total_bases']")
BEFORE_TOTAL_BASES_HTML=$(echo $BEFORE_TOTAL_BASES | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
AFTER_TOTAL_SEQUENCES=$(cat $SEQUENCING_FASTP_JSON | $PYTHON2 -c "import sys, json; print json.load(sys.stdin)['summary']['after_filtering']['total_reads']")
AFTER_TOTAL_SEQUENCES_HTML=$(echo $AFTER_TOTAL_SEQUENCES | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
AFTER_TOTAL_BASES=$(cat $SEQUENCING_FASTP_JSON | $PYTHON2 -c "import sys, json; print json.load(sys.stdin)['summary']['after_filtering']['total_bases']")
AFTER_TOTAL_BASES_HTML=$(echo $AFTER_TOTAL_BASES | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
AFTER_TOTAL_SEQUENCES_PERCENT=$(echo "scale = 4; ($AFTER_TOTAL_SEQUENCES / $BEFORE_TOTAL_SEQUENCES)*100" | bc | sed s/00$//)

# Q30
BEFORE_Q30=$(cat $SEQUENCING_FASTP_JSON | $PYTHON2 -c "import sys, json; print json.load(sys.stdin)['summary']['before_filtering']['q30_rate']")
if [ "$BEFORE_Q30" == "1" ]; then
	BEFORE_Q30_HTML="100"
elif [ "$BEFORE_Q30" == "0" ]; then
	BEFORE_Q30_HTML="0"
else
	BEFORE_Q30_HTML=$(echo "scale = 2; ($BEFORE_Q30 * 100)/1" | bc | sed s/[0]*$//)
fi;
[ "$BEFORE_Q30_HTML" == "" ] && BEFORE_Q30_HTML="?"

AFTER_Q30=$(cat $SEQUENCING_FASTP_JSON | $PYTHON2 -c "import sys, json; print json.load(sys.stdin)['summary']['after_filtering']['q30_rate']")
if [ "$AFTER_Q30" == "1" ]; then
	AFTER_Q30_HTML="100"
elif [ "$AFTER_Q30" == "0" ]; then
	AFTER_Q30_HTML="0"
else
	AFTER_Q30_HTML=$(echo "scale = 2; ($AFTER_Q30 * 100)/1" | bc | sed s/[0]*$//)
fi;
[ "$AFTER_Q30_HTML" == "" ] && AFTER_Q30_HTML="?"



# SEQUENCING TECHNOLOGY
SEQUENCING_MODE_HTML=$(grep "^mode" $SEQUENCING_INFOS | cut -f2)
SEQUENCING_TECHNOLOGY_HTML=$(grep "^technology" $SEQUENCING_INFOS | cut -f2)


# BASES count
GENES_BASES_NUMBER=$(cd $RESULTS_FOLDER/$ANALYSIS/$SAMPLE/; cat $(cat $LIST_GENE_PANEL) | $BEDTOOLS sort -i - | $BEDTOOLS merge -i - > $REPORTDIR/merge_all_genes.bed; $BEDTOOLS coverage -a $REPORTDIR/merge_all_genes.bed  -b $REPORTDIR/merge_all_genes.bed | awk -F '\t' 'BEGIN{sum = 0} {sum += $6} END {print sum}'; rm $REPORTDIR/merge_all_genes.bed; )
GENES_BASES_HTML=$(echo $GENES_BASES_NUMBER | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')


# VARIANTS count
FINAL_VCF="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.gz"
#FINAL_TSV="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.tsv"
#VARIANT_NUMBER=$(grep -cv "^#" $FINAL_VCF)
VARIANT_NUMBER=$(zcat $FINAL_VCF | grep -cv "^#" )
FINAL_VCF_PZFLAG_HEADER=$(zcat $FINAL_VCF | grep  "^##INFO=<ID=PZFlag")

# PIPELINES count
ALIGNERS_HTML="$ALIGNERS_NUMBER aligner"$([ $ALIGNERS_NUMBER -gt 1 ] && echo "s")
CALLERS_HTML="$CALLERS_NUMBER caller"$([ $CALLERS_NUMBER -gt 1 ] && echo "s")
ANNOTATORS_HTML="$ANNOTATORS_NUMBER annotator"$([ $ANNOTATORS_NUMBER -gt 1 ] && echo "s")
PIPELINES_HTML="<strong>$PIPELINES_NUMBER pipeline"$([ $PIPELINES_NUMBER -gt 1 ] && echo "s")"</strong>"
ALIGNERS_CALLERS_ANNOTATORS_HTML="($ALIGNERS_HTML, $CALLERS_HTML, $ANNOTATORS_HTML)"

# HOWARD PRIORITIZATION
HOWARD_PRIORITIZATION_PARAM=$(FIRST=$(echo $HOWARD_PRIORITIZATION_REPORT,$HOWARD_PRIORITIZATION | tr "," " " | cut -d" " -f1) && echo $FIRST","$(echo $HOWARD_PRIORITIZATION_REPORT,$HOWARD_PRIORITIZATION | tr "," " " | tr " " "\n" | sort -u | grep -v "^$FIRST" | tr "\n" "," | sed s/,$//) | tr "," " ")
HOWARD_PRIORITIZATION_LIST=""
for HOWARD_P in $(echo "$HOWARD_PRIORITIZATION_PARAM" | tr " " "\n"); do
	#if (($(head -n1 $FINAL_TSV | tr "\t" "\n" | grep "^PZFlag-$HOWARD_P$" | wc -l))); then
	if (($(echo "$FINAL_VCF_PZFLAG_HEADER" | grep "^##INFO=<ID=PZFlag-$HOWARD_P," | wc -l))); then
		HOWARD_PRIORITIZATION_LIST=$HOWARD_PRIORITIZATION_LIST" "$HOWARD_P
	fi;
done;



if in_array $SECTION_ID $SECTIONS || in_array ALL $SECTIONS ; then
	(($DEBUG)) && echo "show section $SECTION_ID"

	# PLAN
	echo '<a class="btn btn-primary-outline display-4" href="#'$SECTION_ID'">'$SECTION_NAME'</a>' >> $HTMLFILE_PLAN_LINKS


	echo '

		<section class="counters1 counters cid-ru7OEFnzpz" id="'$SECTION_ID'" '$PAGE_BREAK_BEFORE'>
		<br>

			<div class="container">
				<h2 class="mbr-section-title pb-3 align-center mbr-fonts-style display-2">
					'$SECTION_NAME'</h2>
				<h3 class="mbr-section-subtitle mbr-fonts-style display-5">

					<!--Main information of results, on sequenced reads, quality of bases on all reads, total number of genes targeted, and total number of variants found-->

				</h3>

				<div class="container pt-4 mt-2">
					<div class="media-container-row">
						<div class="card p-3 align-center col-12 col-md-6 col-lg-4">
							<div class="panel-item p-3">
								<div class="card-img pb-3">
									<span class="mbr-iconfont mbri-align-center"></span>
								</div>
								<div class="card-text">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$BEFORE_TOTAL_SEQUENCES_HTML'</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">Number of sequenced reads</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										of <strong>'$BEFORE_SEQUENCE_LENGTH'</strong> bases length corresponding to <strong>'$BEFORE_TOTAL_BASES_HTML'</strong> bases sequenced in <strong>'$SEQUENCING_MODE_HTML'</strong> with <strong>'$SEQUENCING_TECHNOLOGY_HTML'</strong> technology</p>
								</div>
							</div>
						</div>


						<div class="card p-3 align-center col-12 col-md-6 col-lg-3">
							<div class="panel-item p-3">
								<div class="card-img pb-3">
									<span class="mbr-iconfont mbri-like"></span>
								</div>
								<div class="card-text">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">'$BEFORE_Q30_HTML'%</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Q30</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">Percentage of bases with <strong>quality score >30</strong> <br>(average across the whole read length)</p>
								</div>
							</div>
						</div>


						<div class="card p-3 align-center col-12 col-md-6 col-lg-3">
							<div class="panel-item p-3">
								<div class="card-img pb-3">
									<span class="mbr-iconfont mbri-menu"></span>
								</div>
								<div class="card-text">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$GENES_NUMBER'</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">Genes</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">defined in '$(echo "$GENE_PANEL_NUMBER Gene Panel"$([ $GENE_PANEL_NUMBER -gt 1 ] && echo "s"))', corresponding to <br><strong>'$GENES_BASES_HTML' bases</strong></p>
								</div>
							</div>
						</div>


						<div class="card p-3 align-center col-12 col-md-6 col-lg-3">
							<div class="panel-item p-3">
								<div class="card-img pb-3">
									<span class="mbr-iconfont mbri-bulleted-list"></span>
								</div>

								<div class="card-texts">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$VARIANT_NUMBER'</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Variants</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
											SNV, InDel, Other<br>called with '$PIPELINES_HTML'<br>'$ALIGNERS_CALLERS_ANNOTATORS_HTML'</p>
								</div>
							</div>
						</div>

					</div>
				</div>
		</div>
		</section>

	' > $HTMLFILE_SUMMARY

fi;



# SEQUENCING
##############

(($VERBOSE)) && echo "#[INFO] SEQUENCING section"


HTMLFILE_SEQUENCING=$HTMLFILE".sequencing"

SECTION_NAME="Sequencing &amp; Mapping"
SECTION_ID="sequencing_mapping"

# FILES
#FASTQCDATA="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.sequencing/metrics.fastqc.txt"
#FASTQCIMAGESDIR="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.sequencing/"$SAMPLE"_fastqc/Images"

#PER_BASE_QUALITY_FILE="$FASTQCIMAGESDIR/per_base_quality.png"
#cp $PER_BASE_QUALITY_FILE $HTMLDIR/$(basename $PER_BASE_QUALITY_FILE)
HTML_LOGO="$HTMLFOLDER/$(basename $LOGO)"
#PER_BASE_QUALITY_FILE_HTML="$HTMLFOLDER/$(basename $PER_BASE_QUALITY_FILE)"


echo '
<div class="progress1 pb-4" style="border-style: solid none none none ; border-color: rgb(20, 157, 204); border-radius: 0px;">
	<div class="title-wrap">
		<div class="progressbar-title mbr-fonts-style display-7">
			<p>
				FASTQ - Total number of sequenced reads | '$BEFORE_TOTAL_SEQUENCES_HTML'
			</p>
		</div>
		<div class="progress_value mbr-fonts-style display-7" style="color:silver">
			<span>100.00%</span>
		</div>
	</div>
	
</div>

<div style="margin-left:50px;">

	<div class="progress1 pb-4">
		<progress class="progress progress-primary" max="'$BEFORE_TOTAL_SEQUENCES'" value="'$AFTER_TOTAL_SEQUENCES'"></progress>
		<div class="title-wrap">
			<div class="progressbar-title mbr-fonts-style display-7">
				<p>
					FASTQ - Total number of sequenced reads filtered | '$AFTER_TOTAL_SEQUENCES_HTML'
				</p>
			</div>
			<div class="progress_value mbr-fonts-style display-7">
				<span>'$AFTER_TOTAL_SEQUENCES_PERCENT'%</span>
			</div>
		</div>
		
	</div>

</div>
' > $HTMLFILE_SEQUENCING.total_sequences

# <progress class="progress progress-primary" max="'$BEFORE_TOTAL_SEQUENCES'" value="'$BEFORE_TOTAL_SEQUENCES'"></progress>

# ALIGNERS

> $HTMLFILE_SEQUENCING.aligners

for ALIGNER in $ALIGNERS; do

	(($DEBUG)) && echo "ALIGNER: $ALIGNER";

	# Files
	DESIGN_FLAGSTAT="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.flagstat"
	DESIGN_VALIDATION_FLAGSTAT="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.validation.flagstat"
	DESIGN_ON_TARGET="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$SAMPLE.$ALIGNER.design.bed.on.target"
	DESIGN_OFF_TARGET="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$SAMPLE.$ALIGNER.design.bed.off.target"

	#(($DEBUG)) && cat $DESIGN_FLAGSTAT;

	# Total  reads
	ALIGNER_TOTAL_READS=$(grep "[0-9]* + [0-9]* in total (" $DESIGN_FLAGSTAT | awk 'BEGIN {total=0} {total=total+$1+$3} END {print total}')
	ALIGNER_TOTAL_READS_HTML=$(echo $ALIGNER_TOTAL_READS | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
	ALIGNER_TOTAL_READS_PERCENT="100.00"


	# Duplicates and Uniq reads
	DUPLICATES_READS=$(grep "[0-9]* + [0-9]* duplicates" $DESIGN_FLAGSTAT | awk 'BEGIN {total=0} {total=total+$1+$3} END {print total}')
	DUPLICATES_READS_HTML=$(echo $DUPLICATES_READS | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
	DUPLICATES_READS_PERCENT=$(awk 'BEGIN{printf("%.2f\n",('$DUPLICATES_READS'/'$ALIGNER_TOTAL_READS')*100)}')

	# Primary Duplicates and Uniq reads
	#PRIMARY_DUPLICATES_READS=$(grep "[0-9]* + [0-9]* primary duplicates" $DESIGN_FLAGSTAT | awk '{print $1+$3+0}')
	#PRIMARY_DUPLICATES_READS_HTML=$(echo $PRIMARY_DUPLICATES_READS | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
	#PRIMARY_DUPLICATES_READS_PERCENT=$(awk 'BEGIN{printf("%.2f\n",('$PRIMARY_DUPLICATES_READS'/'$ALIGNER_TOTAL_READS')*100)}')

	UNIQ_READS=$(echo "$TOTAL_SEQUENCES - $DUPLICATES_READS " | bc)
	UNIQ_READS_HTML=$(echo $UNIQ_READS | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
	UNIQ_READS_PERCENT=$(awk 'BEGIN{printf("%.2f\n",('$UNIQ_READS'/'$ALIGNER_TOTAL_READS')*100)}')


	# paired in sequencing reads
	PAIRED_IN_SEQUENCING_READS=$(grep "[0-9]* + [0-9]* properly paired (" $DESIGN_FLAGSTAT | awk 'BEGIN {total=0} {total=total+$1+$3} END {print total}')
	PAIRED_IN_SEQUENCING_READS_HTML=$(echo $PAIRED_IN_SEQUENCING_READS | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
	PAIRED_IN_SEQUENCING_READS_PERCENT=$(awk 'BEGIN{printf("%.2f\n",('$PAIRED_IN_SEQUENCING_READS'/'$ALIGNER_TOTAL_READS')*100)}')


	# Aligned reads
	ALIGNED_READS=$(grep "[0-9]* + [0-9]* mapped (" $DESIGN_FLAGSTAT | awk 'BEGIN {total=0} {total=total+$1+$3} END {print total}')
	ALIGNED_READS_HTML=$(echo $ALIGNED_READS | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
	ALIGNED_READS_PERCENT=$(awk 'BEGIN{printf("%.2f\n",('$ALIGNED_READS'/'$ALIGNER_TOTAL_READS')*100)}')


	# Properly paired reads
	PROPERLY_PAIRED_READS=$(grep "[0-9]* + [0-9]* properly paired (" $DESIGN_FLAGSTAT | awk 'BEGIN {total=0} {total=total+$1+$3} END {print total}')
	PROPERLY_PAIRED_READS_HTML=$(echo $PROPERLY_PAIRED_READS | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
	PROPERLY_PAIRED_READS_PERCENT=$(awk 'BEGIN{printf("%.2f\n",('$PROPERLY_PAIRED_READS'/'$ALIGNER_TOTAL_READS')*100)}')


	# Validation reads
	VALIDATION_ALIGNED_READS=$(grep "[0-9]* + [0-9]* mapped (" $DESIGN_VALIDATION_FLAGSTAT | awk 'BEGIN {total=0} {total=total+$1+$3} END {print total}')
	VALIDATION_ALIGNED_READS_HTML=$(echo $VALIDATION_ALIGNED_READS | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
	VALIDATION_ALIGNED_READS_PERCENT=$(awk 'BEGIN{printf("%.2f\n",('$VALIDATION_ALIGNED_READS'/'$ALIGNER_TOTAL_READS')*100)}')


	# Validation reads
	# VALIDATION_READS=$(grep " mapped (" $DESIGN_VALIDATION_FLAGSTAT | awk '{print $1+$3}')
	# VALIDATION_READS_HTML=$(echo $VALIDATION_READS | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
	# VALIDATION_READS_PERCENT=$(awk 'BEGIN{printf("%.2f\n",('$VALIDATION_READS'/'$ALIGNER_TOTAL_READS')*100)}')


	# On target reads
	ON_TARGET_READS=$(cat $DESIGN_ON_TARGET)
	ON_TARGET_READS_HTML=$(echo $ON_TARGET_READS | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
	ON_TARGET_READS_PERCENT=$(awk 'BEGIN{printf("%.2f\n",('$ON_TARGET_READS'/'$ALIGNER_TOTAL_READS')*100)}')

	# Off target reads
	OFF_TARGET_READS=$(cat $DESIGN_OFF_TARGET)
	OFF_TARGET_READS_HTML=$(echo $OFF_TARGET_READS | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
	OFF_TARGET_READS_PERCENT=$(awk 'BEGIN{printf("%.2f\n",('$OFF_TARGET_READS'/'$ALIGNER_TOTAL_READS')*100)}')

	ONOFF_TARGET_READS=$VALIDATION_ALIGNED_READS #$(echo "$ON_TARGET_READS + $OFF_TARGET_READS" | bc )
	ONOFF_TARGET_READS_HTML=$VALIDATION_ALIGNED_READS_HTML #$(echo $ONOFF_TARGET_READS | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
	ONOFF_TARGET_READS_PERCENT=$(awk 'BEGIN{printf("%.2f\n",('$ON_TARGET_READS'/'$ONOFF_TARGET_READS')*100)}')
	OFFON_TARGET_READS_PERCENT=$(awk 'BEGIN{printf("%.2f\n",('$OFF_TARGET_READS'/'$ONOFF_TARGET_READS')*100)}')

	echo '

		<!--
		<div class="progress2 pb-5">
			<progress class="progress progress-primary" color="red" max="'$ALIGNER_TOTAL_READS'" value="'$ALIGNER_TOTAL_READS'"></progress>
			<div class="title-wrap">
				<div class="progressbar-title mbr-fonts-style display-7">
					<p>
						BAM - '$ALIGNER' - Total reads | '$ALIGNER_TOTAL_READS_HTML'
					</p>
				</div>
				<div class="progress_value mbr-fonts-style display-7" style="color:silver">
					<span>'$ALIGNER_TOTAL_READS_PERCENT'%</span>
				</div>
			</div>
		</div>
		-->

		<div class=" pb-4" style="border-style: solid none none none ; border-color: rgb(20, 157, 204); border-radius: 0px;">
			<div class="title-wrap">
				<div class=" mbr-fonts-style display-7">
					<p>
						BAM - '$ALIGNER' - Total reads | '$ALIGNER_TOTAL_READS_HTML'
					</p>
				</div>
				<div class="progress_value mbr-fonts-style display-7" style="color:silver">
					<span>'$ALIGNER_TOTAL_READS_PERCENT'%</span>
				</div>
			</div>
		</div>

		<div style="margin-left:50px;">
		
			<div class="progress2 pb-4 red">
				<progress class="progress progress-primary" max="'$ALIGNER_TOTAL_READS'" value="'$DUPLICATES_READS'"></progress>
				<div class="title-wrap pb-1">
					<div class="progressbar-title mbr-fonts-style display-7">
						<p>
							Duplicated reads | '$DUPLICATES_READS_HTML'
						</p>
					</div>
					<div class="progress_value mbr-fonts-style display-7">
						<span>'$DUPLICATES_READS_PERCENT'%</span>
					</div>
					
				</div>				
			</div>



			<!--
			<div class="progress2 pb-4">
				<progress class="progress progress-primary" max="'$ALIGNER_TOTAL_READS'" value="'$UNIQ_READS'"></progress>
				<div class="title-wrap">
					<div class="progressbar-title mbr-fonts-style display-7">
						<p>
							Uniq reads | '$UNIQ_READS_HTML'
						</p>
					</div>
					<div class="progress_value mbr-fonts-style display-7">
						<span>'$UNIQ_READS_PERCENT'%</span>
					</div>
				</div>
			</div>
			-->

			<div class="progress3 pb-4">
				<progress class="progress progress-primary" max="'$ALIGNER_TOTAL_READS'" value="'$PAIRED_IN_SEQUENCING_READS'"></progress>
				<div class="title-wrap">
					<div class="progressbar-title mbr-fonts-style display-7">
						<p>
							Properly paired reads | '$PAIRED_IN_SEQUENCING_READS_HTML'
						</p>
					</div>
					<div class="progress_value mbr-fonts-style display-7">
						<span>'$PAIRED_IN_SEQUENCING_READS_PERCENT'%</span>
					</div>
				</div>
			</div>

			<div class="progress3 pb-4">
				<progress class="progress progress-primary" max="'$ALIGNER_TOTAL_READS'" value="'$ALIGNED_READS'"></progress>
				<div class="title-wrap">
					<div class="progressbar-title mbr-fonts-style display-7">
						<p>
							Aligned reads | '$ALIGNED_READS_HTML'
						</p>
					</div>
					<div class="progress_value mbr-fonts-style display-7">
						<span>'$ALIGNED_READS_PERCENT'%</span>
					</div>
				</div>
			</div>

			<!--
			<div class="progress3 pb-4">
				<progress class="progress progress-primary" max="'$ALIGNER_TOTAL_READS'" value="'$PROPERLY_PAIRED_READS'"></progress>
				<div class="title-wrap">
					<div class="progressbar-title mbr-fonts-style display-7">
						<p>
							Properly paired reads | '$PROPERLY_PAIRED_READS_HTML'
						</p>
					</div>
					<div class="progress_value mbr-fonts-style display-7">
						<span>'$PROPERLY_PAIRED_READS_PERCENT'%</span>
					</div>
				</div>
			</div>
			-->

			<div class="progress3 pb-4">
				<progress class="progress progress-primary" max="'$ALIGNER_TOTAL_READS'" value="'$VALIDATION_ALIGNED_READS'"></progress>
				<div class="title-wrap">
					<div class="progressbar-title mbr-fonts-style display-7">
						<p>
							Validated Aligned reads | '$VALIDATION_ALIGNED_READS_HTML'
						</p>
					</div>
					<div class="progress_value mbr-fonts-style display-7">
						<span>'$VALIDATION_ALIGNED_READS_PERCENT'%</span>
					</div>
				</div>
			</div>

			<div style="margin-left:50px;">

				<div class="progress4 pb-4">
					<progress class="progress progress-primary" max="'$ONOFF_TARGET_READS'" value="'$ON_TARGET_READS'"></progress>
					<div class="title-wrap">
						<div class="progressbar-title mbr-fonts-style display-7">
							<p>
								Validated Aligned On target reads | '$ON_TARGET_READS_HTML' 
							</p>
						</div>
						<div class="progress_value mbr-fonts-style display-7">
							<span>'$ONOFF_TARGET_READS_PERCENT'%</span>
						</div>
					</div>
					<br>
					<progress class="progress progress-primary" max="'$ONOFF_TARGET_READS'" value="'$OFF_TARGET_READS'"></progress>
					<div class="title-wrap">
						<div class="progressbar-title mbr-fonts-style display-7">
							<p>
								Validated Aligned Off target reads | '$OFF_TARGET_READS_HTML' 
							</p>
						</div>
						<div class="progress_value mbr-fonts-style display-7">
							<span>'$OFFON_TARGET_READS_PERCENT'%</span>
						</div>
					</div>
				</div>

			</div>

		</div>

	' >> $HTMLFILE_SEQUENCING.aligners


done;

if in_array $SECTION_ID $SECTIONS || in_array ALL $SECTIONS ; then
	(($DEBUG)) && echo "show section $SECTION_ID"

	# PLAN
	echo '<a class="btn btn-primary-outline display-4" href="#'$SECTION_ID'">'$SECTION_NAME'</a>' >> $HTMLFILE_PLAN_LINKS


	echo '

		<section class="progress-bars2 cid-ru7OEG5hcO" id="'$SECTION_ID'" '$PAGE_BREAK_BEFORE'>
		<br>

			<div class="container">
				<h2 class="mbr-section-title pb-3 align-center mbr-fonts-style display-2">
					'$SECTION_NAME'
				</h2>

				<p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
					Sequenced reads were mapped to <strong>'$ASSEMBLY'</strong> assembly using aligner'$( [ $(echo $ALIGNERS | wc -w) -gt 1 ] && echo "s")' <strong>'$ALIGNERS'</strong>
					'$([ "$POST_ALIGNMENT_STEPS" != "" ] && echo "<br>with post alignment steps <strong>"$POST_ALIGNMENT_STEPS"</strong>")'
					<br>
					Reads statistics were determined with Fastp (FASTQ) and SAMTools flagstat (BAM) on each aligners
					<br>
					<strong>Validated Aligned reads</strong> calculated on <a href="#BAMforvalidation" id="BAMforvalidation">BAM for validation</a>
					<br>
					'$BAM_VALIDATION_TEXT_HTML'
					<br>
					<strong>On target reads</strong> calculated on BAM for validation with Target Design 
					
				</p>

				<div class="row pt-1 mt-5">

					<!--
					<div class="col-md-6 text-elements">

						<h4 class="section-content-title pb-3 align-left mbr-fonts-style display-5">Per base quality</h4>
						<p class="section-content-text align-left mbr-fonts-style display-7">
							<img src="'$PER_BASE_QUALITY_FILE_HTML'" width=100%>
						</p>

					</div>
					-->

					<!--
					<div class="col-md-3 text-elements">

						<h4 class="section-content-title pb-3 align-left mbr-fonts-style display-5">Sequencing Quality</h4>
						<p class="section-content-text align-left mbr-fonts-style display-7">

							<div class="mbr-section-btn align-center">
								<a class="btn btn-primary-outline display-4" href="'$SEQUENCING_FASTP_HTML_HTML'">
									Fastp Sequencing Quality Report
								</a>
							</div>

						</p>

					</div>
					-->

					<div class="progress_elements col-md-12">

						<div class="mbr-section-btn align-center">
							<a class="btn btn-primary-outline display-4" href="'$SEQUENCING_FASTP_HTML_HTML'">
								Sequencing Quality Report
							</a>
						</div>

						<br>

						<!--<h4 class="section-content-title pb-3 align-left mbr-fonts-style display-5">Reads metrics</h4>-->

						'"$(cat $HTMLFILE_SEQUENCING.total_sequences)"'

						'"$(cat $HTMLFILE_SEQUENCING.aligners)"'

					</div>

				</div>



			</div>

		</section>

	' > $HTMLFILE_SEQUENCING

fi;


# DEPTH & COVERAGE
####################

(($VERBOSE)) && echo "#[INFO] DEPTH COVERAGE section"

HTMLFILE_COVERAGE=$HTMLFILE".coverage"
HTMLFILE_DEPTH=$HTMLFILE".depth"

# COLORS
PASS_COLOR_RGB="0,255,0";
WARN_COLOR_RGB="252,161,6";
FAIL_COLOR_RGB="255,0,0";
MISS_COLOR_RGB="139,0,0";
FILTERED_COLOR_RGB="252,161,6";

# FLAGS
PASS_FLAG_ICON='class="mbr-iconfont mbri-smile-face" style="color: rgb('$PASS_COLOR_RGB'); fill: rgb('$PASS_COLOR_RGB');"'
WARN_FLAG_ICON='class="mbr-iconfont mbri-sad-face" style="color: rgb('$WARN_COLOR_RGB'); fill: rgb('$WARN_COLOR_RGB');"'
FAIL_FLAG_ICON='class="mbr-iconfont mbri-sad-face" style="color: rgb('$FAIL_COLOR_RGB'); fill: rgb('$FAIL_COLOR_RGB');"'
#MISS_FLAG_ICON='class="mbr-iconfont mbri-sad-face" style="color: rgb('$MISS_COLOR_RGB'); fill: rgb('$MISS_COLOR_RGB'); font-weight:bold"'
MISS_FLAG_ICON='class="mbr-iconfont mbri-sad-face" style="color: rgb('$MISS_COLOR_RGB'); fill: rgb('$MISS_COLOR_RGB');"'
FILTERED_FLAG_ICON='class="mbr-iconfont mbri-sad-face" style="color: rgb('$FILTERED_COLOR_RGB'); fill: rgb('$FILTERED_COLOR_RGB');"'

#SPECIAL_VALUE_COLOR
SPECIAL_VALUE_COLOR="PASS=rgb($PASS_COLOR_RGB)|WARN=rgb($WARN_COLOR_RGB)|FAIL=rgb($FAIL_COLOR_RGB)|MISS=rgb($MISS_COLOR_RGB)|FILTERED=rgb($FILTERED_COLOR_RGB)"


# FILES
HTMLFILE_COVERAGE_ALIGNERS=$HTMLFILE".coverage.aligners"
HTMLFILE_DEPTH_ALIGNERS=$HTMLFILE".depth.aligners"


DEPTH_GENES_PANEL_NUM=0
COVERAGE_GENES_PANEL_NUM=0

for ALIGNER in $ALIGNERS; do

	(($DEBUG)) && echo "ALIGNER: $ALIGNER";

	# FILES
	#LIST_GENES_PANEL="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.list.genes"
	#TARGET_DESIGN_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.design.bed"
	TARGET_DESIGN_NAME="$SAMPLE.$ALIGNER.design.bed"
	AMPLICON_DESIGN_NAME="$SAMPLE.manifest"

	#for GENES_PANEL in $TARGET_DESIGN_NAME $(cat $LIST_GENES_PANEL); do
	for GENES_PANEL in $AMPLICON_DESIGN_NAME $TARGET_DESIGN_NAME $(cat $LIST_GENES_PANEL_BASENAME); do


		# FILES
		GENES_PANEL_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$GENES_PANEL"
		#GENES_PANEL_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$GENES_PANEL"
		if [ ! -s $GENES_PANEL_FILE ]; then GENES_PANEL_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$GENES_PANEL"; fi;



		if [ "$GENES_PANEL" == "$TARGET_DESIGN_NAME" ]; then
			GENES_PANEL_NAME="Target Design"
			GENE_PANEL_NAME_HTML="$GENES_PANEL_NAME"
			GENE_PANEL_TYPE_HTML="Target<br>Design"
			GENE_PANEL_TYPE_NAME_HTML="Target"
			GENE_PANEL_TYPE_TYPE_HTML="Design"
		elif [ "$GENES_PANEL" == "$AMPLICON_DESIGN_NAME" ]; then
			GENES_PANEL_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$TARGET_DESIGN_NAME"
			GENES_PANEL_NAME="Amplicon Design"
			GENE_PANEL_NAME_HTML="$GENES_PANEL_NAME"
			GENE_PANEL_TYPE_HTML="Amplicon<br>Design"
			GENE_PANEL_TYPE_NAME_HTML="Amplicon"
			GENE_PANEL_TYPE_TYPE_HTML="Design"
			AMPLICON_TEXT_HTML="<br>Amplicon depth metrics generated with CAP"
		else
			GENES_PANEL_NAME=$(echo $GENES_PANEL | sed "s/^$SAMPLE.//" | sed "s/.genes$//")
			GENE_PANEL_NAME_HTML="Gene Panel<br>$GENES_PANEL_NAME"
			GENE_PANEL_TYPE_HTML="Gene<br>Panel"
			GENE_PANEL_TYPE_NAME_HTML="Gene"
			GENE_PANEL_TYPE_TYPE_HTML="Panel"
		fi;

		if [ "$GENES_PANEL" == "$AMPLICON_DESIGN_NAME" ]; then
			DEPTH_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.HsMetrics.per_amplicon_coverage.flags"
		else
			DEPTH_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.HsMetrics.per_target_coverage.flags"
		fi;


		### DEPTH ###
		#############


		if [ -s $DEPTH_FILE ]; then

			((DEPTH_GENES_PANEL_NUM++))


			### GENES PANEL INFO

			# Number of amplicons/genes
			GENES_PANEL_GENES_NUMBER=$(tail $DEPTH_FILE -n +2 | awk -F"\t" '
			{
				split($5,names,"|")
				for (j in names) {
					print names[j]"\t"$6"\t"$7
				};
			}
			' | cut -f1 | sort -u | wc -l)
			#GENES_PANEL_GENES_NUMBER=$(cat $GENES_PANEL_FILE 2>/dev/null | grep -v "^#" | grep -v "^@" | cut -f5 | sort -u | wc -l)
			GENES_PANEL_GENES_NUMBER_HTML=$(echo $GENES_PANEL_GENES_NUMBER | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')

			# Number of regions
			GENES_PANEL_REGIONS_NUMBER=$(cat $GENES_PANEL_FILE 2>/dev/null | grep -v "^#" | grep -v "^@" | wc -l)
			GENES_PANEL_REGIONS_NUMBER_HTML=$(echo $GENES_PANEL_REGIONS_NUMBER | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
			[ "$GENES_PANEL" == "$TARGET_DESIGN_NAME" ] && GENES_PANEL_GENES_NUMBER=$GENES_PANEL_REGIONS_NUMBER && GENES_PANEL_GENES_NUMBER_HTML=$GENES_PANEL_REGIONS_NUMBER_HTML

			# Number of bases
			GENES_PANEL_BASES_NUMBER=$($BEDTOOLS sort -i $GENES_PANEL_FILE 2>/dev/null | $BEDTOOLS merge -i - > $REPORTDIR/merge_genes.bed; $BEDTOOLS coverage -a $REPORTDIR/merge_genes.bed  -b $REPORTDIR/merge_genes.bed | awk -F '\t' 'BEGIN{sum = 0} {sum += $6} END {print sum}'; rm $REPORTDIR/merge_genes.bed; )
			GENES_PANEL_BASES_NUMBER_HTML=$(echo $GENES_PANEL_BASES_NUMBER | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')

			# Aligner
			GENES_PANEL_ALIGNER=$ALIGNER
			GENES_PANEL_ALIGNER_HTML=$GENES_PANEL_ALIGNER


			(($DEBUG)) && echo "GENES_PANEL: $GENES_PANEL";
			(($DEBUG)) && echo "GENES_PANEL_NAME: $GENES_PANEL_NAME";
			(($DEBUG)) && echo "DEPTH_GENES_PANEL_NUM: "$DEPTH_GENES_PANEL_NUM


			# DEPTH_AVERAGE_DEPTH
			DEPTH_AVERAGE_DEPTH=$(tail -n +1 $DEPTH_FILE | awk -F"\t" '
				BEGIN {
					sum_bases=0
					sum_depth=0
				}
				{
					sum_bases+=$4
					sum_depth+=($4*$9)
					# The script should NOT print out a value for each line
				}
				# The END block is processed after the last line is read
				END {
					# NR is a variable equal to the number of rows in the file
					printf("%.0f\n",sum_depth/sum_bases)
					# Change this to print the Average instead of just the number of rows
				}' )


			if (( $(echo "$DEPTH_AVERAGE_DEPTH < $MINIMUM_DEPTH" | bc -l) )); then
				DEPTH_AVERAGE_DEPTH_FLAG=$WARN_FLAG_ICON
			elif (( $(echo "$DEPTH_AVERAGE_DEPTH < $EXPECTED_DEPTH" | bc -l) )); then
				DEPTH_AVERAGE_DEPTH_FLAG=$WARN_FLAG_ICON
			else
				DEPTH_AVERAGE_DEPTH_FLAG=$PASS_FLAG_ICON
			fi;


			# DEPTH FILE SPLIT
			DEPTH_FILE_SPLIT=$HTMLFILE_DEPTH_ALIGNERS".DEPTH_FILE.split"
			cat $DEPTH_FILE | awk -F"\t" '
			{
				split($5,names,"|")
				for (j in names) {
					print names[j]"\t"$6"\t"$7
				};
			}
			' > $DEPTH_FILE_SPLIT
			#cat $DEPTH_FILE_SPLIT

			# MIN
			DEPTH_MISS_MINIMUM_DEPTH_NUMBER=$(cat $DEPTH_FILE_SPLIT | awk -F"\t" 'BEGIN {num=0} {if ($3=="MISS") {gene[$1]+=1}} END {for (i in gene ) {num++}; print num}')
			(( $DEPTH_MISS_MINIMUM_DEPTH_NUMBER )) && DEPTH_MISS_MINIMUM_DEPTH_NUMBER_FLAG=$WARN_FLAG_ICON || DEPTH_MISS_MINIMUM_DEPTH_NUMBER_FLAG=$PASS_FLAG_ICON
			#DEPTH_FAIL_MINIMUM_DEPTH_NUMBER=$(cat $DEPTH_FILE_SPLIT | awk -F"\t" 'BEGIN {num='$DEPTH_MISS_MINIMUM_DEPTH_NUMBER'} {if ($3=="FAIL") {gene[$1]+=1}} END {for (i in gene ) {num++}; print num}')
			DEPTH_FAIL_MINIMUM_DEPTH_NUMBER=$(cat $DEPTH_FILE_SPLIT | awk -F"\t" 'BEGIN {num=0} {if ($3=="FAIL" || $3=="MISS") {gene[$1]+=1}} END {for (i in gene ) {num++}; print num}')
			(( $DEPTH_FAIL_MINIMUM_DEPTH_NUMBER )) && DEPTH_FAIL_MINIMUM_DEPTH_NUMBER_FLAG=$FAIL_FLAG_ICON || DEPTH_FAIL_MINIMUM_DEPTH_NUMBER_FLAG=$PASS_FLAG_ICON
			DEPTH_WARN_MINIMUM_DEPTH_NUMBER=$(cat $DEPTH_FILE_SPLIT | awk -F"\t" 'BEGIN {num=0} {if ($3=="WARN") {gene[$1]+=1}} END {for (i in gene ) {num++}; print num}')
			(( $DEPTH_WARN_MINIMUM_DEPTH_NUMBER )) && DEPTH_WARN_MINIMUM_DEPTH_NUMBER_FLAG=$WARN_FLAG_ICON || DEPTH_WARN_MINIMUM_DEPTH_NUMBER_FLAG=$PASS_FLAG_ICON
			#DEPTH_MISS_MINIMUM_DEPTH_NUMBER=$(cat $DEPTH_FILE | awk -F"\t" 'BEGIN {num=0} {if ($7=="MISS") {num++}} END {print num}')

			(($DEPTH_MISS_MINIMUM_DEPTH_NUMBER)) && DEPTH_MISS_MINIMUM_DEPTH_NUMBER_HTML="<br><span '$FAIL_FLAG_ICON'>including $DEPTH_MISS_MINIMUM_DEPTH_NUMBER $GENE_PANEL_TYPE_NAME_HTML(s)<br>not sequenced (0X) partially</span>" || DEPTH_MISS_MINIMUM_DEPTH_NUMBER_HTML=""


			# AVERAGE
			DEPTH_MISS_AVERAGE_DEPTH_NUMBER=$(cat $DEPTH_FILE_SPLIT | awk -F"\t" 'BEGIN {num=0} {if ($2=="MISS") {gene[$1]+=1}} END {for (i in gene ) {num++}; print num}')
			(( $DEPTH_MISS_AVERAGE_DEPTH_NUMBER )) && DEPTH_MISS_AVERAGE_DEPTH_NUMBER_FLAG=$WARN_FLAG_ICON || DEPTH_MISS_AVERAGE_DEPTH_NUMBER_FLAG=$PASS_FLAG_ICON
			#DEPTH_FAIL_AVERAGE_DEPTH_NUMBER=$(cat $DEPTH_FILE_SPLIT | awk -F"\t" 'BEGIN {num='$DEPTH_MISS_AVERAGE_DEPTH_NUMBER'} {if ($2=="FAIL") {gene[$1]+=1}} END {for (i in gene ) {num++}; print num}')
			DEPTH_FAIL_AVERAGE_DEPTH_NUMBER=$(cat $DEPTH_FILE_SPLIT | awk -F"\t" 'BEGIN {num=0} {if ($2=="FAIL" || $2=="MISS") {gene[$1]+=1}} END {for (i in gene ) {num++}; print num}')
			(( $DEPTH_FAIL_AVERAGE_DEPTH_NUMBER )) && DEPTH_FAIL_AVERAGE_DEPTH_NUMBER_FLAG=$FAIL_FLAG_ICON || DEPTH_FAIL_AVERAGE_DEPTH_NUMBER_FLAG=$PASS_FLAG_ICON
			DEPTH_WARN_AVERAGE_DEPTH_NUMBER=$(cat $DEPTH_FILE_SPLIT | awk -F"\t" 'BEGIN {num=0} {if ($2=="WARN") {gene[$1]+=1}} END {for (i in gene ) {num++}; print num}')
			(( $DEPTH_WARN_AVERAGE_DEPTH_NUMBER )) && DEPTH_WARN_AVERAGE_DEPTH_NUMBER_FLAG=$WARN_FLAG_ICON || DEPTH_WARN_AVERAGE_DEPTH_NUMBER_FLAG=$PASS_FLAG_ICON

			(($DEPTH_MISS_AVERAGE_DEPTH_NUMBER)) && DEPTH_MISS_AVERAGE_DEPTH_NUMBER_HTML="<br><span '$FAIL_FLAG_ICON'>including $DEPTH_MISS_AVERAGE_DEPTH_NUMBER $GENE_PANEL_TYPE_NAME_HTML(s)<br>not sequenced (0X)</span>" || DEPTH_MISS_AVERAGE_DEPTH_NUMBER_HTML=""

			(($DEBUG)) && echo "

				DEPTH_AVERAGE_DEPTH=$DEPTH_AVERAGE_DEPTH

				DEPTH_MISS_MINIMUM_DEPTH_NUMBER=$DEPTH_MISS_MINIMUM_DEPTH_NUMBER
				DEPTH_FAIL_MINIMUM_DEPTH_NUMBER=$DEPTH_FAIL_MINIMUM_DEPTH_NUMBER
				DEPTH_WARN_MINIMUM_DEPTH_NUMBER=$DEPTH_WARN_MINIMUM_DEPTH_NUMBER

				DEPTH_MISS_AVERAGE_DEPTH_NUMBER=$DEPTH_MISS_AVERAGE_DEPTH_NUMBER
				DEPTH_FAIL_AVERAGE_DEPTH_NUMBER=$DEPTH_FAIL_AVERAGE_DEPTH_NUMBER
				DEPTH_WARN_AVERAGE_DEPTH_NUMBER=$DEPTH_WARN_AVERAGE_DEPTH_NUMBER

			"

			# BREAK
			(( $(echo "$DEPTH_GENES_PANEL_NUM >= 2" |bc -l) )) && GENES_PANEL_BREAK=$PAGE_BREAK_BEFORE || GENES_PANEL_BREAK=""

			echo '

				<h3 class="mbr-section-subtitle mbr-fonts-style display-5" '$GENES_PANEL_BREAK'>
				<br>
					'$GENE_PANEL_NAME_HTML'
					<p class="mbr-content-text mbr-fonts-style display-7">
					</p>
				</h3>
				
				

				<div class="container pt-4 mt-2">
					<div class="media-container-row">

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span class="mbr-iconfont mbri-info"></span>
								</div>

								<div class="card-text">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$GENES_PANEL_GENES_NUMBER_HTML'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										'$GENE_PANEL_TYPE_HTML'
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										'$GENES_PANEL_BASES_NUMBER_HTML' bases
										<br>
										'$GENES_PANEL_REGIONS_NUMBER_HTML' regions
										<br>
										'$GENES_PANEL_ALIGNER_HTML' aligner
									</p>
								</div>
							</div>
						</div>

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span '$DEPTH_AVERAGE_DEPTH_FLAG'></span>
								</div>

								<div class="card-text">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$DEPTH_AVERAGE_DEPTH'X
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Whole '$GENE_PANEL_TYPE_TYPE_HTML'
										<br>
										Average Depth
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										depth of
										<br>
										all merged regions
										<br>
										in the '$GENE_PANEL_TYPE_TYPE_HTML'
									</p>
								</div>
							</div>
						</div>

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span '$DEPTH_FAIL_AVERAGE_DEPTH_NUMBER_FLAG'></span>
								</div>

								<div class="card-texts">
									 <h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$DEPTH_FAIL_AVERAGE_DEPTH_NUMBER'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Failed '$GENE_PANEL_TYPE_NAME_HTML'
										<br>
										Average Depth
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										# of '$GENE_PANEL_TYPE_NAME_HTML' with average depth
										<br>
										0X - '$MINIMUM_DEPTH'X
										'$DEPTH_MISS_AVERAGE_DEPTH_NUMBER_HTML'
									</p>
								</div>
							</div>
						</div>

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span '$DEPTH_WARN_AVERAGE_DEPTH_NUMBER_FLAG'></span>
								</div>
								<div class="card-text">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$DEPTH_WARN_AVERAGE_DEPTH_NUMBER'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Warning '$GENE_PANEL_TYPE_NAME_HTML'
										<br>
										Average Depth
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										# of '$GENE_PANEL_TYPE_NAME_HTML' with average depth
										<br>
										'$MINIMUM_DEPTH'X - '$EXPECTED_DEPTH'X
									</p>
								</div>
							</div>
						</div>

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span '$DEPTH_FAIL_MINIMUM_DEPTH_NUMBER_FLAG'></span>
								</div>

								<div class="card-texts">
									 <h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$DEPTH_FAIL_MINIMUM_DEPTH_NUMBER'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Failed '$GENE_PANEL_TYPE_NAME_HTML'
										<br>
										Minimum Depth
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										# of '$GENE_PANEL_TYPE_NAME_HTML' with minimum depth
										<br>
										0X - '$MINIMUM_DEPTH'X
										'$DEPTH_MISS_MINIMUM_DEPTH_NUMBER_HTML'
									</p>
								</div>
							</div>
						</div>

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span '$DEPTH_WARN_MINIMUM_DEPTH_NUMBER_FLAG'></span>
								</div>
								<div class="card-text">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$DEPTH_WARN_MINIMUM_DEPTH_NUMBER'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Warning '$GENE_PANEL_TYPE_NAME_HTML'
										<br>
										Minimum Depth
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										# of '$GENE_PANEL_TYPE_NAME_HTML' with minimum depth
										<br>
										'$MINIMUM_DEPTH'X - '$EXPECTED_DEPTH'X
									</p>
								</div>
							</div>
						</div>

					</div>
				</div>

			' >> $HTMLFILE_DEPTH_ALIGNERS

		else

			(($VERBOSE)) && echo "#[WARNING] DEPTH file '$DEPTH_FILE' not found or empty"

		fi;


		### COVERAGE ###
		################

		#GENES_PANEL_GENES_MSG="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.genes.msg"
		GENES_PANEL_GENES_TXT="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.genes.txt"
		GENES_PANEL_GENES_PASS_TXT="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.genes.PASS.txt"
		GENES_PANEL_GENES_WARN_TXT="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.genes.WARN.txt"
		GENES_PANEL_GENES_FAIL_TXT="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.genes.FAIL.txt"
		GENES_PANEL_GENES_FAIL_WARN_TXT="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.genes.FAIL.WARN.txt"
		GENES_PANEL_GENES_MISS_TXT="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.genes.MISS.txt"
		GENES_PANEL_DEPTHBED_COVS="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.coverage"
		GENES_PANEL_ON_TARGET="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.on.target"
		GENES_PANEL_OFF_TARGET="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.off.target"

		#if [ -s $GENES_PANEL_FILE ]; then
		if [ -e $GENES_PANEL_GENES_TXT ] \
			&& [ -e $GENES_PANEL_GENES_PASS_TXT ] \
			&& [ -e $GENES_PANEL_GENES_WARN_TXT ] \
			&& [ -e $GENES_PANEL_GENES_FAIL_TXT ] \
			&& [ -e $GENES_PANEL_GENES_FAIL_WARN_TXT ] \
			&& [ -e $GENES_PANEL_DEPTHBED_COVS ] \
			; then

			((COVERAGE_GENES_PANEL_NUM++))

			# ON OFF TARGET


			# On target
			if [ "$GENES_PANEL_ON_TARGET" != "" ] && [ -s $GENES_PANEL_ON_TARGET ] \
				&& [ "$GENES_PANEL_OFF_TARGET" != "" ] && [ -s $GENES_PANEL_OFF_TARGET ] \
			; then
				GENES_PANEL_ON_TARGET_VALUE=$(cat $GENES_PANEL_ON_TARGET)
				GENES_PANEL_OFF_TARGET_VALUE=$(cat $GENES_PANEL_OFF_TARGET)
				GENES_PANEL_ONOFF_TARGET_VALUE=$(echo "$GENES_PANEL_ON_TARGET_VALUE+$GENES_PANEL_OFF_TARGET_VALUE+0" | bc)
				GENES_PANEL_ON_TARGET_PERCENT=$(echo "scale=2; $GENES_PANEL_ON_TARGET_VALUE/$GENES_PANEL_ONOFF_TARGET_VALUE" | bc)
				GENES_PANEL_OFF_TARGET_PERCENT=$(echo "scale=2; $GENES_PANEL_OFF_TARGET_VALUE/$GENES_PANEL_ONOFF_TARGET_VALUE" | bc)
				if [ $GENES_PANEL_ON_TARGET_VALUE == "0" ]; then
					GENES_PANEL_ON_TARGET_PERCENT="0%"
				else
					GENES_PANEL_ON_TARGET_PERCENT=$(awk 'BEGIN{printf("%.2f\n",('$GENES_PANEL_ON_TARGET_VALUE'/'$GENES_PANEL_ONOFF_TARGET_VALUE')*100)}')"%"
				fi;
				if [ $GENES_PANEL_OFF_TARGET_VALUE == "0" ]; then
					GENES_PANEL_OFF_TARGET_PERCENT="0%"
				else
					GENES_PANEL_OFF_TARGET_PERCENT=$(awk 'BEGIN{printf("%.2f\n",('$GENES_PANEL_OFF_TARGET_VALUE'/'$GENES_PANEL_ONOFF_TARGET_VALUE')*100)}')"%"
				fi;
				#echo "$GENES_PANEL_ON_TARGET_VALUE / $GENES_PANEL_OFF_TARGET_VALUE / $GENES_PANEL_ONOFF_TARGET_VALUE / $GENES_PANEL_ON_TARGET_PERCENT / $GENES_PANEL_OFF_TARGET_PERCENT";
				GENES_PANEL_ONOFF_TARGET_HTML_FULL='
					'$GENES_PANEL_ON_TARGET_PERCENT' On target reads ['$GENES_PANEL_ON_TARGET_VALUE'/'$GENES_PANEL_ONOFF_TARGET_VALUE']
					<br>
					'$GENES_PANEL_OFF_TARGET_PERCENT' Off target reads ['$GENES_PANEL_OFF_TARGET_VALUE'/'$GENES_PANEL_ONOFF_TARGET_VALUE']
				';
				GENES_PANEL_ONOFF_TARGET_HTML_SIMPLE='
					'$GENES_PANEL_ON_TARGET_PERCENT' On target reads
				';
				GENES_PANEL_ONOFF_TARGET_HTML=$GENES_PANEL_ONOFF_TARGET_HTML_SIMPLE;
			else
				GENES_PANEL_ONOFF_TARGET_HTML='';
			fi;


			# GENES PANEL SEQUENCING PANEL COVERAGE
			GENES_PANEL_SEQUENCING_PANEL_COVERAGE=$( echo "scale=50; "$(echo $(grep "^"$SEQUENCING_DEPTH"X" $GENES_PANEL_DEPTHBED_COVS | cut -f4) | sed -E 's/([+-]?[0-9.]+)[eE]\+?(-?)([0-9]+)/(\1*10^\2\3)/g') | bc)
			[ "$GENES_PANEL_SEQUENCING_PANEL_COVERAGE" == "" ] && GENES_PANEL_SEQUENCING_PANEL_COVERAGE=0
			GENES_PANEL_SEQUENCING_PANEL_COVERAGE_HTML=$(awk 'BEGIN{printf("%.1f\n",'$GENES_PANEL_SEQUENCING_PANEL_COVERAGE'*100)}')"%"
			#GENES_PANEL_SEQUENCING_PANEL_COVERAGE_MESSAGE="$GENES_PANEL_SEQUENCING_PANEL_COVERAGE"
			[ $GENES_PANEL_SEQUENCING_PANEL_COVERAGE_HTML == "100.0%" ] && GENES_PANEL_SEQUENCING_PANEL_COVERAGE_HTML="100%"
			(( $(echo "$GENES_PANEL_SEQUENCING_PANEL_COVERAGE >= $SEQUENCING_COVERAGE_THRESHOLD" | bc -l) )) && GENES_PANEL_SEQUENCING_PANEL_COVERAGE_FLAG=$PASS_FLAG_ICON || GENES_PANEL_SEQUENCING_PANEL_COVERAGE_FLAG=$FAIL_FLAG_ICON

			# GENES PANEL MINIMUM PANEL COVERAGE
			GENES_PANEL_MINIMUM_PANEL_COVERAGE=$( echo "scale=50; "$(echo $(grep "^"$MINIMUM_DEPTH"X" $GENES_PANEL_DEPTHBED_COVS | cut -f4) | sed -E 's/([+-]?[0-9.]+)[eE]\+?(-?)([0-9]+)/(\1*10^\2\3)/g') | bc)
			[ "$GENES_PANEL_MINIMUM_PANEL_COVERAGE" == "" ] && GENES_PANEL_MINIMUM_PANEL_COVERAGE=0
			GENES_PANEL_MINIMUM_PANEL_COVERAGE_HTML=$(awk 'BEGIN{printf("%.1f\n",'$GENES_PANEL_MINIMUM_PANEL_COVERAGE'*100)}')"%"
			#GENES_PANEL_MINIMUM_PANEL_COVERAGE_MESSAGE="$GENES_PANEL_MINIMUM_PANEL_COVERAGE"
			[ $GENES_PANEL_MINIMUM_PANEL_COVERAGE_HTML == "100.0%" ] && GENES_PANEL_MINIMUM_PANEL_COVERAGE_HTML="100%"
			(( $(echo "$GENES_PANEL_MINIMUM_PANEL_COVERAGE >= $DEPTH_COVERAGE_THRESHOLD" |bc -l) )) && GENES_PANEL_MINIMUM_PANEL_COVERAGE_FLAG=$PASS_FLAG_ICON || GENES_PANEL_MINIMUM_PANEL_COVERAGE_FLAG=$FAIL_FLAG_ICON

			# GENES PANEL EXPECTED PANEL COVERAGE
			GENES_PANEL_EXPECTED_PANEL_COVERAGE=$( echo "scale=50; "$(echo $(grep "^"$EXPECTED_DEPTH"X" $GENES_PANEL_DEPTHBED_COVS | cut -f4) | sed -E 's/([+-]?[0-9.]+)[eE]\+?(-?)([0-9]+)/(\1*10^\2\3)/g') | bc)
			[ "$GENES_PANEL_EXPECTED_PANEL_COVERAGE" == "" ] && GENES_PANEL_EXPECTED_PANEL_COVERAGE=0
			GENES_PANEL_EXPECTED_PANEL_COVERAGE_HTML=$(awk 'BEGIN{printf("%.1f\n",'$GENES_PANEL_EXPECTED_PANEL_COVERAGE'*100)}')"%"
			#GENES_PANEL_EXPECTED_PANEL_COVERAGE_MESSAGE="$GENES_PANEL_EXPECTED_PANEL_COVERAGE"
			[ $GENES_PANEL_EXPECTED_PANEL_COVERAGE_HTML == "100.0%" ] && GENES_PANEL_EXPECTED_PANEL_COVERAGE_HTML="100%"
			(( $(echo "$GENES_PANEL_EXPECTED_PANEL_COVERAGE >= $DEPTH_COVERAGE_THRESHOLD" |bc -l) )) && GENES_PANEL_EXPECTED_PANEL_COVERAGE_FLAG=$PASS_FLAG_ICON || GENES_PANEL_EXPECTED_PANEL_COVERAGE_FLAG=$WARN_FLAG_ICON

			# GENES PANEL MISS GENES COVERAGE
			GENES_PANEL_MISS_REGIONS_NUMBER=$(cat $GENES_PANEL_GENES_MISS_TXT | grep -v "^#" -c)
			#GENES_PANEL_ALL_GENES_NUMBER_HTML=$GENES_PANEL_ALL_GENES_NUMBER
			#GENES_PANEL_MISS_REGIONS_NUMBER=$(echo "$GENES_PANEL_GENES_NUMBER - $GENES_PANEL_ALL_GENES_NUMBER" | bc)
			#! (($GENES_PANEL_GENES_NUMBER)) && GENES_PANEL_MISS_REGIONS_NUMBER=0;
			GENES_PANEL_MISS_REGIONS_NUMBER_HTML=""
			(($GENES_PANEL_MISS_REGIONS_NUMBER)) && GENES_PANEL_MISS_REGIONS_NUMBER_HTML="<br><span '$FAIL_FLAG_ICON'>including $GENES_PANEL_MISS_REGIONS_NUMBER missing $GENE_PANEL_TYPE_NAME_HTML(s) (0X)</span>"

			#GENES_PANEL_FAIL_GENES_NUMBER_MESSAGE="$GENES_PANEL_FAIL_GENES_NUMBER"
			#(( $GENES_PANEL_FAIL_GENES_NUMBER )) && GENES_PANEL_FAIL_GENES_NUMBER_FLAG=$FAIL_FLAG_ICON || GENES_PANEL_FAIL_GENES_NUMBER_FLAG=$PASS_FLAG_ICON

			# GENES PANEL FAIL GENES COVERAGE
			#GENES_PANEL_FAIL_GENES_NUMBER=$(cat $GENES_PANEL_GENES_MSG | cut -f2 | grep "^FAIL$" -c)
			#GENES_PANEL_FAIL_GENES_NUMBER=$(echo $(cat $GENES_PANEL_GENES_FAIL_TXT | grep -v "^#" -c)" + "$GENES_PANEL_MISS_REGIONS_NUMBER | bc)
			GENES_PANEL_FAIL_GENES_NUMBER=$(cat $GENES_PANEL_GENES_FAIL_TXT $GENES_PANEL_GENES_MISS_TXT | grep -v "^#" -c)
			GENES_PANEL_FAIL_GENES_NUMBER_HTML=$GENES_PANEL_FAIL_GENES_NUMBER
			#GENES_PANEL_FAIL_GENES_NUMBER_MESSAGE="$GENES_PANEL_FAIL_GENES_NUMBER"
			(( $GENES_PANEL_FAIL_GENES_NUMBER )) && GENES_PANEL_FAIL_GENES_NUMBER_FLAG=$FAIL_FLAG_ICON || GENES_PANEL_FAIL_GENES_NUMBER_FLAG=$PASS_FLAG_ICON


			# GENES PANEL WARN GENES COVERAGE
			#GENES_PANEL_WARN_GENES_NUMBER=$(cat $GENES_PANEL_GENES_MSG | cut -f2 | grep "^WARN$" -c)
			#GENES_PANEL_WARN_GENES_NUMBER=$(cat $GENES_PANEL_GENES_MSG | cut -f2 | grep -e "^WARN$" -e "^FAIL$" -c) #
			#GENES_PANEL_WARN_GENES_NUMBER=$(echo $(cat $GENES_PANEL_GENES_FAIL_WARN_TXT | grep -v "^#" -c)" + "$GENES_PANEL_MISS_REGIONS_NUMBER | bc)
			GENES_PANEL_WARN_GENES_NUMBER=$(cat $GENES_PANEL_GENES_WARN_TXT | grep -v "^#" -c)
			GENES_PANEL_WARN_GENES_NUMBER_HTML=$GENES_PANEL_WARN_GENES_NUMBER
			#GENES_PANEL_WARN_GENES_NUMBER_MESSAGE="$GENES_PANEL_WARN_GENES_NUMBER"
			(( $GENES_PANEL_WARN_GENES_NUMBER )) && GENES_PANEL_WARN_GENES_NUMBER_FLAG=$WARN_FLAG_ICON || GENES_PANEL_WARN_GENES_NUMBER_FLAG=$PASS_FLAG_ICON

			# BREAK
			(( $(echo "$COVERAGE_GENES_PANEL_NUM >= 2" |bc -l) )) && GENES_PANEL_BREAK=$PAGE_BREAK_BEFORE || GENES_PANEL_BREAK=""


			echo '

				<h3 class="mbr-section-subtitle mbr-fonts-style display-5" '$GENES_PANEL_BREAK'>
				<br>
					'$GENE_PANEL_NAME_HTML'
					<p class="mbr-content-text mbr-fonts-style display-7">
						'$GENES_PANEL_ONOFF_TARGET_HTML'
					</p>
				</h3>

				<div class="container pt-4 mt-2">
					<div class="media-container-row">

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span class="mbr-iconfont mbri-info"></span>
								</div>

								<div class="card-text">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$GENES_PANEL_GENES_NUMBER_HTML'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										'$GENE_PANEL_TYPE_HTML'
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										'$GENES_PANEL_BASES_NUMBER_HTML' bases
										<br>
										'$GENES_PANEL_REGIONS_NUMBER_HTML' regions
										<br>
										'$GENES_PANEL_ALIGNER_HTML' aligner
									</p>
								</div>
							</div>
						</div>

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span '$GENES_PANEL_SEQUENCING_PANEL_COVERAGE_FLAG'></span>
								</div>

								<div class="card-text">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$GENES_PANEL_SEQUENCING_PANEL_COVERAGE_HTML'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Sequencing
										<br>
										'$GENE_PANEL_TYPE_TYPE_HTML' coverage
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										% of Bases sequenced
										<br>
										&ge;'$SEQUENCING_DEPTH'X
									</p>
								</div>
							</div>
						</div>

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span '$GENES_PANEL_MINIMUM_PANEL_COVERAGE_FLAG'></span>
								</div>
								<div class="card-text">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$GENES_PANEL_MINIMUM_PANEL_COVERAGE_HTML'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Minimum
										<br>
										'$GENE_PANEL_TYPE_TYPE_HTML' coverage
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										% of Bases with minimum depth
										<br>
										&ge;'$MINIMUM_DEPTH'X
									</p>
								</div>
							</div>
						</div>

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span '$GENES_PANEL_EXPECTED_PANEL_COVERAGE_FLAG'></span>
								</div>

								<div class="card-text">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$GENES_PANEL_EXPECTED_PANEL_COVERAGE_HTML'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Expected
										<br>
										'$GENE_PANEL_TYPE_TYPE_HTML' coverage
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										% of Bases with expected depth
										<br>
										&ge;'$EXPECTED_DEPTH'X
									</p>
								</div>
							</div>
						</div>

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span '$GENES_PANEL_FAIL_GENES_NUMBER_FLAG'></span>
								</div>

								<div class="card-texts">
									 <h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$GENES_PANEL_FAIL_GENES_NUMBER_HTML'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Failed
										<br>
										'$GENE_PANEL_TYPE_NAME_HTML' coverage
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										# of '$GENE_PANEL_TYPE_NAME_HTML's with failed coverage
										<br>
										0X - '$MINIMUM_DEPTH'X
										'$GENES_PANEL_MISS_REGIONS_NUMBER_HTML'
									</p>
								</div>
							</div>
						</div>

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span '$GENES_PANEL_WARN_GENES_NUMBER_FLAG'></span>
								</div>
								<div class="card-text">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$GENES_PANEL_WARN_GENES_NUMBER_HTML'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Warning
										<br>
										'$GENE_PANEL_TYPE_NAME_HTML' coverage
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										# of '$GENE_PANEL_TYPE_NAME_HTML's with warning coverage
										<br>
										'$MINIMUM_DEPTH'X - '$EXPECTED_DEPTH'X
									</p>
							</div>
						</div>

					</div>
				</div>

			' >> $HTMLFILE_COVERAGE_ALIGNERS

		fi;


	done;

done;




### DEPTH
###########

SECTION_NAME="Targets & Genes Depth"
SECTION_ID="depth"


if in_array $SECTION_ID $SECTIONS || in_array ALL $SECTIONS ; then
	(($DEBUG)) && echo "show section $SECTION_ID"

	# PLAN
	echo '<a class="btn btn-primary-outline display-4" href="#'$SECTION_ID'">'$SECTION_NAME'</a>' >> $HTMLFILE_PLAN_LINKS

	echo '

		<section class="counters1 counters cid-ru7OEH6r7i" id="'$SECTION_ID'" '$PAGE_BREAK_BEFORE'>
		<br>

			<div class="container">
				<h2 class="mbr-section-title pb-3 align-center mbr-fonts-style display-2">
					'$SECTION_NAME'
				</h2>

				<p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
					Depth metrics generated with Picard CollectHsMetrics
					'$AMPLICON_TEXT_HTML' on <a href="#BAMforvalidation">BAM for validation</a>
					<br>
					Sequencing depth <strong>'$SEQUENCING_DEPTH'X</strong>
					<br>
					Minimum depth <strong>'$MINIMUM_DEPTH'X</strong>
					<br>
					Expected depth <strong>'$EXPECTED_DEPTH'X</strong>
				</p>

				'"$(cat $HTMLFILE_DEPTH_ALIGNERS)"'



		</div>
		</section>

	' > $HTMLFILE_DEPTH

fi;


### COVERAGE
##############

SECTION_NAME="Targets & Genes Coverage"
SECTION_ID="coverage"

if in_array $SECTION_ID $SECTIONS || in_array ALL $SECTIONS ; then
	(($DEBUG)) && echo "show section $SECTION_ID"

	# PLAN
	echo '<a class="btn btn-primary-outline display-4" href="#'$SECTION_ID'">'$SECTION_NAME'</a>' >> $HTMLFILE_PLAN_LINKS

	echo '

	<section class="counters1 counters cid-ru7OEH6r7i" id="'$SECTION_ID'" '$PAGE_BREAK_BEFORE'>
	<br>

		<div class="container">
			<h2 class="mbr-section-title pb-3 align-center mbr-fonts-style display-2">
				'$SECTION_NAME'
			</h2>

			<p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
				Coverage metrics generated with Picard CollectHsMetrics on <a href="#BAMforvalidation">BAM for validation</a>
				<br>
				Sequencing coverage: depth <strong>'$SEQUENCING_DEPTH'X</strong> and threshold <strong>'$(awk 'BEGIN{printf("%.1f\n",'$SEQUENCING_COVERAGE_THRESHOLD'*100)}')'%</strong>
				<br>
				Minimum coverage: depth <strong>'$MINIMUM_DEPTH'X</strong> and threshold <strong>'$(awk 'BEGIN{printf("%.1f\n",'$DEPTH_COVERAGE_THRESHOLD'*100)}')'%</strong>
				<br>
				Expected coverage: depth <strong>'$EXPECTED_DEPTH'X</strong> and threshold <strong>'$(awk 'BEGIN{printf("%.1f\n",'$DEPTH_COVERAGE_THRESHOLD'*100)}')'%</strong>
			</p>

			'"$(cat $HTMLFILE_COVERAGE_ALIGNERS)"'



		</div>
	</section>

	' > $HTMLFILE_COVERAGE

fi;



if ((1)); then

	# VARIANT CALLING STATS
	###################

	(($VERBOSE)) && echo "#[INFO] VARIANT CALLING STATS section"

	HTMLFILE_VARIANTS_STATS=$HTMLFILE".variants.stats"

	SECTION_NAME="Variants Report"
	SECTION_ID="variant_stats"


	HTMLFILE_VARIANTS_STATS_GENES_PANEL=$HTMLFILE".variants.genes_panel"
	> $HTMLFILE_VARIANTS_STATS_GENES_PANEL


	# FILES
	#LIST_GENES_PANEL="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.list.genes"
	#TARGET_DESIGN_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.design.bed"
	TARGET_DESIGN_NAME="$SAMPLE.$ALIGNER.design.bed"


	GENES_PANEL_NUM=0

	#for GENES_PANEL in "Target Design" $(cat $LIST_GENES_PANEL); do # $LIST_GENES_PANEL_BASENAME
	for GENES_PANEL in "Target Design" $(cat $LIST_GENES_PANEL_BASENAME); do # $LIST_GENES_PANEL_BASENAME

		((GENES_PANEL_NUM++))

		if [ "$GENES_PANEL" == "Target Design" ]; then
			GENES_PANEL_NAME="Target Design"
			GENE_PANEL_NAME_HTML="$GENES_PANEL_NAME"
			GENE_PANEL_TYPE_HTML="Target<br>Regions"
			GENE_PANEL_TYPE_NAME_HTML="Region"
			GENES_PANEL_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.bed"
		else
			GENES_PANEL_NAME=$(echo $GENES_PANEL | sed "s/^$SAMPLE.//" | sed "s/.genes$//")
			GENE_PANEL_NAME_HTML="Gene Panel<br>$GENES_PANEL_NAME"
			GENE_PANEL_TYPE_HTML="Gene<br>Panel"
			GENE_PANEL_TYPE_NAME_HTML="Gene"
			GENES_PANEL_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$GENES_PANEL"
		fi;


		# FILES
		#GENES_PANEL_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$GENES_PANEL"

		# FILES
		BCFTOOLS_STATS=""
		if [ "$GENES_PANEL" == "Target Design" ]; then
			#BCFTOOLS_STATS=$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.bcftools.stats.tsv
			BCFTOOLS_STATS=$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.Design.report.bcftools.stats.tsv
		else
			#ls $RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics*$GENES_PANEL*.bcftools.stats
			#BCFTOOLS_STATS=$(ls $RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics*$GENES_PANEL*.bcftools.stats 2>/dev/null)
			BCFTOOLS_STATS=$(ls $RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.Panel.$GENES_PANEL.report.bcftools.stats.tsv 2>/dev/null)
		fi;


		if [ "$BCFTOOLS_STATS" != "" ] && [ -s $BCFTOOLS_STATS ]; then


			# COPY FILES
			# BCFTOOLS_STATS_DOWNLOAD_FILENAME=$RANDOM$RANDOM.bcftools.stats.txt.gz
			# $GZ $BCFTOOLS_STATS -c > $OUTPUT_FILES_HTMLDIR/$BCFTOOLS_STATS_DOWNLOAD_FILENAME
			# BCFTOOLS_STATS_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$BCFTOOLS_STATS_DOWNLOAD_FILENAME
			# BCFTOOLS_STATS_DOWNLOAD_FILE_HTML="<a href='$BCFTOOLS_STATS_DOWNLOAD_FILE' download>BCFTools Statistics</a>"


			# GENES PANEL INFO
			GENES_PANEL_GENES_NUMBER=$(cat $GENES_PANEL_FILE | grep -v "^#" | grep -v "^@" | cut -f4 | sort -u | wc -l)
			GENES_PANEL_GENES_NUMBER_HTML=$(echo $GENES_PANEL_GENES_NUMBER | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')

			GENES_PANEL_REGIONS_NUMBER=$(cat $GENES_PANEL_FILE | grep -v "^#" | grep -v "^@" | wc -l)
			GENES_PANEL_REGIONS_NUMBER_HTML=$(echo $GENES_PANEL_REGIONS_NUMBER | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
			[ "$GENES_PANEL" == "Target Design" ] && GENES_PANEL_GENES_NUMBER=$GENES_PANEL_REGIONS_NUMBER && GENES_PANEL_GENES_NUMBER_HTML=$GENES_PANEL_REGIONS_NUMBER_HTML


			#GENES_PANEL_BASES_NUMBER=$(cd $RESULTS_FOLDER/$ANALYSIS/$SAMPLE/; $BEDTOOLS merge -i $GENES_PANEL_FILE > $REPORTDIR/merge_genes.bed; $BEDTOOLS coverage -a $REPORTDIR/merge_genes.bed  -b $REPORTDIR/merge_genes.bed | awk -F '\t' '{sum += $6} END {print sum}'; rm $REPORTDIR/merge_genes.bed; )
			GENES_PANEL_BASES_NUMBER=$($BEDTOOLS sort -i $GENES_PANEL_FILE | $BEDTOOLS merge -i - > $REPORTDIR/merge_genes.bed; $BEDTOOLS coverage -a $REPORTDIR/merge_genes.bed  -b $REPORTDIR/merge_genes.bed | awk -F '\t' 'BEGIN{sum = 0} {sum += $6} END {print sum}'; rm $REPORTDIR/merge_genes.bed; )
			#GENES_PANEL_BASES_NUMBER=$(cat $GENES_PANEL_FILE | grep -v "^#" | grep -v "^@" | awk '{for(i=$2;i<$3;i++) print $1"\t"i}' | sort -u | wc -l)
			GENES_PANEL_BASES_NUMBER_HTML=$(echo $GENES_PANEL_BASES_NUMBER | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')

			#GENES_PANEL_ALIGNER=$ALIGNER
			#GENES_PANEL_ALIGNER_HTML=$GENES_PANEL_ALIGNER

			#echo "GENES_PANEL: "$GENES_PANEL
			#echo "BCFTOOLS_STATS: "$BCFTOOLS_STATS


			GENES_PANEL_TOTAL_VARIANT_NUMBER=$(grep "^SN	.*	number of records" $BCFTOOLS_STATS | awk -F"\t" '{print $4}')
			GENES_PANEL_TOTAL_VARIANT_LEGEND=$(grep "^#   number of records   .." $BCFTOOLS_STATS | sed "s/^#   number of records   .. //gi")

			GENES_PANEL_SNPs_VARIANT_NUMBER=$(grep "^SN	.*	number of SNPs" $BCFTOOLS_STATS | awk -F"\t" '{print $4}')
			GENES_PANEL_SNPs_VARIANT_LEGEND=$(grep "^#   number of SNPs   .." $BCFTOOLS_STATS | sed "s/^#   number of SNPs      .. //gi")

			GENES_PANEL_MNPs_VARIANT_NUMBER=$(grep "^SN	.*	number of MNPs" $BCFTOOLS_STATS | awk -F"\t" '{print $4}')
			GENES_PANEL_MNPs_VARIANT_LEGEND=$(grep "^#   number of MNPs   .." $BCFTOOLS_STATS | sed "s/^#   number of MNPs      .. //gi")

			GENES_PANEL_indels_VARIANT_NUMBER=$(grep "^SN	.*	number of indels" $BCFTOOLS_STATS | awk -F"\t" '{print $4}')
			GENES_PANEL_indels_VARIANT_LEGEND=$(grep "^#   number of indels   .." $BCFTOOLS_STATS | sed "s/^#   number of indels    .. //gi")

			GENES_PANEL_others_VARIANT_NUMBER=$(grep "^SN	.*	number of others" $BCFTOOLS_STATS | awk -F"\t" '{print $4}')
			GENES_PANEL_others_VARIANT_LEGEND=$(grep "^#   number of others   .." $BCFTOOLS_STATS -A1 | sed "s/^#   number of others    .. //gi" | sed "s/^#                          //gi"  )



			# BREAK
			(( $(echo "$GENES_PANEL_NUM >= 2" | bc -l) )) && GENES_PANEL_BREAK=$PAGE_BREAK_BEFORE || GENES_PANEL_BREAK=""

			echo '

				<h3 class="mbr-section-subtitle mbr-fonts-style display-5" '$GENES_PANEL_BREAK'>
				<br>
					'$GENE_PANEL_NAME_HTML'
				</h3>
				<p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">

				</p>

				<div class="container pt-4 mt-2">
					<div class="media-container-row">

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span class="mbr-iconfont mbri-info"></span>
								</div>

								<div class="card-text">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$GENES_PANEL_GENES_NUMBER_HTML'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										'$GENE_PANEL_TYPE_HTML'
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										'$GENES_PANEL_BASES_NUMBER_HTML' bases
										<br>
										'$GENES_PANEL_REGIONS_NUMBER_HTML' Regions

									</p>
								</div>
							</div>
						</div>

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span class="mbr-iconfont mbri-info"></span>
								</div>

								<div class="card-text">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$GENES_PANEL_TOTAL_VARIANT_NUMBER'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Total
										<br>
										Variants
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										'$GENES_PANEL_TOTAL_VARIANT_LEGEND'
									</p>
								</div>
							</div>
						</div>

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span class="mbr-iconfont mbri-info"></span>
								</div>

								<div class="card-texts">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$GENES_PANEL_SNPs_VARIANT_NUMBER'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										SNV
										<br>
										Variants
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										'$GENES_PANEL_SNPs_VARIANT_LEGEND'
									</p>
								</div>
							</div>
						</div>

						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span class="mbr-iconfont mbri-info"></span>
								</div>

								<div class="card-texts">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$GENES_PANEL_MNPs_VARIANT_NUMBER'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										MNP
										<br>
										Variants
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										'$GENES_PANEL_MNPs_VARIANT_LEGEND'
									</p>
								</div>
							</div>
						</div>


						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span class="mbr-iconfont mbri-info"></span>
								</div>

								<div class="card-texts">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$GENES_PANEL_indels_VARIANT_NUMBER'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Indel
										<br>
										Variants
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										'$GENES_PANEL_indels_VARIANT_LEGEND'
									</p>
								</div>
							</div>
						</div>


						<div class="card p-3 align-center col-12 col-md-6 col-lg-2">
							<div class="panel-item">
								<div class="card-img pb-3">
									<span class="mbr-iconfont mbri-info"></span>
								</div>

								<div class="card-texts">
									<h3 class=" pt-3 pb-3 mbr-fonts-style display-2">
										'$GENES_PANEL_others_VARIANT_NUMBER'
									</h3>
									<h4 class="mbr-content-title mbr-bold mbr-fonts-style display-7">
										Other
										<br>
										Variants
									</h4>
									<p class="mbr-content-text mbr-fonts-style display-7">
										'$GENES_PANEL_others_VARIANT_LEGEND'
									</p>
								</div>
							</div>
						</div>

						</div>
					</div>
				</div>

			' >> $HTMLFILE_VARIANTS_STATS_GENES_PANEL

		fi;

	done;

	if in_array $SECTION_ID $SECTIONS || in_array ALL $SECTIONS ; then
		(($DEBUG)) && echo "show section $SECTION_ID"

		# PLAN
		echo '<a class="btn btn-primary-outline display-4" href="#'$SECTION_ID'">'$SECTION_NAME'</a>' >> $HTMLFILE_PLAN_LINKS

		echo '

			<section class="counters1 counters cid-ru7OEH6r7i" id="'$SECTION_ID'" '$PAGE_BREAK_BEFORE'>
			<br>

				<div class="container">
					<h2 class="mbr-section-title pb-3 align-center mbr-fonts-style display-2">
						'$SECTION_NAME'
					</h2>

					<p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
						Variant statistics generated with BCFTOOLS stats from '$PIPELINES_NUMBER' pipelines
						<br>
						'$(echo $ALIGNERS_CALLERS_ANNOTATORS | sed "s/ /<br>/gi")'
						'$([ "$POST_CALLING_STEPS" != "" ] && echo "<br>with post calling steps <strong>"$POST_CALLING_STEPS"</strong>")'
						'$([ "$POST_ANNOTATION_STEPS" != "" ] && echo "<br>with post annotation steps <strong>"$POST_ANNOTATION_STEPS"</strong>")'
						'$([ "$HOWARD_PRIORITIZATION_LIST" != "" ] && echo "<br>with post prioritization <strong>"$HOWARD_PRIORITIZATION_LIST"</strong>")'
					</p>

					'"$(cat $HTMLFILE_VARIANTS_STATS_GENES_PANEL)"'



			</div>
			</section>

		' > $HTMLFILE_VARIANTS_STATS

	fi;


fi;




# PLAN
##########

(($VERBOSE)) && echo "#[INFO] PLAN section"


HTMLFILE_PLAN=$HTMLFILE".plan"


echo '
<section class="mbr-section content8 cid-ruitEAjBmu" id="content8-1z">
    <div class="container">
        <div class="media-container-row title">
            <div class="col-12 col-md-40">
                <div class="mbr-section-btn align-center">
				'$(cat $HTMLFILE_PLAN_LINKS)'
				<!--<a class="btn btn-primary-outline display-4" href="#counters1-1u">Variant Annotation</a>-->
				<a class="btn btn-primary-outline display-4" href="'$(basename $HTMLFILE_ANNEX)'">Annex</a></div>
            </div>
        </div>
    </div>
</section>
' > $HTMLFILE_PLAN




echo '
<section class="mbr-section content8 cid-ruitEAjBmu" id="content8-1z">
    <div class="container">
        <div class="media-container-row title">
            <div class="col-12 col-md-40">
                <div class="mbr-section-btn align-center">
				<a class="btn btn-primary-outline display-4" href="'$(basename $HTMLFILE)'">Report</a></div>
            </div>
        </div>
    </div>
</section>
' > $HTMLFILE_PLAN.report

echo '
<section class="mbr-section content8 cid-ruitEAjBmu" id="content8-1z">
    <div class="container">
        <div class="media-container-row title">
            <div class="col-12 col-md-40">
                <div class="mbr-section-btn align-center">
				<a class="btn btn-primary-outline display-4" href="'$(basename $HTMLFILE_ANNEX)'">Annex</a></div>
            </div>
        </div>
    </div>
</section>
' > $HTMLFILE_PLAN.annex




#########
# ANNEX #
#########



# COVERAGE
############

(($VERBOSE)) && echo "#[INFO] ANNEX DEPTH COVERAGE section"

HTMLFILE_ANNEX_COVERAGE=$HTMLFILE_ANNEX".coverage"
HTMLFILE_ANNEX_GENES_COVERAGE=$HTMLFILE_ANNEX".genes_coverage"
HTMLFILE_ANNEX_FLAGS=$HTMLFILE_ANNEX".flags"
HTMLFILE_ANNEX_DEPTH=$HTMLFILE_ANNEX".depth"
HTMLFILE_ANNEX_AMPLICON=$HTMLFILE_ANNEX".amplicon"


# FILES



# FLAGS
#PASS_FLAG_ICON='class="mbr-iconfont mbri-smile-face" style="color: rgb(0, 255, 0); fill: rgb(0, 255, 0);"'
#WARN_FLAG_ICON='class="mbr-iconfont mbri-sad-face" style="color: rgb(252, 161, 6); fill: rgb(252, 161, 6);"'
#FAIL_FLAG_ICON='class="mbr-iconfont mbri-sad-face" style="color: rgb(255, 0, 0); fill: rgb(255, 0, 0);"'


# FILES
HTMLFILE_ANNEX_GENES_PANEL_COVERAGE=$HTMLFILE_ANNEX".genes_panel_coverage"
HTMLFILE_ANNEX_GENES_PANEL_DEPTH=$HTMLFILE_ANNEX".genes_panel_depth"
HTMLFILE_ANNEX_GENES_PANEL_AMPLICON=$HTMLFILE_ANNEX".amplicon_clipping"
HTMLFILE_ANNEX_GENES_PANEL_GENES_COVERAGE=$HTMLFILE_ANNEX".genes_panel_genes_coverage"
HTMLFILE_ANNEX_GENES_PANEL_FLAGS=$HTMLFILE_ANNEX".genes_panel_flags"


# LINKS
HTMLFILE_ANNEX_PLAN_LINKS_COVERAGE=$HTMLFILE_ANNEX_PLAN_LINKS".coverage"
> $HTMLFILE_ANNEX_PLAN_LINKS_COVERAGE
HTMLFILE_ANNEX_PLAN_LINKS_GENES_COVERAGE=$HTMLFILE_ANNEX_PLAN_LINKS".genes_coverage"
> $HTMLFILE_ANNEX_PLAN_LINKS_GENES_COVERAGE
HTMLFILE_ANNEX_PLAN_LINKS_DEPTH=$HTMLFILE_ANNEX_PLAN_LINKS".depth"
> $HTMLFILE_ANNEX_PLAN_LINKS_DEPTH
HTMLFILE_ANNEX_PLAN_LINKS_GENES_FLAGS=$HTMLFILE_ANNEX_PLAN_LINKS".genes_flags"
> $HTMLFILE_ANNEX_PLAN_LINKS_GENES_FLAGS
HTMLFILE_ANNEX_PLAN_LINKS_AMPLICON=$HTMLFILE_ANNEX_PLAN_LINKS".amplicon"
> $HTMLFILE_ANNEX_PLAN_LINKS_AMPLICON


# LIMIT_STRING
LIMIT_STRING=30

# INIT
GENES_PANEL_NUM=0

for ALIGNER in $ALIGNERS; do

	(($DEBUG)) && echo "ALIGNER: $ALIGNER";


	# Global Statistics
	#####################


	ALIGNER_FLAGSTAT="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.flagstat"
	ALIGNER_IDXSTATS="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.idxstats"
	ALIGNER_VALIDATION_FLAGSTAT="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.validation.flagstat"
	ALIGNER_VALIDATION_IDXSTATS="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.validation.idxstats"

	# COPY FILES
	#ALIGNER_FLAGSTAT_DOWNLOAD_FILENAME=$(basename $ALIGNER_FLAGSTAT).gz
	ALIGNER_FLAGSTAT_DOWNLOAD_FILENAME=$RANDOM$RANDOM.flagstat.txt.gz
	$GZ $ALIGNER_FLAGSTAT -c > $OUTPUT_FILES_HTMLDIR/$ALIGNER_FLAGSTAT_DOWNLOAD_FILENAME
	ALIGNER_FLAGSTAT_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$ALIGNER_FLAGSTAT_DOWNLOAD_FILENAME
	ALIGNER_FLAGSTAT_DOWNLOAD_FILE_HTML="<a href='$ALIGNER_FLAGSTAT_DOWNLOAD_FILE' download>Full BAM Flag Statistics</a>"

	# COPY FILES
	#ALIGNER_IDXSTATS_DOWNLOAD_FILENAME=$(basename $ALIGNER_IDXSTATS).gz
	ALIGNER_IDXSTATS_DOWNLOAD_FILENAME=$RANDOM$RANDOM.idxstats.tsv.gz
	$GZ $ALIGNER_IDXSTATS -c > $OUTPUT_FILES_HTMLDIR/$ALIGNER_IDXSTATS_DOWNLOAD_FILENAME
	ALIGNER_IDXSTATS_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$ALIGNER_IDXSTATS_DOWNLOAD_FILENAME
	ALIGNER_IDXSTATS_DOWNLOAD_FILE_HTML="<a href='$ALIGNER_IDXSTATS_DOWNLOAD_FILE' download>Full BAM Index Statistics</a>"

	# COPY FILES
	#ALIGNER_VALIDATION_FLAGSTAT_DOWNLOAD_FILENAME=$(basename $ALIGNER_VALIDATION_FLAGSTAT).gz
	ALIGNER_VALIDATION_FLAGSTAT_DOWNLOAD_FILENAME=$RANDOM$RANDOM.flagstat.txt.gz
	$GZ $ALIGNER_VALIDATION_FLAGSTAT -c > $OUTPUT_FILES_HTMLDIR/$ALIGNER_VALIDATION_FLAGSTAT_DOWNLOAD_FILENAME
	ALIGNER_VALIDATION_FLAGSTAT_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$ALIGNER_VALIDATION_FLAGSTAT_DOWNLOAD_FILENAME
	ALIGNER_VALIDATION_FLAGSTAT_DOWNLOAD_FILE_HTML="<a href='$ALIGNER_VALIDATION_FLAGSTAT_DOWNLOAD_FILE' download>BAM for Validation Flag Statistics</a>"

	# COPY FILES
	#ALIGNER_VALIDATION_IDXSTATS_DOWNLOAD_FILENAME=$(basename $ALIGNER_VALIDATION_IDXSTATS).gz
	ALIGNER_VALIDATION_IDXSTATS_DOWNLOAD_FILENAME=$RANDOM$RANDOM.idxstats.tsv.gz
	$GZ $ALIGNER_VALIDATION_IDXSTATS -c > $OUTPUT_FILES_HTMLDIR/$ALIGNER_VALIDATION_IDXSTATS_DOWNLOAD_FILENAME
	ALIGNER_VALIDATION_IDXSTATS_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$ALIGNER_VALIDATION_IDXSTATS_DOWNLOAD_FILENAME
	ALIGNER_VALIDATION_IDXSTATS_DOWNLOAD_FILE_HTML="<a href='$ALIGNER_VALIDATION_IDXSTATS_DOWNLOAD_FILE' download>BAM for Validation Index Statistics</a>"



	if ((1)); then
	if [ -s $ALIGNER_FLAGSTAT ]; then

		echo '<a class="btn display-4 mbr-section-subtitle mbr-fonts-style display-6 align-center" href="#GLOBAL-STATS-'$ALIGNER'"><small>Global Statistics ('$ALIGNER')</small></a>' >> $HTMLFILE_ANNEX_PLAN_LINKS_COVERAGE


		echo '

		<section class="section-table cid-ruiBoanIwc" id="GLOBAL-STATS-'$ALIGNER'">


		  <div class="container container-table">

			  <h3 class="mbr-section-subtitle mbr-fonts-style align-center mbr-light display-5" '$GENES_PANEL_BREAK'>
			  <br>
					Global Statistics ('$ALIGNER')
			  </h3>

			  <p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
  				'$ALIGNER_FLAGSTAT_DOWNLOAD_FILE_HTML'
				<br>
				'$ALIGNER_IDXSTATS_DOWNLOAD_FILE_HTML'
				<br>
				'$ALIGNER_VALIDATION_FLAGSTAT_DOWNLOAD_FILE_HTML'
				<br>
				'$ALIGNER_VALIDATION_IDXSTATS_DOWNLOAD_FILE_HTML'
  			  </p>

			</div>

		</section>

		' >> $HTMLFILE_ANNEX_GENES_PANEL_COVERAGE
		#' >> $HTMLFILE_ANNEX_GENES_PANEL_AMPLICON
		#' >> $HTMLFILE_ANNEX_GENES_PANEL_DEPTH
		#HTMLFILE_ANNEX_GENES_PANEL_DEPTH
	fi;
	fi;



	# FILES
	#LIST_GENES_PANEL="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.list.genes"
	#TARGET_DESIGN_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.design.bed"
	TARGET_DESIGN_NAME="$SAMPLE.$ALIGNER.design.bed"

	# FILES
	GENES_PANEL_AMPLICON="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.HsMetrics.per_amplicon_coverage.flags"

	# COPY FILES
	#GENES_PANEL_AMPLICON_DOWNLOAD_FILENAME=$(basename $GENES_PANEL_AMPLICON).gz
	GENES_PANEL_AMPLICON_DOWNLOAD_FILENAME=$RANDOM$RANDOM.flags.tsv.gz
	$GZ $GENES_PANEL_AMPLICON -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_AMPLICON_DOWNLOAD_FILENAME
	GENES_PANEL_AMPLICON_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_AMPLICON_DOWNLOAD_FILENAME
	GENES_PANEL_AMPLICON_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_AMPLICON_DOWNLOAD_FILE' download>$DOWNLOAD_FILE_MSG</a>"

	# GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH

	GENES_PANEL_AMPLICON_HTML=""

	if [ -s $GENES_PANEL_AMPLICON ]; then

		GENES_PANEL_AMPLICON_NB_LINES=$(echo $(cat $GENES_PANEL_AMPLICON | wc -l)" - 1" | bc)
		#if [ "$GENES_PANEL_AMPLICON_NB_LINES" < $TABLE_LIMIT ]; then
		if (( $GENES_PANEL_AMPLICON_NB_LINES > $TABLE_LIMIT )); then
			GENES_PANEL_AMPLICON_HTML=$TABLE_LIMIT_MSG_HTML
		else
			GENES_PANEL_AMPLICON_HTML=$(cat $GENES_PANEL_AMPLICON | tr "," " " | awk -F"\t" '{print $5 "\t" $1":"$2"-"$3 "\t" $4 "\t" $7 "\t" $13 "\t" $6 "\t" $9}' | sed 's/^name/Amplicons/g' | sed 's/chrom.start.end/<span title=\"Location of Amplicons\">Location<\/span>/g' | sed 's/minimum_threshold/Flag Min Depth/g'| sed 's/average_threshold/Flag Mean Depth/g' | sed 's/min_coverage/Min Depth/g' | sed 's/mean_coverage/Mean Depth/g' | sed 's/length/<span title=\"Number of bases for Amplicons\">#Bases<\/span>/g' | $STARK_FOLDER_BIN/csv_to_html.awk -v limit_string=$LIMIT_STRING -v special_value_color="$SPECIAL_VALUE_COLOR" -v limit=$TABLE_LIMIT_CUT -v tag_row_head_plus="class='table-heads'" -v tag_col_head_plus=" class=\"head-item mbr-fonts-style display-7\"" -v tag_row_body_plus="" -v tag_col_body_plus=" class=\"body-item mbr-fonts-style display-7\"")
		fi;


		#AMPLICON_TEXT_HTML="Amplicon clipping generated with <strong>CAP</strong> and depth metrics with <strong>Picard CollectHsMetrics</strong> on all <strong>Target Design</strong>."
		AMPLICON_TEXT_HTML="<br>Amplicon depth metrics generated with <strong>CAP</strong>"
		# LINKS
		#echo '<a class="btn display-4 mbr-section-subtitle mbr-fonts-style display-6 align-center" href="#AMPLICON-'$ALIGNER'"><small>Amplicon Design ('$ALIGNER')</small></a>' >> $HTMLFILE_ANNEX_PLAN_LINKS_AMPLICON
		echo '<a class="btn display-4 mbr-section-subtitle mbr-fonts-style display-6 align-center" href="#AMPLICON-'$ALIGNER'"><small>Amplicon Design ('$ALIGNER')</small></a>' >> $HTMLFILE_ANNEX_PLAN_LINKS_DEPTH


	fi;

	#echo $GENES_PANEL_AMPLICON_HTML



	if ((1)); then
	if [ -s $GENES_PANEL_AMPLICON ]; then

		echo '

		<section class="section-table cid-ruiBoanIwc" id="AMPLICON-'$ALIGNER'">


		  <div class="container container-table">

			  <h3 class="mbr-section-subtitle mbr-fonts-style align-center mbr-light display-5" '$GENES_PANEL_BREAK'>
			  <br>
					Amplicon Design ('$ALIGNER')
			  </h3>

			  <p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
  				'$GENES_PANEL_AMPLICON_DOWNLOAD_FILE_HTML'
  			  </p>

			  <div class="table-wrapper">
				<div class="container">
				  <div class="row search">
					<div class="col-md-6"></div>
					<div class="col-md-6">
						<div class="dataTables_filter">
						  <label class="searchInfo mbr-fonts-style display-7">Search:</label>
						  <input class="form-control input-sm" disabled="">
						</div>
					</div>
				  </div>
				</div>

				<div class="container scroll">
					<table class="table isSearch" cellspacing="0">
						'$GENES_PANEL_AMPLICON_HTML'
					</table>
				</div>

				<div class="container table-info-container">
				  <div class="row info">
					<div class="col-md-6">
					  <div class="dataTables_info mbr-fonts-style display-7">
						<span class="infoBefore">Showing</span>
						<span class="inactive infoRows"></span>
						<span class="infoAfter">entries</span>
						<span class="infoFilteredBefore">(filtered from</span>
						<span class="inactive infoRows"></span>
						<span class="infoFilteredAfter"> total entries)</span>
					  </div>
					</div>
					<div class="col-md-6"></div>
				  </div>
				</div>


			  </div>
			</div>

		</section>

		' >> $HTMLFILE_ANNEX_GENES_PANEL_DEPTH
		#' >> $HTMLFILE_ANNEX_GENES_PANEL_AMPLICON
		#' >> $HTMLFILE_ANNEX_GENES_PANEL_DEPTH
		#HTMLFILE_ANNEX_GENES_PANEL_DEPTH
	fi;
	fi;


	#for GENES_PANEL in $TARGET_DESIGN_NAME $(cat $LIST_GENES_PANEL); do # LIST_GENES_PANEL_BASENAME
	for GENES_PANEL in $TARGET_DESIGN_NAME $(cat $LIST_GENES_PANEL_BASENAME); do # LIST_GENES_PANEL_BASENAME

		# FILES
		GENES_PANEL_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$GENES_PANEL"
		#GENES_PANEL_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$GENES_PANEL"
		if [ -s $GENES_PANEL_FILE ]; then GENES_PANEL_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$GENES_PANEL"; fi;

		GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.HsMetrics.per_base_coverage.gz"
		GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.HsMetrics.per_base_coverage.MISS.tsv"
		GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.HsMetrics.per_base_coverage.FAIL.tsv"
		GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.HsMetrics.per_base_coverage.WARN.tsv"
		GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.HsMetrics.per_base_coverage.PASS.tsv"
		GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.HsMetrics.per_base_coverage.bed"
		GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.coverage"
		GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.genes.txt"
		GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.report.genes.txt"
		GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.HsMetrics.per_target_coverage.flags"
		GENES_PANEL_GENES_FLAGS_PATTERN="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.bam.metrics/$SAMPLE.$ALIGNER.$GENES_PANEL.genes"
		#echo "PASS" && head $GENES_PANEL_GENES_FLAGS_PATTERN".PASS.txt"
		#echo "WARN" && head $GENES_PANEL_GENES_FLAGS_PATTERN".WARN.txt"
		#echo "FAIL" && head $GENES_PANEL_GENES_FLAGS_PATTERN".FAIL.txt"
		#echo "MISS" && head $GENES_PANEL_GENES_FLAGS_PATTERN".MISS.txt"


		if [ "$GENES_PANEL" == "$TARGET_DESIGN_NAME" ]; then
			GENES_PANEL_NAME="Target Design"
			GENE_PANEL_NAME_HTML="$GENES_PANEL_NAME"
			GENE_PANEL_TYPE_HTML="Target<br>Regions"
			GENE_PANEL_TYPE_TABLE="Targets"
		else
			GENES_PANEL_NAME=$(echo $GENES_PANEL | sed "s/^$SAMPLE.//" | sed "s/.genes$//")
			GENE_PANEL_NAME_HTML="Gene Panel<br>$GENES_PANEL_NAME"
			GENE_PANEL_TYPE_HTML="Gene<br>Panel"
			GENE_PANEL_TYPE_TABLE="Genes"
		fi;


		(($DEBUG)) && echo "GENES_PANEL: $GENES_PANEL";
		(($DEBUG)) && echo "GENES_PANEL_NAME: $GENES_PANEL_NAME";
		(($DEBUG)) && echo "GENES_PANEL_NUM: "$GENES_PANEL_NUM


		# COPY FILES

		# PER_BASE_COVERAGE MISS
		if [ ! -s $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS ]; then
			echo "#chrom	start	stop	$GENE_PANEL_TYPE_TABLE	Mean	Min	Max	Count" > $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS 
			$GZ -cd $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE | awk -v MISS=$SEQUENCING_DEPTH '($4<MISS) {print $1 "\t" $2-1 "\t" $2 "\t" $3 "\t" $4}' | $BEDTOOLS merge -c 4,5,5,5,5 -o distinct,mean,min,max,count > $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS 2>/dev/null
		fi;
		if [ -s $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS ]; then
			#GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS_DOWNLOAD_FILENAME=$(basename $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS).gz
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS_DOWNLOAD_FILENAME=$RANDOM$RANDOM.HsMetrics.per_base_coverage.MISS.tsv.gz
			$GZ $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS_DOWNLOAD_FILENAME
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS_DOWNLOAD_FILENAME
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS_DOWNLOAD_FILE' download>MISS</a>"
		else
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS_DOWNLOAD_FILE_HTML="MISS"
		fi;
		# STATS
		# echo "GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS=$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS"
		# cat $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS 
		# cat $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS | wc -l
		# cat $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS | cut -f8 | paste -sd+ | bc


		#PER_BASE_COVERAGE FAIL	
		if [ ! -s $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL ]; then
			echo "#chrom	start	stop	$GENE_PANEL_TYPE_TABLE	Mean	Min	Max	Count" > $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL 
			$GZ -cd $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE | awk -v MISS=$SEQUENCING_DEPTH -v FAIL=$MINIMUM_DEPTH '($4>=$MISS && $4<FAIL) {print $1 "\t" $2-1 "\t" $2 "\t" $3 "\t" $4}' | $BEDTOOLS merge -c 4,5,5,5,5 -o distinct,mean,min,max,count > $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL 2>/dev/null
		fi;
		if [ -s $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL ]; then
			#GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL_DOWNLOAD_FILENAME=$(basename $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL).gz
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL_DOWNLOAD_FILENAME=$RANDOM$RANDOM.HsMetrics.per_base_coverage.FAIL.tsv.gz
			$GZ $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL_DOWNLOAD_FILENAME
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL_DOWNLOAD_FILENAME
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL_DOWNLOAD_FILE' download>FAIL</a>"
		else
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL_DOWNLOAD_FILE_HTML="FAIL"
		fi;

		# PER_BASE_COVERAGE WARN
		if [ ! -s $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN ]; then
			echo "#chrom	start	stop	$GENE_PANEL_TYPE_TABLE	Mean	Min	Max	Count" > $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN
			$GZ -cd $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE | awk -v FAIL=$MINIMUM_DEPTH -v WARN=$EXPECTED_DEPTH '($4>=FAIL && $4<WARN) {print $1 "\t" $2-1 "\t" $2 "\t" $3 "\t" $4}' | $BEDTOOLS merge -c 4,5,5,5,5 -o distinct,mean,min,max,count > $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN 2>/dev/null
		fi;
		if [ -s $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN ]; then
			#GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN_DOWNLOAD_FILENAME=$(basename $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN).gz
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN_DOWNLOAD_FILENAME=$RANDOM$RANDOM.HsMetrics.per_base_coverage.WARN.tsv.gz
			$GZ $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN_DOWNLOAD_FILENAME
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN_DOWNLOAD_FILENAME
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN_DOWNLOAD_FILE' download>WARN</a>"
		else
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN_DOWNLOAD_FILE_HTML="WARN"
		fi;

		# PER_BASE_COVERAGE PASS
		if [ ! -s $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS ]; then
			echo "#chrom	start	stop	$GENE_PANEL_TYPE_TABLE	Mean	Min	Max	Count" > $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS
			$GZ -cd $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE | awk -v PASS=$EXPECTED_DEPTH '($4>=PASS) {print $1 "\t" $2-1 "\t" $2 "\t" $3 "\t" $4}' | $BEDTOOLS merge -c 4,5,5,5,5 -o distinct,mean,min,max,count > $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS 2>/dev/null
		fi;
		if [ -s $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS ]; then
			#GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS_DOWNLOAD_FILENAME=$(basename $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS).gz
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS_DOWNLOAD_FILENAME=$RANDOM$RANDOM.HsMetrics.per_base_coverage.PASS.tsv.gz
			$GZ $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS_DOWNLOAD_FILENAME
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS_DOWNLOAD_FILENAME
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS_DOWNLOAD_FILE' download>PASS</a>"
		else
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS_DOWNLOAD_FILE_HTML="PASS"
		fi;


		#GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED
		if [ ! -s $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED ] || ((1)); then
			#echo "#chrom	start	stop	$GENE_PANEL_TYPE_TABLE	Mean	Min	Max	Count" > $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS
			#$GZ -cd $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE | awk -v PASS=$EXPECTED_DEPTH '($4>=PASS) {print $1 "\t" $2-1 "\t" $2 "\t" $3 "\t" $4}' | $BEDTOOLS merge -c 4,5,5,5,5 -o distinct,mean,min,max,count > $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS 2>/dev/null
			
			$GZ -cd $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE | awk -F"\t" -v MISS=$SEQUENCING_DEPTH -v FAIL=$MINIMUM_DEPTH -v WARN=$EXPECTED_DEPTH '($4<MISS) {print $1 "\t" $2-1 "\t" $2 "\t" $3 "\t" $4 "\t'$MISS_COLOR_RGB'\t+" }' | $BEDTOOLS merge -c 4,5,7,2,3,6 -o distinct,mean,first,first,last,distinct >> $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED.tmp 2>/dev/null
			$GZ -cd $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE | awk -F"\t" -v MISS=$SEQUENCING_DEPTH -v FAIL=$MINIMUM_DEPTH -v WARN=$EXPECTED_DEPTH '($4>=MISS && $4<FAIL) {print $1 "\t" $2-1 "\t" $2 "\t" $3 "\t" $4 "\t'$FAIL_COLOR_RGB'\t+" }' | $BEDTOOLS merge -c 4,5,7,2,3,6 -o distinct,mean,first,first,last,distinct >> $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED.tmp 2>/dev/null
			$GZ -cd $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE | awk -F"\t" -v MISS=$SEQUENCING_DEPTH -v FAIL=$MINIMUM_DEPTH -v WARN=$EXPECTED_DEPTH '($4>=FAIL && $4<WARN) {print $1 "\t" $2-1 "\t" $2 "\t" $3 "\t" $4 "\t'$WARN_COLOR_RGB'\t+" }' | $BEDTOOLS merge -c 4,5,7,2,3,6 -o distinct,mean,first,first,last,distinct >> $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED.tmp 2>/dev/null
			$GZ -cd $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE | awk -F"\t" -v MISS=$SEQUENCING_DEPTH -v FAIL=$MINIMUM_DEPTH -v WARN=$EXPECTED_DEPTH '($4>=WARN) {print $1 "\t" $2-1 "\t" $2 "\t" $3 "\t" $4 "\t'$PASS_COLOR_RGB'\t+" }' | $BEDTOOLS merge -c 4,5,7,2,3,6 -o distinct,mean,first,first,last,distinct >> $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED.tmp 2>/dev/null
			$BEDTOOLS sort -i $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED.tmp | cut -f1-9 > $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED


			# $GZ -cd $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE | awk -F"\t" -v MISS=$SEQUENCING_DEPTH -v FAIL=$MINIMUM_DEPTH -v WARN=$EXPECTED_DEPTH '($4>=WARN) {print $1 "\t" $2-1 "\t" $2 "\t" $3 "\t" $4 "\tTRUC\t+" }' 
			# echo "$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED.tmp"
			# cat $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED.tmp


			rm -f $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED.tmp
		fi;
		if [ -s $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED ]; then
			#GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED_DOWNLOAD_FILENAME=$(basename $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED).gz
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED_DOWNLOAD_FILENAME=$RANDOM$RANDOM.HsMetrics.per_base_coverage.bed.gz
			$GZ $GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED_DOWNLOAD_FILENAME
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED_DOWNLOAD_FILENAME
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED_DOWNLOAD_FILE' download>BED</a>"
		else
			GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED_DOWNLOAD_FILE_HTML=""
		fi;


		# PER_TARGET_COVERAGE
		#GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE_DOWNLOAD_FILENAME=$(basename $GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE).gz
		GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE_DOWNLOAD_FILENAME=$RANDOM$RANDOM.coverage.tsv.gz
		$GZ $GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE_DOWNLOAD_FILENAME
		GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE_DOWNLOAD_FILENAME
		GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE_DOWNLOAD_FILE' download>$DOWNLOAD_FILE_MSG</a>"

		# PER_TARGET_GENES_COVERAGE
		#GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE_DOWNLOAD_FILENAME=$(basename $GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE).gz
		GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE_DOWNLOAD_FILENAME=$RANDOM$RANDOM.genes.tsv.gz
		$GZ $GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE_DOWNLOAD_FILENAME
		GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE_DOWNLOAD_FILENAME
		GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE_DOWNLOAD_FILE' download>$DOWNLOAD_FILE_MSG</a>"

		# PER_TARGET_GENES_REPORT_COVERAGE
		#GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE_DOWNLOAD_FILENAME=$(basename $GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE).gz
		GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE_DOWNLOAD_FILENAME=$RANDOM$RANDOM.report.genes.tsv.gz
		$GZ $GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE_DOWNLOAD_FILENAME
		GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE_DOWNLOAD_FILENAME
		GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE_DOWNLOAD_FILE' download>$DOWNLOAD_FILE_MSG Report</a>"

		# PER_TARGET_DEPTH
		#GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH_DOWNLOAD_FILENAME=$(basename $GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH).gz
		GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH_DOWNLOAD_FILENAME=$RANDOM$RANDOM.HsMetrics.per_target_coverage.flags.tsv.gz
		$GZ $GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH_DOWNLOAD_FILENAME
		GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH_DOWNLOAD_FILENAME
		GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH_DOWNLOAD_FILE' download>$DOWNLOAD_FILE_MSG</a>"



		#if [ -s $GENES_PANEL_FILE ]; then
		if [ -s $GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE ] \
			&& [ -s $GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE ] \
			&& [ -s $GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE ] \
		; then
		#	&& [ -s $GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH ] \

			((GENES_PANEL_NUM++))



			# GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE
			GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE_NB_LINES=$(echo $(cat $GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE | wc -l)" - 1" | bc)
			if (( $GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE_NB_LINES > $TABLE_LIMIT )); then
				GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE_HTML=$TABLE_LIMIT_MSG_HTML
			else
				GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE_HTML=$(cat $GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE | tr "," " " | awk 'NR==1{print $1"\t"$3"\t"$2"\t#Bases Uncovered\t"$4} NR>1{print $1"\t"$3"\t"$2"\t"$3-$2"\t"(($4-0)*100)"%\t"($4-0)}' | awk '{if ($1=="'$SEQUENCING_DEPTH'X") {if ($6<'$SEQUENCING_COVERAGE_THRESHOLD') {color="rgb('$MISS_COLOR_RGB')"} else {color="rgb('$PASS_COLOR_RGB')"}; print "<b title=\"Sequencing\">"$1"</b>\t"$2"\t"$3"\t"$4"\t<b style=\"color:"color"\">"$5"</b>\t"$6} else {print $0}}' | awk '{if ($1=="'$MINIMUM_DEPTH'X") {if ($6<'$DEPTH_COVERAGE_THRESHOLD') {color="rgb('$FAIL_COLOR_RGB')"} else {color="rgb('$PASS_COLOR_RGB')"}; print "<b title=\"Minimum\">"$1"</b>\t"$2"\t"$3"\t"$4"\t<b style=\"color:"color"\">"$5"</b>\t"$6} else {print $0}}' | awk '{if ($1=="'$EXPECTED_DEPTH'X") {if ($6<'$DEPTH_COVERAGE_THRESHOLD') {color="rgb('$WARN_COLOR_RGB')"} else {color="rgb('$PASS_COLOR_RGB')"}; print "<b title=\"Expected\">"$1"</b>\t"$2"\t"$3"\t"$4"\t<b style=\"color:"color"\">"$5"</b>\t"$6} else {print $0}}' | sed 's/#Depth/Depth/g' | sed 's/CoveredBases/#Bases Covered/g' | sed 's/TotalBases/#Bases Total/g' | sed 's/Percent/Coverage/g' | cut -f1-5 | $STARK_FOLDER_BIN/csv_to_html.awk -v limit_string=1000 -v special_value_color="$SPECIAL_VALUE_COLOR" -v tag_row_head_plus="class='table-heads'" -v tag_col_head_plus=" class=\"head-item mbr-fonts-style display-7\"" -v tag_row_body_plus="" -v tag_col_body_plus=" class=\"body-item mbr-fonts-style display-7\"")
			fi;

			# DEPTH_COVERAGE_THRESHOLD

			# GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE
			# GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE_NB_LINES=$(echo $(cat $GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE | wc -l)" - 1" | bc)
			# if (( $GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE_NB_LINES > $TABLE_LIMIT )); then
			# 	GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE_HTML=$TABLE_LIMIT_MSG_HTML
			# else
			# 	GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE_HTML=$(cat $GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE | tr "," " " | sed 's/<//g' | sed 's/%Coverage\([^\t]*\)/<center>\1<br>%<\/center>/g' | sed 's/#Bases\([^\t]*\)/<center>\1<br>#<\/center>/g' | sed 's/Threshold/Flag/g' | sed 's/Nbases/Bases/g' | sed 's/#Gene/'$GENE_PANEL_TYPE_TABLE'/g' | $STARK_FOLDER_BIN/csv_to_html.awk -v limit_string=$LIMIT_STRING -v special_value_color="$SPECIAL_VALUE_COLOR" -v tag_row_head_plus="class='table-heads'" -v tag_col_head_plus=" class=\"head-item mbr-fonts-style display-7\"" -v tag_row_body_plus="" -v tag_col_body_plus=" class=\"body-item mbr-fonts-style display-7\"")
			# fi;

			# GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE
			GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE_NB_LINES=$(echo $(cat $GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE | wc -l)" - 1" | bc)
			if (( $GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE_NB_LINES > $TABLE_LIMIT )); then
				GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE_HTML=$TABLE_LIMIT_MSG_HTML
			else
				GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE_HTML=$(cat $GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE | tr "," " " | sed 's/<//g' | sed "s/%Coverage\([^\t]*\)/<center title=\"Coverage \&#62;\1\">\1<br>%<\/center>/g" | sed 's/#Bases\([^\t]*\)/<span title=\"Number of bases \&#60;\1\" style=\"color:silver\">\&nbsp;\&nbsp;\&nbsp;<br>#<\/span>/g' | sed 's/Threshold/<span title=\"Flag depending on Depth and Coverage thresholds\">Flag<\/span>/g' | sed 's/Nbases/<center title=\"Number of bases for '$GENE_PANEL_TYPE_TABLE'\">#Bases<\/center>/g' | sed 's/#Gene/'$GENE_PANEL_TYPE_TABLE'/g' | $STARK_FOLDER_BIN/csv_to_html.awk -v limit_string=$LIMIT_STRING -v special_value_color="$SPECIAL_VALUE_COLOR" -v tag_row_head_plus="class='table-heads'" -v tag_col_head_plus=" class=\"head-item mbr-fonts-style display-7\"" -v tag_row_body_plus="" -v tag_col_body_plus=" class=\"body-item mbr-fonts-style display-7\"")
			fi;


			# GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH
			GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH_NB_LINES=$(echo $(cat $GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH | wc -l)" - 1" | bc)
			if (( $GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH_NB_LINES > $TABLE_LIMIT )); then
				GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH_HTML=$TABLE_LIMIT_MSG_HTML
			else
				GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH_HTML=$(cat $GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH | tr "," " " | awk -F"\t" '{print $5 "\t" $1":"$2"-"$3 "\t" $4 "\t" $7 "\t" $13 "\t" $6 "\t" $9}' | sed 's/^name/'$GENE_PANEL_TYPE_TABLE'/g' | sed 's/chrom.start.end/<span title=\"Location of '$GENE_PANEL_TYPE_TABLE'\">Location<\/span>/g' | sed 's/minimum_threshold/Flag Min Depth/g'| sed 's/average_threshold/Flag Mean Depth/g' | sed 's/min_coverage/Min Depth/g' | sed 's/mean_coverage/Mean Depth/g' | sed 's/length/<span title=\"Number of bases for '$GENE_PANEL_TYPE_TABLE'\">#Bases<\/span>/g' | $STARK_FOLDER_BIN/csv_to_html.awk -v limit_string=$LIMIT_STRING -v special_value_color="$SPECIAL_VALUE_COLOR" -v tag_row_head_plus="class='table-heads'" -v tag_col_head_plus=" class=\"head-item mbr-fonts-style display-7\"" -v tag_row_body_plus="" -v tag_col_body_plus=" class=\"body-item mbr-fonts-style display-7\"")
			fi;


			# FLAGS
			# PASS
			if [ -s $GENES_PANEL_GENES_FLAGS_PATTERN".PASS.txt" ]; then
				GENES_PANEL_GENES_FLAGS_PATTERN_PASS_TABLE_HTML=$(cat $GENES_PANEL_GENES_FLAGS_PATTERN".PASS.txt" | grep "^#" -v | cut -f1)
			fi;
			# WARN
			if [ -s $GENES_PANEL_GENES_FLAGS_PATTERN".WARN.txt" ]; then
				GENES_PANEL_GENES_FLAGS_PATTERN_WARN_TABLE_HTML=$(cat $GENES_PANEL_GENES_FLAGS_PATTERN".WARN.txt" | grep "^#" -v | cut -f1)
			fi;
			# PASS
			if [ -s $GENES_PANEL_GENES_FLAGS_PATTERN".FAIL.txt" ]; then
				GENES_PANEL_GENES_FLAGS_PATTERN_FAIL_TABLE_HTML=$(cat $GENES_PANEL_GENES_FLAGS_PATTERN".FAIL.txt" | grep "^#" -v | cut -f1)
			fi;
			# PASS
			if [ -s $GENES_PANEL_GENES_FLAGS_PATTERN".MISS.txt" ]; then
				GENES_PANEL_GENES_FLAGS_PATTERN_MISS_TABLE_HTML=$(cat $GENES_PANEL_GENES_FLAGS_PATTERN".MISS.txt" | grep "^#" -v | cut -f1)
			fi;


			GENES_PANEL_GENES_FLAGS_HTML="
					<thead>
						<tr class='table-heads'>
							<th class='head-item mbr-fonts-style display-7'>PASS</th>
							<th class='head-item mbr-fonts-style display-7'>WARN</th>
							<th class='head-item mbr-fonts-style display-7'>FAIL</th>
							<th class='head-item mbr-fonts-style display-7'>MISS</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td class='body-item mbr-fonts-style display-7' $PASS_FLAG_ICON>$GENES_PANEL_GENES_FLAGS_PATTERN_PASS_TABLE_HTML</td>
							<td class='body-item mbr-fonts-style display-7' $WARN_FLAG_ICON>$GENES_PANEL_GENES_FLAGS_PATTERN_WARN_TABLE_HTML</td>
							<td class='body-item mbr-fonts-style display-7' $FAIL_FLAG_ICON>$GENES_PANEL_GENES_FLAGS_PATTERN_FAIL_TABLE_HTML</td>
							<td class='body-item mbr-fonts-style display-7' $MISS_FLAG_ICON>$GENES_PANEL_GENES_FLAGS_PATTERN_MISS_TABLE_HTML</td>
						</tr>
					</tbody>
			"

			GENES_PANEL_GENES_FLAGS_HTML="
					<thead>
						<tr class='table-heads'>
							<th class='head-item mbr-fonts-style display-7' title='Flag depending on Depth and Coverage thresholds'>Flag</th>
							<th class='head-item mbr-fonts-style display-7'>"$GENE_PANEL_TYPE_TABLE"</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td class='body-item mbr-fonts-style display-7' style='width:50px'>MISS</td>
							<td class='body-item mbr-fonts-style display-7' $MISS_FLAG_ICON>$GENES_PANEL_GENES_FLAGS_PATTERN_MISS_TABLE_HTML</td>
						</tr>
						<tr>
							<td class='body-item mbr-fonts-style display-7' style='width:50px'>FAIL</td>
							<td class='body-item mbr-fonts-style display-7' $FAIL_FLAG_ICON>$GENES_PANEL_GENES_FLAGS_PATTERN_FAIL_TABLE_HTML</td>
						</tr>
						<tr>
							<td class='body-item mbr-fonts-style display-7' style='width:50px'>WARN</td>
							<td class='body-item mbr-fonts-style display-7' $WARN_FLAG_ICON>$GENES_PANEL_GENES_FLAGS_PATTERN_WARN_TABLE_HTML</td>
						</tr>
						<tr>
							<td class='body-item mbr-fonts-style display-7' style='width:50px'>PASS</td>
							<td class='body-item mbr-fonts-style display-7' $PASS_FLAG_ICON>$GENES_PANEL_GENES_FLAGS_PATTERN_PASS_TABLE_HTML</td>
						</tr>
					</tbody>
			"


			# BREAK
			(( $(echo "$GENES_PANEL_NUM >= 2" |bc -l) )) && GENES_PANEL_BREAK=$PAGE_BREAK_BEFORE || GENES_PANEL_BREAK=""

			# PLAN
			#echo '<a class="btn btn-primary-outline display-4 mbr-section-subtitle mbr-fonts-style display-6 align-center" href="#'$GENES_PANEL'-'$ALIGNER'"><small>'$GENE_PANEL_NAME_HTML' ('$ALIGNER')</small></a>' >> $HTMLFILE_ANNEX_PLAN_LINKS_COVERAGE
			#echo '<a class="btn display-4 mbr-section-subtitle mbr-fonts-style display-6 align-center" href="#'$GENES_PANEL'-'$ALIGNER'">'$GENE_PANEL_NAME_HTML' ('$ALIGNER')</a>' >> $HTMLFILE_ANNEX_PLAN_LINKS_COVERAGE
			echo '<a class="btn display-4 mbr-section-subtitle mbr-fonts-style display-6 align-center" href="#COVERAGE_'$GENES_PANEL'-'$ALIGNER'"><small>'$GENE_PANEL_NAME_HTML' ('$ALIGNER')</small></a>' >> $HTMLFILE_ANNEX_PLAN_LINKS_COVERAGE
			echo '<a class="btn display-4 mbr-section-subtitle mbr-fonts-style display-6 align-center" href="#GENES_COVERAGE_'$GENES_PANEL'-'$ALIGNER'"><small>'$GENE_PANEL_NAME_HTML' ('$ALIGNER')</small></a>' >> $HTMLFILE_ANNEX_PLAN_LINKS_GENES_COVERAGE
			echo '<a class="btn display-4 mbr-section-subtitle mbr-fonts-style display-6 align-center" href="#DEPTH_'$GENES_PANEL'-'$ALIGNER'"><small>'$GENE_PANEL_NAME_HTML' ('$ALIGNER')</small></a>' >> $HTMLFILE_ANNEX_PLAN_LINKS_DEPTH
			echo '<a class="btn display-4 mbr-section-subtitle mbr-fonts-style display-6 align-center" href="#GENES_FLAGS_'$GENES_PANEL'-'$ALIGNER'"><small>'$GENE_PANEL_NAME_HTML' ('$ALIGNER')</small></a>' >> $HTMLFILE_ANNEX_PLAN_LINKS_GENES_FLAGS


			echo '

			<section class="section-table cid-ruiBoanIwc" id="COVERAGE_'$GENES_PANEL'-'$ALIGNER'" >

			  <div class="container container-table">

				  <h3 class="mbr-section-subtitle mbr-fonts-style align-center mbr-light display-5" '$GENES_PANEL_BREAK'>
				  <br>
				  	'$GENE_PANEL_NAME_HTML' ('$ALIGNER')
				  </h3>

				  <p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
				    '$GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE_DOWNLOAD_FILE_HTML'
				  </p>

				  <div class="table-wrapper">
					<div class="container">
					  <div class="row search">
						<div class="col-md-6"></div>
						<div class="col-md-6">
							<div class="dataTables_filter">
							  <label class="searchInfo mbr-fonts-style display-7">Search:</label>
							  <input class="form-control input-sm" disabled="">
							</div>
						</div>
					  </div>
					</div>

					<div class="container scroll">
					  	<table class="table isSearch" cellspacing="0">
							'$GENES_PANEL_HSMETRICS_PER_TARGET_COVERAGE_HTML'
					  	</table>
					</div>

					<div class="container table-info-container">
					  <div class="row info">
						<div class="col-md-6">
						  <div class="dataTables_info mbr-fonts-style display-7">
							<span class="infoBefore">Showing</span>
							<span class="inactive infoRows"></span>
							<span class="infoAfter">entries</span>
							<span class="infoFilteredBefore">(filtered from</span>
							<span class="inactive infoRows"></span>
							<span class="infoFilteredAfter"> total entries)</span>
						  </div>
						</div>
						<div class="col-md-6"></div>
					  </div>
					</div>

				  </div>

				</div>

			</section>

			' >> $HTMLFILE_ANNEX_GENES_PANEL_COVERAGE


			echo '

			<section class="section-table cid-ruiBoanIwc" id="GENES_FLAGS_'$GENES_PANEL'-'$ALIGNER'">

			  <div class="container container-table">

				  <h3 class="mbr-section-subtitle mbr-fonts-style align-center mbr-light display-5" '$GENES_PANEL_BREAK'>
				  	<br>
					'$GENE_PANEL_NAME_HTML' Report ('$ALIGNER')
				  </h3>

				  <p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
				    '$GENES_PANEL_HSMETRICS_PER_TARGET_GENES_COVERAGE_DOWNLOAD_FILE_HTML'
				  </p>

				  <div class="table-wrapper">
					<div class="container">
					  <div class="row search">
						<div class="col-md-6"></div>
						<div class="col-md-6">
							<div class="dataTables_filter">
							  <label class="searchInfo mbr-fonts-style display-7">Search:</label>
							  <input class="form-control input-sm" disabled="">
							</div>
						</div>
					  </div>
					</div>

					<div class="container scroll">
						<table class="table isSearch" cellspacing="0">
							'$GENES_PANEL_GENES_FLAGS_HTML'
						</table>
					</div>

					<div class="container table-info-container">
					  <div class="row info">
						<div class="col-md-6">
						  <div class="dataTables_info mbr-fonts-style display-7">
							<span class="infoBefore">Showing</span>
							<span class="inactive infoRows"></span>
							<span class="infoAfter">entries</span>
							<span class="infoFilteredBefore">(filtered from</span>
							<span class="inactive infoRows"></span>
							<span class="infoFilteredAfter"> total entries)</span>
						  </div>
						</div>
						<div class="col-md-6"></div>
					  </div>
					</div>

				  </div>

				</div>

			</section>

			' >> $HTMLFILE_ANNEX_GENES_PANEL_GENES_COVERAGE


			echo '

			<section class="section-table cid-ruiBoanIwc" id="GENES_REPORT_COVERAGE_'$GENES_PANEL'-'$ALIGNER'">

			  <div class="container container-table">

				  <div class="table-wrapper">
					<div class="container">
					  <div class="row search">
						<div class="col-md-6"></div>
						<div class="col-md-6">
							<div class="dataTables_filter">
							  <label class="searchInfo mbr-fonts-style display-7">Search:</label>
							  <input class="form-control input-sm" disabled="">
							</div>
						</div>
					  </div>
					</div>

					<div class="container scroll">
						<table class="table isSearch" cellspacing="0">
							'$GENES_PANEL_HSMETRICS_PER_TARGET_GENES_REPORT_COVERAGE_HTML'
						</table>
					</div>

					<div class="container table-info-container">
					  <div class="row info">
						<div class="col-md-6">
						  <div class="dataTables_info mbr-fonts-style display-7">
							<span class="infoBefore">Showing</span>
							<span class="inactive infoRows"></span>
							<span class="infoAfter">entries</span>
							<span class="infoFilteredBefore">(filtered from</span>
							<span class="inactive infoRows"></span>
							<span class="infoFilteredAfter"> total entries)</span>
						  </div>
						</div>
						<div class="col-md-6"></div>
					  </div>
					</div>


				  </div>
				</div>

			</section>

			' >> $HTMLFILE_ANNEX_GENES_PANEL_GENES_COVERAGE


			echo '

			<section class="section-table cid-ruiBoanIwc" id="DEPTH_'$GENES_PANEL'-'$ALIGNER'">


			  <div class="container container-table">

				  <h3 class="mbr-section-subtitle mbr-fonts-style align-center mbr-light display-5" '$GENES_PANEL_BREAK'>
				  <br>
					'$GENE_PANEL_NAME_HTML' ('$ALIGNER')
				  </h3>

				  <p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
				    '$GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH_DOWNLOAD_FILE_HTML'
					<br>
					'$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_BED_DOWNLOAD_FILE_HTML'
					<br>
					<br>
					Bases/Regions depth threshold failing
					<br>
					'$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_MISS_DOWNLOAD_FILE_HTML' depth <'$SEQUENCING_DEPTH'X
					<br>
					'$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_FAIL_DOWNLOAD_FILE_HTML' depth <'$MINIMUM_DEPTH'X
					<br>
					'$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_WARN_DOWNLOAD_FILE_HTML' depth <'$EXPECTED_DEPTH'X
					<br>
					'$GENES_PANEL_HSMETRICS_PER_BASE_COVERAGE_PASS_DOWNLOAD_FILE_HTML' depth &#8805;'$EXPECTED_DEPTH'X
				  </p>

				  <div class="table-wrapper">
					<div class="container">
					  <div class="row search">
						<div class="col-md-6"></div>
						<div class="col-md-6">
							<div class="dataTables_filter">
							  <label class="searchInfo mbr-fonts-style display-7">Search:</label>
							  <input class="form-control input-sm" disabled="">
							</div>
						</div>
					  </div>
					</div>

					<div class="container scroll">
						<table class="table isSearch" cellspacing="0">
							'$GENES_PANEL_HSMETRICS_PER_TARGET_DEPTH_HTML'
						</table>
					</div>

					<div class="container table-info-container">
					  <div class="row info">
						<div class="col-md-6">
						  <div class="dataTables_info mbr-fonts-style display-7">
							<span class="infoBefore">Showing</span>
							<span class="inactive infoRows"></span>
							<span class="infoAfter">entries</span>
							<span class="infoFilteredBefore">(filtered from</span>
							<span class="inactive infoRows"></span>
							<span class="infoFilteredAfter"> total entries)</span>
						  </div>
						</div>
						<div class="col-md-6"></div>
					  </div>
					</div>


				  </div>
				</div>

			</section>

			' >> $HTMLFILE_ANNEX_GENES_PANEL_DEPTH
			#' >> $HTMLFILE_ANNEX_GENES_PANEL_FLAGS

		fi;

	done;

done;



SECTION_NAME="Global Coverage"
SECTION_ID="annex_coverage"

if in_array $SECTION_ID $SECTIONS || in_array ALL $SECTIONS ; then
	(($DEBUG)) && echo "show section $SECTION_ID"

	# PLAN
	echo '<a class="btn btn-primary-outline display-4" href="#'$SECTION_ID'">'$SECTION_NAME'</a>' >> $HTMLFILE_ANNEX_PLAN_LINKS

	echo '

		<section class="cid-ruiBoanIwc" id="'$SECTION_ID'" '$PAGE_BREAK_BEFORE'>
		<br>

			<div class="container">
				<h2 class="mbr-section-title pb-3 align-center mbr-fonts-style display-2">
					'$SECTION_NAME'
				</h2>

				<p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
					Statistics and Coverage generated with SAMTools on Full BAM and <a href="#BAMforvalidation" id="BAMforvalidation">BAM for validation</a>
					<br>
					'$BAM_VALIDATION_TEXT_HTML'
					<br>
					Coverage flagged depending on Depth and Coverage thresholds
					<br>
					Sequencing coverage: depth <strong>'$SEQUENCING_DEPTH'X</strong> and threshold <strong>'$(awk 'BEGIN{printf("%.1f\n",'$SEQUENCING_COVERAGE_THRESHOLD'*100)}')'%</strong>
					<br>
					Minimum coverage: depth <strong>'$MINIMUM_DEPTH'X</strong> and threshold <strong>'$(awk 'BEGIN{printf("%.1f\n",'$DEPTH_COVERAGE_THRESHOLD'*100)}')'%</strong>
					<br>
					Expected coverage: depth <strong>'$EXPECTED_DEPTH'X</strong> and threshold <strong>'$(awk 'BEGIN{printf("%.1f\n",'$DEPTH_COVERAGE_THRESHOLD'*100)}')'%</strong>
				</p>

				<section class="mbr-section content8 cid-ruitEAjBmu" id="content8-1z">
					<div class="container">
						<div class="media-container-row title">
							<div class="col-12 col-md-40">
								<div class="mbr-section-btn align-center">
								'$(cat $HTMLFILE_ANNEX_PLAN_LINKS_COVERAGE)'
							</div>
						</div>
					</div>
				</section>

				'"$(cat $HTMLFILE_ANNEX_GENES_PANEL_COVERAGE)"'



		</div>
		</section>

	' > $HTMLFILE_ANNEX_COVERAGE

fi;


SECTION_NAME="Targets & Genes Depth"
SECTION_ID="annex_depth"

if in_array $SECTION_ID $SECTIONS || in_array ALL $SECTIONS ; then
		(($DEBUG)) && echo "show section $SECTION_ID"

	# PLAN
	echo '<a class="btn btn-primary-outline display-4" href="#'$SECTION_ID'">'$SECTION_NAME'</a>' >> $HTMLFILE_ANNEX_PLAN_LINKS

	echo '

		<section class="cid-ruiBoanIwc" id="'$SECTION_ID'" '$PAGE_BREAK_BEFORE'>
		<br>

			<div class="container">
				<h2 class="mbr-section-title pb-3 align-center mbr-fonts-style display-2">
					'$SECTION_NAME'
				</h2>

				<p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
					Depth generated with SAMTools mpileup and Picard CollectHsMetrics
					'$AMPLICON_TEXT_HTML'
					<br>
					on <a href="#BAMforvalidation">BAM for validation</a>
					<br>
					<br>
					Targets & Genes flagged depending on Depth thresholds
					<br>
					MISS flag if depth <strong><'$SEQUENCING_DEPTH'X</strong> (Sequencing depth)
					<br>
					FAIL flag if depth <strong><'$MINIMUM_DEPTH'X</strong> (Minimum depth)
					<br>
					WARN flag if depth <strong><'$EXPECTED_DEPTH'X</strong> (Expected depth)
					<br>
					PASS flag if depth <strong>&#8805;'$EXPECTED_DEPTH'X</strong> (Expected depth)
					<br>
					<br>
					[Tables limited to '$TABLE_LIMIT' entries]
				</p>

				<section class="mbr-section content8 cid-ruitEAjBmu" id="content8-1z">
					<div class="container">
						<div class="media-container-row title">
							<div class="col-12 col-md-40">
								<div class="mbr-section-btn align-center">
								'$(cat $HTMLFILE_ANNEX_PLAN_LINKS_DEPTH)'
							</div>
						</div>
					</div>
				</section>

				'"$(cat $HTMLFILE_ANNEX_GENES_PANEL_DEPTH)"'



		</div>
		</section>

	' > $HTMLFILE_ANNEX_DEPTH

fi;


SECTION_NAME="Targets & Genes Coverage"
SECTION_ID="annex_genes_coverage"

if in_array $SECTION_ID $SECTIONS || in_array ALL $SECTIONS ; then
	(($DEBUG)) && echo "show section $SECTION_ID"

	# PLAN
	echo '<a class="btn btn-primary-outline display-4" href="#'$SECTION_ID'">'$SECTION_NAME'</a>' >> $HTMLFILE_ANNEX_PLAN_LINKS

	echo '

		<section class="cid-ruiBoanIwc" id="'$SECTION_ID'" '$PAGE_BREAK_BEFORE'>
		<br>

			<div class="container">
				<h2 class="mbr-section-title pb-3 align-center mbr-fonts-style display-2">
					'$SECTION_NAME'
				</h2>

				<p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
					Coverage generated with SAMTools mpileup on <a href="#BAMforvalidation">BAM for validation</a>
					<br>
					<br>
					Targets & Genes flagged depending on Depth and Coverage thresholds
					<br>
					Sequencing coverage: depth <strong>'$SEQUENCING_DEPTH'X</strong> and threshold <strong>'$(awk 'BEGIN{printf("%.1f\n",'$SEQUENCING_COVERAGE_THRESHOLD'*100)}')'%</strong>
					<br>
					Minimum coverage: depth <strong>'$MINIMUM_DEPTH'X</strong> and threshold <strong>'$(awk 'BEGIN{printf("%.1f\n",'$DEPTH_COVERAGE_THRESHOLD'*100)}')'%</strong>
					<br>
					Expected coverage: depth <strong>'$EXPECTED_DEPTH'X</strong> and threshold <strong>'$(awk 'BEGIN{printf("%.1f\n",'$DEPTH_COVERAGE_THRESHOLD'*100)}')'%</strong>
					<br>
					MISS flag if fully not sequenced
					<br>
					FAIL flag if minimum coverage failed
					<br>
					WARN flag if expected coverage failed
					<br>
					PASS flag if expected coverage succed
					<br>
					<br>
					[Tables limited to '$TABLE_LIMIT' entries]
				</p>

				<section class="mbr-section content8 cid-ruitEAjBmu" id="content8-1z">
					<div class="container">
						<div class="media-container-row title">
							<div class="col-12 col-md-40">
								<div class="mbr-section-btn align-center">
								'$(cat $HTMLFILE_ANNEX_PLAN_LINKS_GENES_FLAGS)'
							</div>
						</div>
					</div>
				</section>

				'"$(cat $HTMLFILE_ANNEX_GENES_PANEL_GENES_COVERAGE)"'

		</div>
		</section>

	' > $HTMLFILE_ANNEX_GENES_COVERAGE

fi;


# REPORT GENES VARIANTS
############

(($VERBOSE)) && echo "#[INFO] ANNEX VARIANTS section"

HTMLFILE_ANNEX_VARIANTS=$HTMLFILE_ANNEX".variants"
HTMLFILE_ANNEX_ANNOTATIONS=$HTMLFILE_ANNEX".annotations"

# FILES
HTMLFILE_ANNEX_GENES_PANEL_VARIANTS=$HTMLFILE_ANNEX".genes_panel_variants"
HTMLFILE_ANNEX_GENES_PANEL_ANNOTATIONS=$HTMLFILE_ANNEX".genes_panel_annotations"
HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV=$HTMLFILE_ANNEX".genes_panel_variants.tsv"


# LINKS
HTMLFILE_ANNEX_PLAN_LINKS_VARIANTS=$HTMLFILE_ANNEX_PLAN_LINKS".variants"
> $HTMLFILE_ANNEX_PLAN_LINKS_VARIANTS
HTMLFILE_ANNEX_PLAN_LINKS_ANNOTATIONS=$HTMLFILE_ANNEX_PLAN_LINKS".annotations"
> $HTMLFILE_ANNEX_PLAN_LINKS_ANNOTATIONS


GENES_PANEL_NUM=0


	# FILES
	#LIST_GENES_PANEL="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.list.genes"
	#TARGET_DESIGN_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.$ALIGNER.design.bed"
	#TARGET_DESIGN_NAME="$SAMPLE.bed"
	#TARGET_DESIGN_NAME="$SAMPLE.from_design.genes" # TEST.final.design.bed
	TARGET_DESIGN_NAME="$SAMPLE.final.design.bed" # TEST.final.design.bed


	#for GENES_PANEL in $TARGET_DESIGN_NAME $(cat $LIST_GENES_PANEL | grep -v "^$TARGET_DESIGN_NAME$"); do # LIST_GENES_PANEL_BASENAME
	for GENES_PANEL in $TARGET_DESIGN_NAME $(cat $LIST_GENES_PANEL_BASENAME | grep -v "^$TARGET_DESIGN_NAME$"); do # LIST_GENES_PANEL_BASENAME

		# FILES
		GENES_PANEL_FILE="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$GENES_PANEL"

		# TYPE
		if [ "$GENES_PANEL" == "$TARGET_DESIGN_NAME" ]; then
			GENE_PANEL_TYPE_NAME="Design"
		else
			GENE_PANEL_TYPE_NAME="Panel."$GENES_PANEL
		fi

		# GENES_PANEL_VCF="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.genes.$GENES_PANEL.vcf"
		# GENES_PANEL_TSV="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.genes.$GENES_PANEL.tsv"
		# GENES_PANEL_REPORT_TSV="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.genes.$GENES_PANEL.report.tsv"
		# GENES_PANEL_INFO_FIELD_STATS="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.genes.$GENES_PANEL.report.info_field.stats.tsv"

		# GENES_PANEL_VCF="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.genes.$GENE_PANEL_TYPE_NAME.vcf"
		# GENES_PANEL_TSV="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.genes.$GENE_PANEL_TYPE_NAME.tsv"
		# GENES_PANEL_REPORT_TSV="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.genes.$GENE_PANEL_TYPE_NAME.report.tsv"
		# GENES_PANEL_INFO_FIELD_STATS="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.genes.$GENE_PANEL_TYPE_NAME.report.info_field.stats.tsv"

		GENES_PANEL_VCF="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.$GENE_PANEL_TYPE_NAME.vcf.gz"
		GENES_PANEL_TSV="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.$GENE_PANEL_TYPE_NAME.tsv"
		GENES_PANEL_REPORT_TSV="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.$GENE_PANEL_TYPE_NAME.report.tsv"
		GENES_PANEL_INFO_FIELD_STATS="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.$GENE_PANEL_TYPE_NAME.report.info_field.stats.tsv"
		GENES_PANEL_BCFTOOLS_STATS="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.$GENE_PANEL_TYPE_NAME.report.bcftools.stats.tsv"
		GENES_PANEL_SNPEFF_STATS="$RESULTS_FOLDER/$ANALYSIS/$SAMPLE/$SAMPLE.reports/$SAMPLE.final.vcf.metrics/metrics.$GENE_PANEL_TYPE_NAME.snpeff.html"



		# COPY

		# GENES_PANEL_VCF
		#GENES_PANEL_VCF_DOWNLOAD_FILENAME=$(basename $GENES_PANEL_VCF).gz
		GENES_PANEL_VCF_DOWNLOAD_FILENAME=$RANDOM$RANDOM.vcf.gz
		#$GZ $GENES_PANEL_VCF -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_VCF_DOWNLOAD_FILENAME
		cp $GENES_PANEL_VCF $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_VCF_DOWNLOAD_FILENAME
		GENES_PANEL_VCF_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_VCF_DOWNLOAD_FILENAME
		GENES_PANEL_VCF_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_VCF_DOWNLOAD_FILE' download>VCF</a>"

		# GENES_PANEL_TSV
		#GENES_PANEL_TSV_DOWNLOAD_FILENAME=$(basename $GENES_PANEL_TSV).gz
		GENES_PANEL_TSV_DOWNLOAD_FILENAME=$RANDOM$RANDOM.tsv.gz
		$GZ $GENES_PANEL_TSV -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_TSV_DOWNLOAD_FILENAME
		GENES_PANEL_TSV_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_TSV_DOWNLOAD_FILENAME
		GENES_PANEL_TSV_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_TSV_DOWNLOAD_FILE' download>TSV</a>"

		# GENES_PANEL_REPORT_TSV
		#GENES_PANEL_REPORT_TSV_DOWNLOAD_FILENAME=$(basename $GENES_PANEL_REPORT_TSV).gz
		GENES_PANEL_REPORT_TSV_DOWNLOAD_FILENAME=$RANDOM$RANDOM.report.tsv.gz
		$GZ $GENES_PANEL_REPORT_TSV -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_REPORT_TSV_DOWNLOAD_FILENAME
		GENES_PANEL_REPORT_TSV_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_REPORT_TSV_DOWNLOAD_FILENAME
		GENES_PANEL_REPORT_TSV_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_REPORT_TSV_DOWNLOAD_FILE' download>REPORT</a>"

		# GENES_PANEL_INFO_FIELD_STATS
		#GENES_PANEL_INFO_FIELD_STATS_DOWNLOAD_FILENAME=$(basename $GENES_PANEL_INFO_FIELD_STATS).gz
		GENES_PANEL_INFO_FIELD_STATS_DOWNLOAD_FILENAME=$RANDOM$RANDOM.report.info_field.stats.tsv.gz
		$GZ $GENES_PANEL_INFO_FIELD_STATS -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_INFO_FIELD_STATS_DOWNLOAD_FILENAME
		GENES_PANEL_INFO_FIELD_STATS_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_INFO_FIELD_STATS_DOWNLOAD_FILENAME
		GENES_PANEL_INFO_FIELD_STATS_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_INFO_FIELD_STATS_DOWNLOAD_FILE' download>$DOWNLOAD_FILE_MSG</a>"

		# GENES_PANEL_BCFTOOLS_STATS
		GENES_PANEL_BCFTOOLS_STATS_DOWNLOAD_FILENAME=$RANDOM$RANDOM.bcftools.stats.txt.gz
		$GZ $GENES_PANEL_BCFTOOLS_STATS -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_BCFTOOLS_STATS_DOWNLOAD_FILENAME
		GENES_PANEL_BCFTOOLS_STATS_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_BCFTOOLS_STATS_DOWNLOAD_FILENAME
		GENES_PANEL_BCFTOOLS_STATS_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_BCFTOOLS_STATS_DOWNLOAD_FILE' download>BCFTools Statistics</a>"

		# GENES_PANEL_SNPEFF_STATS
		if [ -e $GENES_PANEL_SNPEFF_STATS ]; then
			GENES_PANEL_SNPEFF_STATS_PATTERN=$RANDOM$RANDOM
			GENES_PANEL_SNPEFF_STATS_HTML_DOWNLOAD_FILENAME=$GENES_PANEL_SNPEFF_STATS_PATTERN.snpeff.html
			cp -p $GENES_PANEL_SNPEFF_STATS $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_SNPEFF_STATS_HTML_DOWNLOAD_FILENAME
			GENES_PANEL_SNPEFF_STATS_HTML_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_SNPEFF_STATS_HTML_DOWNLOAD_FILENAME
			#GENES_PANEL_SNPEFF_STATS_HTML_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_SNPEFF_STATS_HTML_DOWNLOAD_FILE' download>snpEff Statistics HTML</a>"
			GENES_PANEL_SNPEFF_STATS_TSV_DOWNLOAD_FILENAME=$GENES_PANEL_SNPEFF_STATS_PATTERN.snpeff.html.genes.tsv.gz
			touch $GENES_PANEL_SNPEFF_STATS.genes.txt
			$GZ $GENES_PANEL_SNPEFF_STATS.genes.txt -c > $OUTPUT_FILES_HTMLDIR/$GENES_PANEL_SNPEFF_STATS_TSV_DOWNLOAD_FILENAME
			GENES_PANEL_SNPEFF_STATS_TSV_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$GENES_PANEL_SNPEFF_STATS_TSV_DOWNLOAD_FILENAME
			#GENES_PANEL_SNPEFF_STATS_TSV_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_SNPEFF_STATS_TSV_DOWNLOAD_FILE' download>snpEff Statistics TSV</a>"
			GENES_PANEL_SNPEFF_STATS_DOWNLOAD_FILE_HTML="<a href='$GENES_PANEL_SNPEFF_STATS_HTML_DOWNLOAD_FILE' download>snpEff Statistics</a> [<a href='$GENES_PANEL_SNPEFF_STATS_TSV_DOWNLOAD_FILE' download>TSV</a>]"
		else
			GENES_PANEL_SNPEFF_STATS_DOWNLOAD_FILE_HTML=""
		fi;

		

		# GENES_PANEL_VCF


		if [ -s $GENES_PANEL_FILE ] || [ $GENES_PANEL == $TARGET_DESIGN_NAME ]; then

			((GENES_PANEL_NUM++))

			if [ "$GENES_PANEL" == "$TARGET_DESIGN_NAME" ]; then
				GENES_PANEL_NAME="Target Design"
				GENE_PANEL_NAME_HTML="$GENES_PANEL_NAME"
				GENE_PANEL_TYPE_HTML="Target<br>Regions"
			else
				GENES_PANEL_NAME=$(echo $GENES_PANEL | sed "s/^$SAMPLE.//" | sed "s/.genes$//")
				GENE_PANEL_NAME_HTML="Gene Panel<br>$GENES_PANEL_NAME"
				GENE_PANEL_TYPE_HTML="Gene<br>Panel"
			fi;


			(($DEBUG)) && echo "GENES_PANEL: $GENES_PANEL";
			(($DEBUG)) && echo "GENES_PANEL_NAME: $GENES_PANEL_NAME";
			(($DEBUG)) && echo "GENES_PANEL_NUM: "$GENES_PANEL_NUM


			# HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV
			if [ -s $GENES_PANEL_VCF ]; then

				# Create TSV if not exists
				if [ ! -s $GENES_PANEL_REPORT_TSV ] || ((0)); then
					if [ "$HOWARD_FIELDS_REPORT" == "" ]; then
						HOWARD_FIELDS_REPORT=$(echo $HOWARD_FIELDS | sed "s/ALL//")
					fi;
					$HOWARD --config=$HOWARD_CONFIG --config=$HOWARD_CONFIG --config_prioritization=$HOWARD_CONFIG_PRIORITIZATION --config_annotation=$HOWARD_CONFIG_ANNOTATION --pzfields="PZScore,PZFlag,PZComment,PZInfos" --format=tab  --fields="$HOWARD_FIELDS_REPORT" --sort=$HOWARD_SORT --sort_by="$HOWARD_SORT_BY" --order_by="$HOWARD_ORDER_BY" --multithreading --threads=$THREADS --snpeff_threads=$THREADS_BY_SAMPLE --tmp=$TMP_FOLDER_TMP --env=$CONFIG_TOOLS --input=$GENES_PANEL_VCF --output=$HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV.tmp --force;
					GENES_PANEL_REPORT_TSV=$HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV.tmp
				fi;

				# Formating to create table
				cut -f 8- $GENES_PANEL_REPORT_TSV | rev | cut -f 3- | rev >$HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV.INFO
				cut -f -7 $GENES_PANEL_REPORT_TSV >$HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV.CHROMPOSREFALT
				rev $GENES_PANEL_REPORT_TSV | cut -f -2 | rev >$HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV.FORMATSAMPLE
				paste $HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV.INFO $HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV.CHROMPOSREFALT $HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV.FORMATSAMPLE > $HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV

				# HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV
				#HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV_DOWNLOAD_FILENAME=$(basename $HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV).gz
				HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV_DOWNLOAD_FILENAME=$RANDOM$RANDOM.tsv.gz
				$GZ $HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV -c > $OUTPUT_FILES_HTMLDIR/$HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV_DOWNLOAD_FILENAME
				HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV_DOWNLOAD_FILE=$OUTPUT_FILES_HTMLFOLDER/$HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV_DOWNLOAD_FILENAME
				HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV_DOWNLOAD_FILE_HTML="<a href='$HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV_DOWNLOAD_FILE' download>$DOWNLOAD_FILE_MSG</a>"

				# NB lines/variants
				GENES_PANEL_REPORT_TSV_NB_LINES=$(echo $(cat $GENES_PANEL_REPORT_TSV | wc -l)" - 1" | bc)

				if (( $GENES_PANEL_REPORT_TSV_NB_LINES > $TABLE_LIMIT )); then
					GENES_PANEL_VARIANTS_HTML=$TABLE_LIMIT_MSG_HTML
				else
					GENES_PANEL_VARIANTS_HTML=$(cat $HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV | tr "," " " | $STARK_FOLDER_BIN/csv_to_html.awk -v special_value_color="$SPECIAL_VALUE_COLOR" -v limit=$TABLE_LIMIT_CUT -v tag_row_head_plus="class='table-heads'" -v tag_col_head_plus=" class=\"head-item mbr-fonts-style display-7\"" -v tag_row_body_plus="" -v tag_col_body_plus=" class=\"body-item mbr-fonts-style display-7\"")
				fi;


			fi;

			# GENES_PANEL_INFO_FIELD_STATS


			# Contruct file
			echo -e "Annotation\tValue\tCount" > $HTMLFILE_ANNEX_GENES_PANEL_ANNOTATIONS.tmp
			cat $GENES_PANEL_INFO_FIELD_STATS | grep "^#" -v >> $HTMLFILE_ANNEX_GENES_PANEL_ANNOTATIONS.tmp

			# NB lines/variants
			GENES_PANEL_INFO_FIELD_STATS_LINES=$(echo $(cat $HTMLFILE_ANNEX_GENES_PANEL_ANNOTATIONS.tmp | wc -l)" - 1" | bc)

			if (( $GENES_PANEL_INFO_FIELD_STATS_LINES > $TABLE_LIMIT )); then
				GENES_PANEL_INFO_FIELD_STATS_HTML=$TABLE_LIMIT_MSG_HTML
			else
				GENES_PANEL_INFO_FIELD_STATS_HTML=$(cat $HTMLFILE_ANNEX_GENES_PANEL_ANNOTATIONS.tmp | tr "," " " | $STARK_FOLDER_BIN/csv_to_html.awk -v limit=$TABLE_LIMIT_CUT -v tag_row_head_plus="class='table-heads'" -v tag_col_head_plus=" class=\"head-item mbr-fonts-style display-7\"" -v tag_row_body_plus="" -v tag_col_body_plus=" class=\"body-item mbr-fonts-style display-7\"")
			fi


			# BREAK
			(( $(echo "$GENES_PANEL_NUM >= 2" |bc -l) )) && GENES_PANEL_BREAK=$PAGE_BREAK_BEFORE || GENES_PANEL_BREAK=""

			# PLAN
			echo '<a class="btn display-4 mbr-section-subtitle mbr-fonts-style display-6 align-center" href="#VARIANTS_'$GENES_PANEL'"><small>'$GENE_PANEL_NAME_HTML'</small></a>' >> $HTMLFILE_ANNEX_PLAN_LINKS_VARIANTS
			echo '<a class="btn display-4 mbr-section-subtitle mbr-fonts-style display-6 align-center" href="#ANNOTATIONS_'$GENES_PANEL'"><small>'$GENE_PANEL_NAME_HTML'</small></a>' >> $HTMLFILE_ANNEX_PLAN_LINKS_ANNOTATIONS


			echo '

			<section class="section-table cid-ruiBoanIwc" id="VARIANTS_'$GENES_PANEL'" >


			  <div class="container container-table">

				  <h3 class="mbr-section-subtitle mbr-fonts-style align-center mbr-light display-5" '$GENES_PANEL_BREAK'>
				  <br>
				  	'$GENE_PANEL_NAME_HTML'
				  </h3>

				  <p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
	  				'$HTMLFILE_ANNEX_GENES_PANEL_VARIANTS_TSV_DOWNLOAD_FILE_HTML'
					<br>
					'$GENES_PANEL_VCF_DOWNLOAD_FILE_HTML' '$GENES_PANEL_TSV_DOWNLOAD_FILE_HTML'
					<br>
					'$GENES_PANEL_BCFTOOLS_STATS_DOWNLOAD_FILE_HTML'
					<br>
					'$GENES_PANEL_SNPEFF_STATS_DOWNLOAD_FILE_HTML'
	  			  </p>

				  <div class="table-wrapper">
					<div class="container">
					  <div class="row search">
						<div class="col-md-6"></div>
						<div class="col-md-6">
							<div class="dataTables_filter">
							  <label class="searchInfo mbr-fonts-style display-7">Search:</label>
							  <input class="form-control input-sm" disabled="">
							</div>
						</div>
					  </div>
					</div>

					<div class="container scroll">
					  	<table class="table isSearch" cellspacing="0">
							'$GENES_PANEL_VARIANTS_HTML'
					  	</table>
					</div>

					<div class="container table-info-container">
					  <div class="row info">
						<div class="col-md-6">
						  <div class="dataTables_info mbr-fonts-style display-7">
							<span class="infoBefore">Showing</span>
							<span class="inactive infoRows"></span>
							<span class="infoAfter">entries</span>
							<span class="infoFilteredBefore">(filtered from</span>
							<span class="inactive infoRows"></span>
							<span class="infoFilteredAfter"> total entries)</span>
						  </div>
						</div>
						<div class="col-md-6"></div>
					  </div>
					</div>


				  </div>
				</div>

			</section>

			' >> $HTMLFILE_ANNEX_GENES_PANEL_VARIANTS


			echo '

			<section class="section-table cid-ruiBoanIwc" id="ANNOTATIONS_'$GENES_PANEL'" >


			  <div class="container container-table">

				  <h3 class="mbr-section-subtitle mbr-fonts-style align-center mbr-light display-5" '$GENES_PANEL_BREAK'>
				  <br>
					'$GENE_PANEL_NAME_HTML'
				  </h3>

				  <p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
				    '$GENES_PANEL_INFO_FIELD_STATS_DOWNLOAD_FILE_HTML'
				  </p>

				  <div class="table-wrapper">
					<div class="container">
					  <div class="row search">
						<div class="col-md-6"></div>
						<div class="col-md-6">
							<div class="dataTables_filter">
							  <label class="searchInfo mbr-fonts-style display-7">Search:</label>
							  <input class="form-control input-sm" disabled="">
							</div>
						</div>
					  </div>
					</div>

					<div class="container scroll">
						<table class="table isSearch" cellspacing="0">
							'$GENES_PANEL_INFO_FIELD_STATS_HTML'
						</table>
					</div>

					<div class="container table-info-container">
					  <div class="row info">
						<div class="col-md-6">
						  <div class="dataTables_info mbr-fonts-style display-7">
							<span class="infoBefore">Showing</span>
							<span class="inactive infoRows"></span>
							<span class="infoAfter">entries</span>
							<span class="infoFilteredBefore">(filtered from</span>
							<span class="inactive infoRows"></span>
							<span class="infoFilteredAfter"> total entries)</span>
						  </div>
						</div>
						<div class="col-md-6"></div>
					  </div>
					</div>


				  </div>
				</div>

			</section>

			' >> $HTMLFILE_ANNEX_GENES_PANEL_ANNOTATIONS



		fi;

	done;


#done;



SECTION_NAME="Variants Report"
SECTION_ID="annex_variants"

if in_array $SECTION_ID $SECTIONS || in_array ALL $SECTIONS ; then
		(($DEBUG)) && echo "show section $SECTION_ID"

	# PLAN
	echo '<a class="btn btn-primary-outline display-4" href="#'$SECTION_ID'">'$SECTION_NAME'</a>' >> $HTMLFILE_ANNEX_PLAN_LINKS

	echo '

		<section class="cid-ruiBoanIwc" id="'$SECTION_ID'" '$PAGE_BREAK_BEFORE'>
		<br>

			<div class="container">
				<h2 class="mbr-section-title pb-3 align-center mbr-fonts-style display-2">
					'$SECTION_NAME'
				</h2>

				<p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
					Variant calling from '$PIPELINES_NUMBER' pipelines
					<br>
					'$(echo $ALIGNERS_CALLERS_ANNOTATORS | sed "s/ /<br>/gi")'
					'$([ "$POST_CALLING_STEPS" != "" ] && echo "<br>with post calling steps <strong>"$POST_CALLING_STEPS"</strong>")'
					'$([ "$POST_ANNOTATION_STEPS" != "" ] && echo "<br>with post annotation steps <strong>"$POST_ANNOTATION_STEPS"</strong>")'
					'$([ "$HOWARD_PRIORITIZATION_LIST" != "" ] && echo "<br>with post prioritization steps <strong>"$HOWARD_PRIORITIZATION_LIST"</strong>")'
					<br>

				</p>

				<section class="mbr-section content8 cid-ruitEAjBmu" id="content8-1z">
					<div class="container">
						<div class="media-container-row title">
							<div class="col-12 col-md-40">
								<div class="mbr-section-btn align-center">
								'$(cat $HTMLFILE_ANNEX_PLAN_LINKS_VARIANTS)'
							</div>
						</div>
					</div>
				</section>

				'"$(cat $HTMLFILE_ANNEX_GENES_PANEL_VARIANTS)"'



		</div>
		</section>

	' > $HTMLFILE_ANNEX_VARIANTS

fi;



SECTION_NAME="Annotations Report"
SECTION_ID="annex_annotations"

if in_array $SECTION_ID $SECTIONS || in_array ALL $SECTIONS ; then
	(($DEBUG)) && echo "show section $SECTION_ID"

	# PLAN
	echo '<a class="btn btn-primary-outline display-4" href="#'$SECTION_ID'">'$SECTION_NAME'</a>' >> $HTMLFILE_ANNEX_PLAN_LINKS

	echo '

		<section class="cid-ruiBoanIwc" id="'$SECTION_ID'" '$PAGE_BREAK_BEFORE'>
		<br>

			<div class="container">
				<h2 class="mbr-section-title pb-3 align-center mbr-fonts-style display-2">
					'$SECTION_NAME'
				</h2>

				<p class="mbr-section-subtitle mbr-fonts-style display-6 align-center">
					Annotations from '$PIPELINES_NUMBER' pipelines
					<br>
					'$(echo $ALIGNERS_CALLERS_ANNOTATORS | sed "s/ /<br>/gi")'
					'$([ "$POST_CALLING_STEPS" != "" ] && echo "<br>with post calling steps <strong>"$POST_CALLING_STEPS"</strong>")'
					'$([ "$POST_ANNOTATION_STEPS" != "" ] && echo "<br>with post annotation steps <strong>"$POST_ANNOTATION_STEPS"</strong>")'
					'$([ "$HOWARD_PRIORITIZATION_LIST" != "" ] && echo "<br>with post prioritization steps <strong>"$HOWARD_PRIORITIZATION_LIST"</strong>")'
					<br>

				</p>

				<section class="mbr-section content8 cid-ruitEAjBmu" id="content8-1z">
					<div class="container">
						<div class="media-container-row title">
							<div class="col-12 col-md-40">
								<div class="mbr-section-btn align-center">
								'$(cat $HTMLFILE_ANNEX_PLAN_LINKS_ANNOTATIONS)'
							</div>
						</div>
					</div>
				</section>

				'"$(cat $HTMLFILE_ANNEX_GENES_PANEL_ANNOTATIONS)"'



		</div>
		</section>

	' > $HTMLFILE_ANNEX_ANNOTATIONS

fi;




# PLAN
##########

(($VERBOSE)) && echo "#[INFO] ANNEX PLAN section"


HTMLFILE_ANNEX_PLAN=$HTMLFILE".annex.plan"


echo '
<section class="mbr-section content8 cid-ruitEAjBmu" id="content8-1z">
    <div class="container">
        <div class="media-container-row title">
            <div class="col-12 col-md-40">
                <div class="mbr-section-btn align-center">
				<a class="btn btn-primary-outline display-4" href="'$(basename $HTMLFILE)'">Report</a>
				'$(cat $HTMLFILE_ANNEX_PLAN_LINKS)'
            </div>
        </div>
    </div>
</section>
' > $HTMLFILE_ANNEX_PLAN







# FOOTER
##########




# BODY
#######

HTMLFILE_BODY=$HTMLFILE".body"

#'"$(cat $HTMLFILE_MENU)"'

echo '

	'"$(cat $HTMLFILE_TITLE 2>/dev/null)"'
	'"$(cat $HTMLFILE_MAIN 2>/dev/null)"'
	'"$(cat $HTMLFILE_PLAN 2>/dev/null)"'
	'"$(cat $HTMLFILE_SUMMARY 2>/dev/null)"'
	'"$(cat $HTMLFILE_SEQUENCING 2>/dev/null)"'
	'"$(cat $HTMLFILE_DEPTH 2>/dev/null)"'
	'"$(cat $HTMLFILE_COVERAGE 2>/dev/null)"'
	'"$(cat $HTMLFILE_VARIANTS_STATS 2>/dev/null)"'
	'"$(cat $HTMLFILE_PLAN.annex 2>/dev/null)"'
	'"$(cat $HTMLFILE_SCRIPTS 2>/dev/null)"'
' > $HTMLFILE_BODY

#'"$(cat $HTMLFILE_AMPLICON_CLIPPING)"'
#'"$(cat $HTMLFILE_CALLING)"'

# ANNEX

HTMLFILE_ANNEX_BODY=$HTMLFILE_ANNEX".body"

#'"$(cat $HTMLFILE_MENU)"'

echo '

	'"$(cat $HTMLFILE_TITLE 2>/dev/null)"'
	'"$(cat $HTMLFILE_MAIN 2>/dev/null)"'
	'"$(cat $HTMLFILE_ANNEX_PLAN 2>/dev/null)"'
	'"$(cat $HTMLFILE_ANNEX_COVERAGE 2>/dev/null)"'
	'"$(cat $HTMLFILE_ANNEX_DEPTH 2>/dev/null)"'
	'"$(cat $HTMLFILE_ANNEX_GENES_COVERAGE 2>/dev/null)"'
	'"$(cat $HTMLFILE_ANNEX_VARIANTS 2>/dev/null)"'
	'"$(cat $HTMLFILE_ANNEX_ANNOTATIONS 2>/dev/null)"'
	'"$(cat $HTMLFILE_PLAN.report 2>/dev/null)"'
	'"$(cat $HTMLFILE_SCRIPTS 2>/dev/null)"'
' > $HTMLFILE_ANNEX_BODY

#'"$(cat $HTMLFILE_ANNEX_AMPLICON)"'

# OUTPUT
##########


# HTML

echo -ne '

<!DOCTYPE html>

<html>

	<head>

		'"$(cat $HTMLFILE_HEADER)"'

	</head>

	<body>

		'"$(cat $HTMLFILE_BODY)"'

	</body>

</html>

' > $HTMLFILE



# HTML ANNEX

echo -ne '

<!DOCTYPE html>

<html>

	<head>

		'"$(cat $HTMLFILE_HEADER)"'

	</head>

	<body>

		'"$(cat $HTMLFILE_ANNEX_BODY)"'

	</body>

</html>

' > $HTMLFILE_ANNEX





#cp $STARK_FOLDER_BIN/test.html $HTMLFILE
#mkdir -p $(dirname $OUTPUT)/assets
#cp -R $HTMLDIR/* $(dirname $OUTPUT)/assets/



#(($DEBUG)) && cat $HTMLFILE
#(($DEBUG)) && cat $HTMLFILE_ANNEX


# MINIFY
##########

# Bad code
if ((0)); then
	cat $HTMLFILE | sed -e "s/^[ \t]*//g" -e ":a;N;$!ba;s/\n//g" > $HTMLFILE.minify
	HTMLFILE=$HTMLFILE.minify
	cat $HTMLFILE_ANNEX | sed -e "s/^[ \t]*//g" -e ":a;N;$!ba;s/\n//g" > $HTMLFILE_ANNEX.minify
	HTMLFILE_ANNEX=$HTMLFILE_ANNEX.minify
fi;


# WRITE FILES
###############

mkdir -p $(dirname $OUTPUT)

if [ "$OUTPUT_TYPE" == "html" ]; then


	cp $HTMLFILE $OUTPUT_HTMLFILE
	cp $HTMLFILE_ANNEX $OUTPUT_ANNEX_HTMLFILE
	mkdir -p $OUTPUT_HTMLDIR
	cp -Rf $HTMLDIR/* $OUTPUT_HTMLDIR/


fi;


# GENERATE PDF
################

# xvfb-run wkhtmltopdf $OUTPUT_HTMLFILE $OUTPUT_HTMLFILE.pdf


# cleaning
rm -rf $REPORTDIR
